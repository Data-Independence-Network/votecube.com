<ActionPopover
		on:cancel="fire('closed')"
>
	<div slot="header">
		{#if signIn}
		Sign In
		{:else}
		Sign Up
		{/if}
	</div>
	<div slot="content">
		{#if error}
		<div
				class="error"
		>
			{error}
		</div>
		{/if}
		{#if signInForm}
		<form>
			{#if signIn}
			<!--			<legend>Create Poll</legend>-->
			<Text
					field="{signInForm.fields.username}"
			></Text>
			<Text
					field="{signInForm.fields.password}"
					type="password"
			></Text>
			<br>
			<a
					on:click="setSignIn(false)"
			>
				Sign Up
			</a>
			{:else}
			<Text
					field="{signUpForm.fields.username}"
			></Text>
			<div class="pure-control-group">
				<Text
						field="{signUpForm.fields.password}"
						type="password"
				></Text>
			</div>
			<div class="pure-control-group">
				<Text
						field="{signUpForm.fields.passwordCheck}"
						type="password"
				></Text>
			</div>
			<br>
			<div class="pure-control-group">
				<a
						on:click="setSignIn(true)"
				>
					Sign In
				</a>
			</div>
			{/if}
		</form>
		{/if}
		<br>
	</div>
	<div slot="actions">
		{#if signIn}
		<EnterButton
				on:select="signIn()"
		></EnterButton>
		{:else}
		<SaveButton
				on:select="signUp()"
		></SaveButton>
		{/if}
	</div>
</ActionPopover>
<style>
	.error {
		padding: 5px;
		text-align: center;
	}
</style>
<script>
	import EnterButton                    from '../common/control/button/EnterButton.html'
	import SaveButton                     from '../common/control/button/SaveButton.html'
	// import * as forms                     from '../form/forms'
	import Text                           from '../common/field/Text.html'
	import ActionPopover                  from '../common/shell/ActionPopover.html'
	import {
		signIn,
		signUp
	}                                     from '../helpers/auth'
	import {loadForms}                    from '../libs/forms'
	import {loadLocations as loadLocText} from '../libs/text/locations'
	import store                          from '../store'

	export default {
		components: {
			ActionPopover,
			EnterButton,
			SaveButton,
			Text
		},
		data: () => ({
			signIn: true
		}),
		methods: {
			signIn() {
				const {signInForm} = this.get()
				if (!signInForm.valid) {
					return
				}
				doSignIn(signInForm.value.username, signInForm.value.password, this).then(
					success => {
						if (success) {
							this.fire('closed')
						}
					})
			},
			setSignIn(signIn) {
				this.set({signIn})
			},
			signUp() {
				const {signUpForm} = this.get()
				if (!signUpForm.valid) {
					return
				}
				doSignUp(signUpForm.value.username, signUpForm.value.password, this).then(
					success => {
						if (success) {
							this.fire('closed')
						}
					})
			}
		},
		oncreate() {
			initPage(this)
		},
		store: () => store
	}

	async function initPage(page) {
		const [
			      {Field, FieldGroup, Validators},
			      _
		      ] = await Promise.all([
			loadForms(page),
			loadLocText(page.store, 'en-us')
		])

		const {text} = page.store.get()

		const signInForm = new FieldGroup('SignIn', {
			username: new Field([
				Validators.required(),
				Validators.minLength(5),
			], {maxLength: 64}),
			password: new Field([
				Validators.required(),
				Validators.minLength(8),
			], {maxLength: 64})
		}, [Validators.required()], text.UI.SignIn, 'SignUp')

		const signUpForm = new FieldGroup('SignUp', {
			username: new Field([
				Validators.required(),
				Validators.minLength(5),
			], {maxLength: 64}),
			password: new Field([
				Validators.required(),
				Validators.minLength(8),
			], {maxLength: 64}),
			passwordCheck: new Field([
				Validators.required(),
				Validators.minLength(8), Validators.custom('passwordMismatch', (
					field
				) => {
					const passwordValue = field.group.fields.password.value
					const value         = field.value
					if (value !== passwordValue) {
						return {
							key: 'passwordMismatch'
						}
					}
				}),
			], {maxLength: 64}),
		}, [Validators.required()], text.UI.SignIn)

		page.set({
			signInForm,
			signUpForm
		})
	}

	async function doSignIn(
		username,
		password,
		page
	) {
		const error = await signIn(username, password)
		if (!error) {
			return true
		}
		switch (error.code) {
			case 'NotFound':
				page.set({error: 'Username not found.'})
				break
			case 'WrongPassword':
				page.set({error: 'Wrong password.'})
				break
			case 'TooManyTries':
				page.set({error: 'Too many login requests, please try later.'})
				break
			default:
				page.set({error: error.message})
				break
		}
		return false
	}


	async function doSignUp(
		username,
		password,
		page
	) {
		const error = await signUp(username, password)
		if (!error) {
			return true
		}
		switch (error.code) {
			case 'InUse':
				page.set({error: 'Username already taken.'})
				break
			default:
				page.set({error: error.message})
				break
		}
		return false
	}

</script>
