<svelte:window on:resize="handleResize(event)"/>
<article
		class="{activeClass} wrapper"
		class:noOverflow="$noOverflow"
		class:cube="$cube"
		id="layout"
>
	<!-- Menu toggle -->
	<TopBar
			mainMenuActive={isMenuActive}
			on:setViewType="setViewType(event)"
	></TopBar>

	{#if showLogo}
	<div>
		VOTECUBE
	</div>
	{/if}

	<nav
			class="menu-link {activeClass}"
			id="menuLink"
			on:click="toggleMenu()"
	>
		<!--Hamburger icon -->
		<span></span>
	</nav>
	<Menu
			active="{$showMainMenu}"
			on:selected="selectMenu(event)"
	></Menu>
	<section
			id="main"
			on:click="clickMain()"
	>
		<svelte:component this="{PageComp}"/>
	</section>
</article>
{#if showTextToast}
<TextToast
		text="{$textToast.text}"
></TextToast>
{/if}
{#if $signIn}
<SignIn
		on:closed="closeSignIn()"
></SignIn>
{/if}

<style>
	@media (min-width: 62em) {
		#main {
			margin: 1em 23%;
			width: 54%;
		}
	}

	div {
		color: white;
		background: #191818;
		height: 44px;
		line-height: 44px;
		position: fixed;
		text-align: center;
		top: 0px;
		vertical-align: middle;
		width: 160px;
		z-index: 1200;
	}

	article {
		overflow-y: auto;
		overflow-x: hidden;
	}

	article.noOverflow {
		overflow: initial;
	}

	nav {
		z-index: 1100;
	}
</style>

<script>
	import {DI}                  from '@airport/di'
	import {AUTH}                from '@votecube/public-logic'
	import TextToast             from './common/shell/TextToast.html'
	import {init}                from './database'
	import {loadUi}              from './libs/text/ui'
	import AboutUs               from './pages/AboutUs.html'
	import FactorInfoMain        from './pages/factor/info/Main.html'
	import FactorList            from './pages/factor/search/FactorList.html'
	import Feedback              from './pages/feedback/FeedbackForm.html'
	import PollInfoCommonTopMenu from './pages/poll/info/Common.top.menu.html'
	import PollInfoForm          from './pages/poll/info/PollForm.html'
	import PollInfoMain          from './pages/poll/info/PollMain.html'
	import PollLocations         from './pages/poll/Locations.html'
	import PollList              from './pages/poll/search/PollList.html'
	import PollListTopMenu       from './pages/poll/search/PollList.top.menu.html'
	import PollTimeframe         from './pages/poll/Timeframe.html'
	import VariationList         from './pages/poll/variation/VariationList.html'
	import ReleasePlan           from './pages/ReleasePlan.html'
	import {
		scheduleToResize,
		startResizeInterval
	}                            from './resizer.js'
	import * as routes           from './routes'
	import {POLL_LIST}           from './routes'
	import {
		navigateToPage,
		setupRoutes
	}                            from './routes.js'
	import Menu                  from './shell/menu/Menu.html'
	import SignIn                from './shell/SignIn.html'
	import TopBar                from './shell/top/TopBar.html'
	import store                 from './store.js'

	const pageMap = {
		[routes.ABOUT]: AboutUs,
		[routes.FEEDBACK]: Feedback,
		[routes.CARD_CLIMATE_CHANGE]: PollInfoMain,
		[routes.FACTOR_INFO_MAIN]: FactorInfoMain,
		[routes.FACTOR_LIST]: FactorList,
		[routes.POLL_LIST]: PollList,
		[routes.VARIATION_LIST]: VariationList,
		[routes.POLL_FORM]: PollInfoForm,
		[routes.POLL_MAIN]: PollInfoMain,
		[routes.POLL_LOCATIONS]: PollLocations,
		[routes.POLL_TIMEFRAME]: PollTimeframe,
		[routes.RELEASE_PLAN]: ReleasePlan,
	}

	const topMenuMap = {
		[routes.POLL_MAIN]: PollInfoCommonTopMenu,
		[routes.POLL_LIST]: PollListTopMenu
	}

	export default {
		components: {
			Menu,
			SignIn,
			TextToast,
			TopBar
		},
		computed: {
			activeClass: ({$showMainMenu}) => $showMainMenu ? 'active' : '',
			showLogo: ({$isDesktop, $showMainMenu}) => $isDesktop || $showMainMenu
		},
		data() {
			return {
				PageComp: null,
				showTextToast: false
			}
		},
		methods: {
			clickMain() {
				// if (DOM_API.e(menuElementIdSelector)
				//   .className
				//   .indexOf('active') !== -1) {
				if (this.store.get().showMainMenu) {
					this.toggleMenu()
				}
			},
			closeSignIn() {
				this.store.set({signIn: false})
			},
			handleResize(
				event
			) {
				scheduleToResize(this.store)
			},
			selectMenu(
				menuItem
			) {
				navigateToPage(menuItem.key, menuItem.params)
				this.store.toggleMainMenu()
			},
			toggleMenu() {
				if (this.store.get().confirm) {
					return
				}
				this.store.toggleMainMenu()
			},
			setPageComp(
				PageComp
			) {
				this.set({PageComp})
			},
			setViewType(
				view
			) {
				navigateToPage(view.type, view.params)
			}
		},
		oncreate() {
			initApp(this).then()
		},
		store: () => store
	}

	async function initApp(
		page
	) {
		setupRoutes(page, pageMap, topMenuMap)

		startResizeInterval(page.store)

		page.store.on('setTextToast', ({textToast}) => {
			page.set({lastTextToast: textToast, showTextToast: true})
			setTimeout(() => {
				let now             = new Date().getTime()
				let {lastTextToast} = page.get()
				if (now - lastTextToast.seconds * 1000 >= lastTextToast.time) {
					page.set({showTextToast: false})
				}
			}, textToast.seconds * 1000)
		})

		const [auth, _, _2] = await Promise.all([
			DI.get(AUTH),
			loadUi(page.store, 'en-us'),
			init()
		])
		const user          = auth.getUser()
		page.store.set({user})

		const userChanges$ = await auth.reactToUser()

		userChanges$.subscribe(
			user => {
				const {currentPage} = store.get()
				if (currentPage.authenticated) {
					navigateToPage(POLL_LIST)
				}
				page.store.set({user, authChecked: true})
			})
	}
</script>
