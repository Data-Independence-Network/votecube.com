<svelte:window on:resize="handleResize(event)"/>
<article
    class="{activeClass}"
    class:noOverflow="$noOverflow"
    id="layout"
>
    <!-- Menu toggle -->
    <TopBar
        mainMenuActive={isMenuActive}
        on:setViewType="setViewType(event)"
    ></TopBar>
    <nav
            class="menu-link {activeClass}"
            id="menuLink"
            on:click="toggleMenu()"
    >
        <!--Hamburger icon -->
        <span></span>
    </nav>
    <Menu
        active="{$showMainMenu}"
        on:selected="selectMenu(event)"
    ></Menu>
    <section
            id="main"
            on:click="clickMain()"
    >
        <svelte:component this="{PageComp}"/>
    </section>
</article>
{#if showTextToast}
<aside>
    <div>
        {$textToast.text}
    </div>
</aside>
{/if}

<style>

    article {
        overflow: auto;
    }

    article.noOverflow {
        overflow: initial;
    }

    aside {
        bottom: 5px;
        padding: 5px;
        position: fixed;
        width: 100%;
    }

    div {
        background-color: #111;
        border-radius: 3px;
        color: #eee;
        padding: 10px;
        width: 100%;
    }

    #main {
        height: 100%;
    }

</style>

<script>

import {scheduleToResize, startResizeInterval} from './resizer.js'
import Menu from './shell/menu/Menu.html'
import TopBar from './shell/top/TopBar.html'
import store from './store.js';
import {navigateToPage, setupRoutes} from './routes.js'
import * as routes from './routes'
import {loadUi} from './libs/text/ui'

import DirectionInfo from './pages/direction/Info.html'
import DimensionInfo from './pages/dimension/Info.html'
import DimensionList from './pages/dimension/List.html'
import PickDimensionColor from './pages/dimension/PickColor.html'
import LocationSelector from './pages/poll/Locations.html'
import TimeframeSelector from './pages/poll/Timeframe.html'
import MainInfoSelector from './pages/poll/MainInfo.html'
import CubeVote from './pages/poll/vote/Cube.html'
import CubeTopMenu from './pages/poll/vote/Common.top.menu.html'
import PollList from './pages/poll/list/List.html'
import PollListTopMenu from './pages/poll/list/List.top.menu.html'
import VerticalBarVote from './pages/poll/vote/Chart.html'

const pageMap = {
    [routes.DIRECTION_INFO]: DirectionInfo,
    [routes.DIMENSION_INFO]: DimensionInfo,
    [routes.DIMENSION_LIST]: DimensionList,
    [routes.DIMENSION_PICK_COLOR]: PickDimensionColor,
    [routes.POLL_VOTE_CHART]: VerticalBarVote,
    [routes.POLL_LIST]: PollList,
    [routes.POLL_MAIN_INFO]: MainInfoSelector,
    [routes.POLL_VOTE_CUBE]: CubeVote,
    [routes.POLL_LOCATIONS]: LocationSelector,
    [routes.POLL_TIMEFRAME]: TimeframeSelector,
};

const topMenuMap = {
    [routes.POLL_VOTE_CHART]: CubeTopMenu,
    [routes.POLL_VOTE_CUBE]: CubeTopMenu,
    [routes.POLL_LIST]: PollListTopMenu
}

export default {
    components: {
        Menu,
        TopBar
    },
    computed: {
        activeClass: ({$showMainMenu}) => $showMainMenu ? 'active' : '',
    },
    data() {
        return {
            PageComp: null,
            showTextToast: false
        }
    },
    methods: {
        clickMain() {
            // if (DOM_API.e(menuElementIdSelector)
            //   .className
            //   .indexOf('active') !== -1) {
            if (this.store.get().showMainMenu) {
                this.toggleMenu()
            }
        },
        handleResize(
            event
        ) {
            scheduleToResize(this.store)
        },
        selectMenu(
            menuItem
        ) {
            switch(menuItem.key) {
                case routes.POLL_LIST:
                case routes.POLL_MAIN_INFO:
                case routes.POLL_VOTE_CUBE: {
                    navigateToPage(menuItem.key)
                    break
                }
            }
            this.store.toggleMainMenu()
        },
        toggleMenu() {
            this.store.toggleMainMenu()
        },
        toggleSurface(
            dimension
        ) {
            this.get().mutationApi.toggleSurface(dimension)
        },
        setPageComp(
            PageComp
        ) {
            this.set({PageComp})
        },
        setViewType(
            view
        ) {
            navigateToPage(view.type, view.params)
        }
    },
    oncreate() {
        loadUi(this.store, 'en-us')

        setupRoutes(this, pageMap, topMenuMap)

        startResizeInterval(this.store)

        this.store.on('setTextToast', ({textToast}) => {
            this.set({lastTextToast: textToast, showTextToast: true})
            setTimeout(() => {
                let now = new Date().getTime()
                let {lastTextToast} = this.get()
                if(now - lastTextToast.seconds * 1000 >= lastTextToast.time) {
                    this.set({showTextToast: false})
                }
            }, textToast.seconds * 1000)
        })
    },
    store: () => store
}

</script>