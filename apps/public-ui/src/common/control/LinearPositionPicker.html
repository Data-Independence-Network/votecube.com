<tr>
    <td
        on:touchstart="mouseDown(-1)"
        on:touchend="mouseUp(-1)"
    >
        <LeftButton
            circleRadius="{leftCircleRadius}"
            fillColor="{leftFillColor}"
            highlightColor="{leftHighlightColor}"
            strokeWidth="{leftStrokeWidth}"
        ></LeftButton>
   </td>
   <td>
      <input
          maxlength="3"
          on:input="fire('moveToValue', this.value)"
          ref:input
          style="
            border-bottom: {valueBottomBorder};
          "
          value="{value.value}"
      >
   </td>
   <td
          on:touchstart="mouseDown(1)"
          on:touchend="mouseUp(1)"
   >
        <RightButton
            circleRadius="{rightCircleRadius}"
            fillColor="{rightFillColor}"
            highlightColor="{rightHighlightColor}"
            strokeWidth="{rightStrokeWidth}"
        ></RightButton>
   </td>
</tr>

<style>

    input {
        background: transparent;
        border: 0px;
        width: 100%;
        text-align: center;
    }

    td {
        font-size: 0.8em;
        height: 70px;
        width: 33%;
    }

</style>

<script>
import {getDimensionColor} from '../../helpers/dimension';
import LeftButton from './button/LeftButton.html'
import RightButton from './button/RightButton.html'

export default {
    components: {
        LeftButton,
        RightButton
    },
    computed: {
        valueBottomBorder: ({value}) => getInputBorder(value),
        leftCircleRadius: ({value}) => getRadius(-1, value),
        rightCircleRadius: ({value}) => getRadius(1, value),
        leftStrokeWidth: ({value}) => getStrokeWidth(-1, value),
        rightStrokeWidth: ({value}) => getStrokeWidth(1, value),
        leftHighlightColor: ({dimension, value}) => getColor(1, value, dimension),
        rightHighlightColor: ({dimension, value}) => getColor(-1, value, dimension),
        leftFillColor: ({dimension, value}) => getColor(-1, value, dimension),
        rightFillColor: ({dimension, value}) => getColor(1, value, dimension),
    },
    methods: {
        mouseDown(
               direction
        ) {
            const percentChange = 1
            this.set({lastNumIncs: 5, percentChange})

            this.fire('move', {
                direction,
                percentChange
            })

            setIntrvl(this, 360, direction, 4, 3, 1)
            this.fire('update')
        },
        mouseUp(
            direction
        ) {
            clearIntrvl(this)
        },
    },
    oncreate() {
        this.on('refresh', () => {
            updateValue(this)
        })
    }
}

function checkInterval(
    page
) {
    let numIncs = page.get().numIncs - 1
    let percentChange = page.get().percentChange
    let direction = page.get().direction
    page.fire('move', {
        direction,
        percentChange
    });
    if (!numIncs) {
        clearIntrvl(page)
        let numReIncs = page.get().numReIncs - 1
        if(!numReIncs) {
            return
        }
        let interval = page.get().interval / 2
        let numIncs = page.get().lastNumIncs * 2
        percentChange = percentChange * 3
        page.set({lastNumIncs: numIncs})
        setIntrvl(page, interval, direction, numIncs, numReIncs, percentChange)
    } else {
        page.set({numIncs})
    }
}
function setIntrvl(
    page,
    interval,
    direction,
    numIncs,
    numReIncs,
    percentChange,
) {
    // console.log(`interval: ${interval}, direction: ${direction}, numIncs: ${numIncs}, numReIncs: ${numReIncs}, percentChange: ${percentChange}`)
    const incrementInterval = setInterval(() => {
        checkInterval(page)
        page.fire('update')
    }, interval)
    page.set({direction, incrementInterval, interval, numIncs, numReIncs, percentChange})
}
function clearIntrvl(
    page
) {
    let incrementInterval = page.get().incrementInterval
    if(incrementInterval) {
        clearInterval(incrementInterval);
    }
}
function getInputBorder(
    value
) {
    return value.valid
    ? '0px'
    : '3px solid red'
}

function getRadius(
    dir,
    value
) {
    return dir === value.dir
    ? 24
    : 23
}
function getStrokeWidth(
    dir,
    value
) {
    return dir === value.dir
    ? 0
    : 3
}
function getColor(
    dir,
    value,
    dimension
) {
    return dir === value.dir
    ? getDimensionColor(dimension)
    : 'FFFFFF'
}
function updateValue(
    page
) {
    setTimeout(() => {
        page.refs.input.value = page.get().value.value
    }, 16)
}
</script>
