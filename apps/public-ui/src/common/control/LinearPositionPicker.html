{#await load}
{:then result}
<tr>
	<td>
		<div
				on:mousedown="mouseDown('A', event)"
				on:mouseup="mouseUp(event)"
				on:touchstart="touchStart('A', event)"
				on:touchend="mouseUp(event)"
		>
			<LeftButton
					circleRadius="{leftCircleRadius}"
					fillColor="{leftFillColor}"
					highlightColor="{leftHighlightColor}"
					strokeWidth="{leftStrokeWidth}"
					styles="left: 0px; position: absolute; top: 0px;"
			></LeftButton>
		</div>
	</td>
	<td>
		<figure
				class:factor="voteFactor.value"
				style="background-color: {factorColor};"
		>

			<input
					maxlength="3"
					on:input="moveToValue(this.value)"
					ref:input
					value="{voteFactor.value}"
			>
			<span>%</span>
		</figure>
		<!--
						style="
				border-bottom: {valueBottomBorder};
			"
			-->
	</td>
	<td
	>
		<div
				on:mousedown="mouseDown('B', event)"
				on:mouseup="mouseUp(event)"
				on:touchstart="touchStart('B', event)"
				on:touchend="mouseUp(event)"
		>
			<RightButton
					circleRadius="{rightCircleRadius}"
					fillColor="{rightFillColor}"
					highlightColor="{rightHighlightColor}"
					strokeWidth="{rightStrokeWidth}"
					styles="left: 0px; position: absolute; top: 0px;"
			></RightButton>
		</div>
	</td>
</tr>
{/await}

<style>

	div {
		display: inline-block;
		height: 50px;
		position: relative;
		width: 50px;
	}

	figure {
		border-top: 10px solid transparent;
		display: inline-block;
		height: 60px;
		margin: auto;
		position: relative;
		width: 110px;
	}

	input {
		background: transparent;
		border: 0px;
		font-family: "Lucida Console";
		left: 0px;
		margin: 0px;
		padding: 0px 15px 0px 0px;
		position: absolute;
		text-align: right;
		top: 0px;
		width: 85px;
	}

	span {
		font-family: "Lucida Console";
		font-size: 0.7em;
		position: absolute;
		right: 17px;
		top: 9px;
	}

	td {
		font-size: 0.8em;
		width: 33%;
	}

	.factor {
		border: 1px solid black;
		border-radius: 4px;
		border-top: 10px solid;
	}

</style>

<script>

	import {DI}          from '@airport/di'
	import {LOGIC_UTILS} from '@votecube/public-logic'
	import LeftButton  from './button/LeftButton.html'
	import RightButton from './button/RightButton.html'

	export default {
		components: {
			LeftButton,
			RightButton
		},
		computed: {
			// valueBottomBorder: ({moveToValueDelta, value}) => getInputBorder(value),
			leftCircleRadius: ({moveDelta, voteFactor}) => getRadius('A', voteFactor),
			rightCircleRadius: ({moveDelta, voteFactor}) => getRadius('B', voteFactor),
			leftStrokeWidth: ({moveDelta, voteFactor}) => getStrokeWidth('A', voteFactor),
			rightStrokeWidth: ({moveDelta, voteFactor}) => getStrokeWidth('B', voteFactor),
			leftHighlightColor: ({moveDelta, voteFactor}) => getButtonColor(['B', null], voteFactor),
			rightHighlightColor: ({moveDelta, voteFactor}) => getButtonColor(['A', null], voteFactor),
			leftFillColor: ({moveDelta, voteFactor}) => getButtonColor(['A'], voteFactor),
			rightFillColor: ({moveDelta, voteFactor}) => getButtonColor(['B'], voteFactor),
			factorColor: ({logicUtils, moveDelta, poll, voteFactor}) => voteFactor.outcome
				? '#' + logicUtils.getColor(poll.factors[voteFactor.factorNumber].color)
				: 'initial'
		},
		data() {
			return {
				load: initPage(this)
			}
		},
		methods: {
			mouseDown(
				outcome,
				event
			) {
				onPress(outcome, event, this)
			},
			mouseUp(
				event
			) {
				event.preventDefault()

				clearIntrvl(this)
			},
			moveToValue(
				value
			) {
				this.fire('moveToValue', value)
				// this.set({moveToValueDelta: this.get().moveToValueDelta + 1})
			},
			touchStart(
				outcome,
				event
			) {
				event.preventDefault()
				onPress(outcome, event, this)
			}
		},
		oncreate() {
			this.refreshListener = this.on('refresh', () => {
				updateValue(this)
			})
		},
		ondestroy() {
			this.refreshListener.cancel()
		}
	}

	async function initPage(
		page
	) {
		const logicUtils = await DI.get(LOGIC_UTILS)

		page.set({logicUtils})
	}

	function checkInterval(
		page
	) {
		let numIncs       = page.get().numIncs - 1
		let percentChange = page.get().percentChange
		let outcome      = page.get().outcome
		if (page.get().lastVoteFactor !== page.get().voteFactor) {
			clearIntrvl(page)
			page.set({numIncs: 0})
			return
		}
		page.fire('move', {
			outcome,
			percentChange
		})
		if (!numIncs) {
			clearIntrvl(page)
			let numReIncs = page.get().numReIncs - 1
			if (!numReIncs) {
				return
			}
			let interval  = page.get().interval / 2
			let numIncs   = page.get().lastNumIncs * 2
			percentChange = percentChange * 2
			page.set({lastNumIncs: numIncs})
			setIntrvl(page, interval, outcome, numIncs, numReIncs, percentChange)
		} else {
			page.set({numIncs})
		}
	}

	function setIntrvl(
		page,
		interval,
		outcome,
		numIncs,
		numReIncs,
		percentChange,
	) {
		// console.log(`interval: ${interval}, outcome: ${outcome}, numIncs: ${numIncs}, numReIncs: ${numReIncs}, percentChange: ${percentChange}`)
		const incrementInterval = setInterval(() => {
			checkInterval(page)
			page.fire('update')
		}, interval)
		page.set({outcome, incrementInterval, interval, numIncs, numReIncs, percentChange})
	}

	function clearIntrvl(
		page
	) {
		let incrementInterval = page.get().incrementInterval
		if (incrementInterval) {
			clearInterval(incrementInterval)
		}
	}

	/*    function getInputBorder(
					value
			) {
					return value.valid === undefined
					|| value.valid
							? '0px'
							: '3px solid red'
			}*/

	function getRadius(
		outcome,
		voteFactor
	) {
		return outcome === voteFactor.outcome
			? 24
			: 23
	}

	function getStrokeWidth(
		outcome,
		voteFactor
	) {
		return outcome === voteFactor.outcome
			? 0
			: 3
	}

	function getButtonColor(
		matchingOutcomes,
		voteFactor,
		poll
	) {
		return matchingOutcomes.indexOf(voteFactor.outcome) > -1
			? '000'
			: 'fff'
	}

	function onPress(
		outcome,
		event,
		page
	) {
		// event.preventDefault()

		const percentChange = 1
		page.set({lastNumIncs: 5, lastVoteFactor: page.get().voteFactor, percentChange})

		page.fire('move', {
			outcome,
			percentChange
		})

		setIntrvl(page, 360, outcome, 8, 4, 1)
		page.fire('update')
	}

	function updateValue(
		page
	) {
		setTimeout(() => {
			page.refs.input.value = page.get().value.value
		}, 16)
	}
</script>
