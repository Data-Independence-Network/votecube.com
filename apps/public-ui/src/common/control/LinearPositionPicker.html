<tr>
	<td>
		<div
						on:mousedown="mouseDown(-1, event)"
						on:mouseup="mouseUp(-1, event)"
						on:touchstart="mouseDown(-1, event)"
						on:touchend="mouseUp(-1, event)"
		>
			<LeftButton
							circleRadius="{leftCircleRadius}"
							fillColor="{leftFillColor}"
							highlightColor="{leftHighlightColor}"
							strokeWidth="{leftStrokeWidth}"
			></LeftButton>
		</div>
	</td>
	<td>
		<input
						maxlength="3"
						on:input="moveToValue(this.value)"
						ref:input
						value="{value.value}"
		>
		<!--
						style="
				border-bottom: {valueBottomBorder};
			"
			-->
	</td>
	<td
	>
		<div
						on:mousedown="mouseDown(1, event)"
						on:mouseup="mouseUp(1, event)"
						on:touchstart="mouseDown(1, event)"
						on:touchend="mouseUp(1, event)"
		>
			<RightButton
							circleRadius="{rightCircleRadius}"
							fillColor="{rightFillColor}"
							highlightColor="{rightHighlightColor}"
							strokeWidth="{rightStrokeWidth}"
			></RightButton>
		</div>
	</td>
</tr>

<style>

	div {
		display: inline-block;
	}

	input {
		background: transparent;
		border: 0px;
		width: 100%;
		text-align: center;
	}

	td {
		font-size: 0.8em;
		height: 70px;
		width: 33%;
	}

</style>

<script>
	import {getColor}  from '../../helpers/cube';
	import LeftButton  from './button/LeftButton.html'
	import RightButton from './button/RightButton.html'

	export default {
		components: {
			LeftButton,
			RightButton
		},
		computed: {
			// valueBottomBorder: ({moveToValueDelta, value}) => getInputBorder(value),
			leftCircleRadius: ({moveDelta, value}) => getRadius(-1, value),
			rightCircleRadius: ({moveDelta, value}) => getRadius(1, value),
			leftStrokeWidth: ({moveDelta, value}) => getStrokeWidth(-1, value),
			rightStrokeWidth: ({moveDelta, value}) => getStrokeWidth(1, value),
			leftHighlightColor: ({axis, moveDelta, poll, value}) => getTheColor([1, 0], value, poll, axis),
			rightHighlightColor: ({axis, moveDelta, poll, value}) => getTheColor([-1, 0], value, poll, axis),
			leftFillColor: ({axis, moveDelta, poll, value}) => getTheColor([-1], value, poll, axis),
			rightFillColor: ({axis, moveDelta, poll, value}) => getTheColor([1], value, poll, axis),
		},
		methods: {
			mouseDown(
				position,
				event
			) {
				event.preventDefault()

				const percentChange = 1
				this.set({lastNumIncs: 5, percentChange})

				this.fire('move', {
					position,
					percentChange
				})

				setIntrvl(this, 360, position, 4, 3, 1)
				this.fire('update')
			},
			mouseUp(
				position,
				event
			) {
				event.preventDefault()

				clearIntrvl(this)
			},
			moveToValue(
				value
			) {
				this.fire('moveToValue', value)
				// this.set({moveToValueDelta: this.get().moveToValueDelta + 1})
			}
		},
		oncreate() {
			this.refreshListener = this.on('refresh', () => {
				updateValue(this)
			})
		},
		ondestroy() {
			this.refreshListener.cancel()
		}
	}

	function checkInterval(
		page
	) {
		let numIncs       = page.get().numIncs - 1
		let percentChange = page.get().percentChange
		let position     = page.get().position
		page.fire('move', {
			position,
			percentChange
		});
		if (!numIncs) {
			clearIntrvl(page)
			let numReIncs = page.get().numReIncs - 1
			if (!numReIncs) {
				return
			}
			let interval  = page.get().interval / 2
			let numIncs   = page.get().lastNumIncs * 2
			percentChange = percentChange * 3
			page.set({lastNumIncs: numIncs})
			setIntrvl(page, interval, position, numIncs, numReIncs, percentChange)
		} else {
			page.set({numIncs})
		}
	}

	function setIntrvl(
		page,
		interval,
		position,
		numIncs,
		numReIncs,
		percentChange,
	) {
		// console.log(`interval: ${interval}, position: ${position}, numIncs: ${numIncs}, numReIncs: ${numReIncs}, percentChange: ${percentChange}`)
		const incrementInterval = setInterval(() => {
			checkInterval(page)
			page.fire('update')
		}, interval)
		page.set({position, incrementInterval, interval, numIncs, numReIncs, percentChange})
	}

	function clearIntrvl(
		page
	) {
		let incrementInterval = page.get().incrementInterval
		if (incrementInterval) {
			clearInterval(incrementInterval);
		}
	}

	/*    function getInputBorder(
					value
			) {
					return value.valid === undefined
					|| value.valid
							? '0px'
							: '3px solid red'
			}*/

	function getRadius(
		dir,
		value
	) {
		return dir === value.dir
			? 24
			: 23
	}

	function getStrokeWidth(
		dir,
		value
	) {
		return dir === value.dir
			? 0
			: 3
	}

	function getTheColor(
		matchingDirs,
		value,
		poll,
		axis
	) {
		return matchingDirs.indexOf(value.dir) > -1
			? getColor(0, poll, axis)
			: 'fff'
	}

	function updateValue(
		page
	) {
		setTimeout(() => {
			page.refs.input.value = page.get().value.value
		}, 16)
	}
</script>
