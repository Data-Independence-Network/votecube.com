<tr>
	<td>
		<div
				on:mousedown="mouseDown(1, event)"
				on:mouseup="mouseUp(1, event)"
				on:touchstart="mouseDown(1, event)"
				on:touchend="mouseUp(1, event)"
		>
			<LeftButton
					circleRadius="{leftCircleRadius}"
					fillColor="{leftFillColor}"
					highlightColor="{leftHighlightColor}"
					strokeWidth="{leftStrokeWidth}"
					styles="left: 0px; position: absolute; top: 0px;"
			></LeftButton>
		</div>
	</td>
	<td>
		<figure
				class:factor="voteDim.value"
				style="background-color: {factorColor};"
		>

			<input
					maxlength="3"
					on:input="moveToValue(this.value)"
					ref:input
					value="{voteDim.value}"
			>
			<span>%</span>
		</figure>
		<!--
						style="
				border-bottom: {valueBottomBorder};
			"
			-->
	</td>
	<td
	>
		<div
				on:mousedown="mouseDown(-1, event)"
				on:mouseup="mouseUp(-1, event)"
				on:touchstart="touchStart(-1, event)"
				on:touchend="mouseUp(-1, event)"
		>
			<RightButton
					circleRadius="{rightCircleRadius}"
					fillColor="{rightFillColor}"
					highlightColor="{rightHighlightColor}"
					strokeWidth="{rightStrokeWidth}"
					styles="left: 0px; position: absolute; top: 0px;"
			></RightButton>
		</div>
	</td>
</tr>

<style>

	div {
		display: inline-block;
		height: 50px;
		position: relative;
		width: 50px;
	}

	figure {
		border-top: 10px solid transparent;
		display: inline-block;
		height: 60px;
		margin: auto;
		position: relative;
		width: 110px;
	}

	input {
		background: transparent;
		border: 0px;
		font-family: "Lucida Console";
		left: 0px;
		margin: 0px;
		padding: 0px 15px 0px 0px;
		position: absolute;
		text-align: right;
		top: 0px;
		width: 85px;
	}

	span {
		font-family: "Lucida Console";
		font-size: 0.7em;
		position: absolute;
		right: 17px;
		top: 9px;
	}

	td {
		font-size: 0.8em;
		width: 33%;
	}

	.factor {
		border: 1px solid black;
		border-radius: 4px;
		border-top: 10px solid;
	}

</style>

<script>
	import {getColor}  from '../../helpers/cube'
	import LeftButton  from './button/LeftButton.html'
	import RightButton from './button/RightButton.html'

	export default {
		components: {
			LeftButton,
			RightButton
		},
		computed: {
			// valueBottomBorder: ({moveToValueDelta, value}) => getInputBorder(value),
			leftCircleRadius: ({moveDelta, voteDim}) => getRadius(1, voteDim),
			rightCircleRadius: ({moveDelta, voteDim}) => getRadius(-1, voteDim),
			leftStrokeWidth: ({moveDelta, voteDim}) => getStrokeWidth(1, voteDim),
			rightStrokeWidth: ({moveDelta, voteDim}) => getStrokeWidth(-1, voteDim),
			leftHighlightColor: ({moveDelta, voteDim}) => getButtonColor([-1, 0], voteDim),
			rightHighlightColor: ({moveDelta, voteDim}) => getButtonColor([1, 0], voteDim),
			leftFillColor: ({moveDelta, voteDim}) => getButtonColor([1], voteDim),
			rightFillColor: ({moveDelta, voteDim}) => getButtonColor([-1], voteDim),
			factorColor: ({moveDelta, poll, voteDim}) => voteDim.dir
				? '#' + getColor(moveDelta, poll, voteDim.axis)
				: 'initial'
		},
		helpers: {
			getColor
		},
		methods: {
			mouseDown(
				position,
				event
			) {
				onPress(position, event, this)
			},
			mouseUp(
				position,
				event
			) {
				event.preventDefault()

				clearIntrvl(this)
			},
			moveToValue(
				value
			) {
				this.fire('moveToValue', value)
				// this.set({moveToValueDelta: this.get().moveToValueDelta + 1})
			},
			touchStart(
				position,
				event
			) {
				event.preventDefault()
				onPress(position, event, this)
			}
		},
		oncreate() {
			this.refreshListener = this.on('refresh', () => {
				updateValue(this)
			})
		},
		ondestroy() {
			this.refreshListener.cancel()
		}
	}

	function checkInterval(
		page
	) {
		let numIncs       = page.get().numIncs - 1
		let percentChange = page.get().percentChange
		let position      = page.get().position
		if (page.get().lastVoteDim !== page.get().voteDim) {
			clearIntrvl(page)
			page.set({numIncs: 0})
			return
		}
		page.fire('move', {
			position,
			percentChange
		})
		if (!numIncs) {
			clearIntrvl(page)
			let numReIncs = page.get().numReIncs - 1
			if (!numReIncs) {
				return
			}
			let interval  = page.get().interval / 2
			let numIncs   = page.get().lastNumIncs * 2
			percentChange = percentChange * 2
			page.set({lastNumIncs: numIncs})
			setIntrvl(page, interval, position, numIncs, numReIncs, percentChange)
		} else {
			page.set({numIncs})
		}
	}

	function setIntrvl(
		page,
		interval,
		position,
		numIncs,
		numReIncs,
		percentChange,
	) {
		// console.log(`interval: ${interval}, position: ${position}, numIncs: ${numIncs}, numReIncs: ${numReIncs}, percentChange: ${percentChange}`)
		const incrementInterval = setInterval(() => {
			checkInterval(page)
			page.fire('update')
		}, interval)
		page.set({position, incrementInterval, interval, numIncs, numReIncs, percentChange})
	}

	function clearIntrvl(
		page
	) {
		let incrementInterval = page.get().incrementInterval
		if (incrementInterval) {
			clearInterval(incrementInterval)
		}
	}

	/*    function getInputBorder(
					value
			) {
					return value.valid === undefined
					|| value.valid
							? '0px'
							: '3px solid red'
			}*/

	function getRadius(
		dir,
		voteDim
	) {
		return dir === voteDim.dir
			? 24
			: 23
	}

	function getStrokeWidth(
		dir,
		voteDim
	) {
		return dir === voteDim.dir
			? 0
			: 3
	}

	function getButtonColor(
		matchingDirs,
		voteDim,
		poll
	) {
		return matchingDirs.indexOf(voteDim.dir) > -1
			? '000'
			: 'fff'
	}

	function onPress(
		position,
		event,
		page
	) {
		// event.preventDefault()

		const percentChange = 1
		page.set({lastNumIncs: 5, lastVoteDim: page.get().voteDim, percentChange})

		page.fire('move', {
			position,
			percentChange
		})

		setIntrvl(page, 360, position, 8, 4, 1)
		page.fire('update')
	}

	function updateValue(
		page
	) {
		setTimeout(() => {
			page.refs.input.value = page.get().value.value
		}, 16)
	}
</script>
