<svelte:document
    on:click="onDocumentClick(event)"
></svelte:document>
{#if $forms && $text}
<div
    class="date-picker"
>
    <label
        class="field-label"
        use:for="{id}"
    >
        {label}
    </label>
    <section
        class="field"
        class:invalid="touched && errors.length"
        class:requiredInvalid="field.validatorMap.required && errors.length"
        class:requiredValid="field.validatorMap.required && !errors.length"
    >
        <!-- FIXME: add support for other date formats -->
        <input
            value="{month}"
            class="month"
            maxlength="2"
            on:blur="checkFocus()"
            on:focus="setFocus()"
            on:input="onFragmentInput('month', this)"
            on:keydown="onFragmentKeydown('month', event)"
            placeholder="{$text.UI.Common.Field.Datepicker.dateInput.placeholder.month}"
            type="text"
            use:id="{id}"
        >
        <span
            class="separator"
        >
            {$text.UI.Common.Field.Datepicker.dateInput.separator}
        </span>
        <input
            value="{date}"
            class="date"
            maxlength="2"
            on:blur="checkFocus()"
            on:focus="setFocus()"
            on:input="onFragmentInput('date', this)"
            on:keydown="onFragmentKeydown('date', event)"
            placeholder="{$text.UI.Common.Field.Datepicker.dateInput.placeholder.date}"
            type="text"
            use:id="{id}"
        >
        <span
            class="separator"
        >
            {$text.UI.Common.Field.Datepicker.dateInput.separator}
        </span>
        <input
            value="{year}"
            class="year"
            maxlength="4"
            on:blur="checkFocus()"
            on:focus="setFocus()"
            on:input="onFragmentInput('year', this)"
            on:keydown="onFragmentKeydown('year', event)"
            placeholder="{$text.UI.Common.Field.Datepicker.dateInput.placeholder.year}"
            type="text"
            use:id="{id}"
        >
        <InfoIcon
            on:select="help()"
        ></InfoIcon>
        <ClearIcon
            on:select="clear()"
        ></ClearIcon>
        <CalendarIcon
            on:select="showCalendar(event.element, event.event)"
        ></CalendarIcon>
    </section>
    {#if showCalendar}
    <div
        class="popup"
        on:click="onCalendarClick(event)"
    >
        <table
            class="header"
        >
            <tr>
                <td
                    style="
                        font-weight: bold;
                        width: calc(100% - 60px);
                    "
                >
                    {calendarTitle}
                </td>
                <td
                    class="monthMove"
                    on:click="toPrevMonth()"
                >
                    <ArrowLeftIcon></ArrowLeftIcon>
                </td>
                <td
                    class="monthMove"
                    on:click="toNextMonth()"
                >
                    <ArrowRightIcon></ArrowRightIcon>
                </td>
            </tr>
        </table>
        <table>
            <tr
                class="header-field"
                style="border-bottom: 1px solid #aaa; color: #aaa;"
            >
        {#each $text.UI.Common.Field.Datepicker.weekDayOrder as weekDayIndex}
                <td>
                    {$text.UI.Common.Field.Datepicker.shortWeekDay[weekDayIndex]}
                </td>
        {/each}
            </tr>
            <tr>
                <td
                    colspan="7"
                ></td>
            </tr>
        {#each weeks as week, weekIndex}
            <tr class="week{weekIndex}">
            {#each week as date, dayIndex}
                <td
                    class="calDate day{dayIndex}"
                    class:selectedDate="field.isSelected(date, weekIndex)"
                    class:today="field.isToday(date, weekIndex)"
                    flags="{field.cellFlags(date, weekIndex)}"
                    on:click="selectDate(date, weekIndex, this)"
                >
                    {date}
                </td>
            {/each}
            </tr>
        {/each}
            <tr>
                <td
                    colspan="7"
                ></td>
            </tr>
        </table>
    </div>
    {/if}
    {#if touched}
        {#each errors as error}
    <span class="pure-form-message error">
        {error.message}
    </span>
        {/each}
    {/if}
</div>
{/if}

<style>

    input[type="text"] {
        border: 0;
        box-shadow: none;
        color: #222;
        display: inline-block;
        /*font-weight: 600;*/
        margin: 0;
        padding: 8px 0 6px;
        vertical-align: text-bottom;
    }

    li {
        border-bottom: 1px solid #f8f8f8;
        font-weight: 600;
        list-style: none;
        padding: 10px;
    }

    li:hover {
        background-color: #eee;
    }

    table {
        width: 300px;
    }

    td {
        height: 35px;
        margin: auto;
        text-align: center;
        width: 14.28%;
    }
    td[colspan="7"] {
        height: 3px;
    }

    td[flags~="Mtrue"] {
        font-weight: bold;
    }

    td[flags~="Rfalse"] {
        color: #ddd;
    }

    ul {
        background-color: white;
        border: 1px solid #222;
        box-shadow: 0 3px 3px #ddd inset;
        max-height: 300px;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 100;
    }

    .activeOption {
        background-color: #eee;
    }

    .date {
        width: 18px;
    }

    .date-picker {
        position: relative;
    }

    .field {
        padding-left: 5px;
    }

    .header {
        height: 30px;
        border: 0;
    }

    .header td {
        padding-top: 10px;
    }

    .month {
        width: 18px;
    }


    .popup {
        width: 300px;
        margin: 0 5px 5px 5px;
    }

    .selectedDate {
        background-color: black;
        border-radius: 4px;
        color: white;
    }

    .separator {
        display: inline-block;
        margin-bottom: 6px;
        vertical-align: text-bottom;
    }

    .today {
        border: 1px solid black;
    }

    .year {
        width: 80px;
    }

</style>

<script>
import store from '../../store.js'
import ArrowLeftIcon from '../icon/ArrowLeftIcon.html'
import ArrowRightIcon from '../icon/ArrowRightIcon.html'
import CalendarIcon from '../icon/CalendarIcon.html'
import ClearIcon from '../icon/ClearIcon.html'
import InfoIcon from '../icon/InfoIcon.html'

export default {
    actions: {
        for(node, id) {
            if(id) {
                node.id = id;
            }
        },
        id(node, id) {
            if(id) {
                node.id = id;
            }
        }
    },
    components: {
        ArrowLeftIcon,
        ArrowRightIcon,
        CalendarIcon,
        ClearIcon,
        InfoIcon
    },
    computed: {
        date: ({delta, field}) => field.fragments.date,
        errors: ({delta, field}) => field.errors,
        label: ({delta, field}) => field.label,
        month: ({delta, field}) => field.fragments.month,
        calendarTitle: ({delta, field, $text}) => {
            return `${$text.UI.Common.Field.Datepicker.month[field.calendar.month]} ${field.calendar.year}`
        },
        touched: ({delta, field}) => field.touched,
        weeks: ({delta, field}) => field.calendar.weeks,
        year: ({delta, field}) => field.fragments.year
    },
    data() {
        return {
            focused: false
        }
    },
    immutable: true,
    methods: {
        checkFocus() {
            this.set({focused:false})
            setTimeout(() => {
                const {field, focused} = this.get()
                if(field && !focused) {
                    field.onBlur()
                }
            })
        },
        clear() {
            this.get().field.clear()
        },
        onDocumentClick(event) {
            this.get().field.reset()
            this.set({showCalendar: false})
        },
        onFragmentKeydown(
            fragmentType,
            event
        ) {
            this.get().field.fragments.onKeydown(fragmentType, event)
        },
        onCalendarClick(event) {
            event.stopPropagation()
        },
        selectDate(date, weekIndex, element) {
            if(element.getAttribute('flags').indexOf('Rtrue') < 0) {
                return
            }
            this.get().field.setDateOfMonth(date, weekIndex)
            this.set({showCalendar: false})
        },
        setFocus() {
            this.set({focused:true})
        },
        onFragmentInput(
            fragmentType,
            element
        ) {
            this.get().field.fragments.onInput(fragmentType, element)
        },
        showCalendar(element, event) {
            const {field, showCalendar} = this.get()
            if(!showCalendar) {
                this.set({
                    showCalendar: true,
                    dropdownPxFromTop: element.parentElement.offsetHeight
                })
                field.setCalendarToSelection();
                event.stopPropagation()
            }
        },
        toNextMonth() {
            this.get().field.calendar.toNextMonth()
        },
        toPrevMonth() {
            this.get().field.calendar.toPrevMonth()
        },
        unselect(option, event) {
            this.get().field.unselect(option)
            event.stopPropagation()
            this.set({filter: ''})
        }
    },
    oncreate() {
        const field = this.get().field
        this.get().field.pages.push(this)
    },
    store: () => store
}

</script>
