<svelte:document
    on:click="onDocumentClick(event)"
    on:keydown="onDocumentKeydown(event)"
></svelte:document>
{#if $forms}
<div
    ref:multiSelect
    class="multiSelect"
>
    <label
        class="field-label"
        use:for="{id}"
    >{label}</label>
    <section
        class="dropdownAnchor field selections"
        class:invalid="touched && errors.length"
        class:requiredInvalid="field.validatorMap.required && errors.length"
        class:requiredValid="field.validatorMap.required && !errors.length"
        on:click="showOptions(this, event)"
    >
    {#each selections as selection}
        <section
            class="selection"
        >
            <div
                class="selection-contents"
            >
            {selection.text}
            </div>
            <span
                class="unselect"
                on:click="unselect(selection, event)"
            >
                <s class="bar"></s>
                <s class="bar"></s>
            </span>
        </section>
    {/each}
        <input
            bind:value="filter"
            type="text"
            use:id="{id}"
        >
    </section>
    {#if showOptions && options.length}
    <ul
        class="dropdown"
        style="
            top: {dropdownTopPx}px;
        "
    >
        {#each options as option, index}
        <li
            class="option"
            class:activeOption="index === activeOptionIndex"
            on:click="select(option)"
        >{option.text}</li>
        {/each}
    </ul>
    {/if}
    {#if touched}
        {#each errors as error}
    <span class="pure-form-message error">{error.message}</span>
        {/each}
    {/if}
</div>
{/if}

<style>

    input[type="text"] {
        border: 0;
        box-shadow: none;
        color: #222;
        display: inline-block;
        font-weight: 600;
        margin: 0;
        padding-left: 5px;
        vertical-align: text-bottom;
        width: 50px;
    }

    li {
        font-weight: 600;
        list-style: none;
        padding: 10px;
    }

    li + li {
        border-top: 1px solid #f8f8f8;
    }

    li:hover {
        background-color: #eee;
    }

    ul {
        max-height: 300px;
        padding: 0;
        width: 100%;
    }

    .activeOption {
        background-color: #eee;
    }

    .multiSelect {
        position: relative;
    }

    .selection {
        /*background-color: #808080;*/
        /*border: 1px solid #777;*/
        background-color: #ccc;
        border: 1px solid #222;
        border-radius: 4px;
        color: #333;
        /*color: #fff;*/
        display: inline-block;
        font-weight: 600;
        margin: 6px 0 0 6px;
        padding-left: 8px;
    }

    .selection-contents {
        float: left;
        padding: 8px 2px 0 0;
    }

    .selections {
        background-color: white;
        min-height: 2.25em;
        padding-bottom: 5px;
        width: 100%;
    }

    .unselect {
        display: inline-block;
        height: 26px;
        margin-top: 4px;
        position: relative;
        width: 30px;
    }

    .unselect .bar {
        /*background-color: #fff;*/
        background-color: #222;
        display: block;
        height: 3px;
        width: 16px;
        position: absolute;
        right: 8px;
        top: 12px;
    }

    .unselect .bar:first-child {
        transform: rotate(-45deg);
    }

    .unselect .bar:last-child {
        transform: rotate(45deg);
    }

</style>

<script>
import store from '../../store'
import {addHeightWatch, removeHeightWatch} from '../../watch'

export default {
    actions: {
        for(node, id) {
            if(id) {
                node.id = id;
            }
        },
        id(node, id) {
            if(id) {
                node.id = id;
            }
        }
    },
    computed: {
        errors: ({delta, field}) => field.errors,
        label: ({delta, field}) => field.label,
        selections: ({delta, field}) => field.value,
        options: ({delta, field, filter}) => filter
        ? field.multiOptions
            .filter(option =>
                option.text.toLowerCase().indexOf(filter.toLowerCase()) > -1)
        : field.multiOptions,
        touched: ({delta, field}) => field.touched
    },
    data() {
        return {
            filter: '',
            activeOptionIndex: 0
        }
    },
    immutable: true,
    methods: {
        hideOptions() {
            removeHeightWatch(this)
            this.set({showOptions: false})
        },
        onBlur() {
            this.get().field.onBlur()
        },
        onDocumentClick(event) {
            this.hideOptions()
        },
        onDocumentKeydown(event) {
            let {activeOptionIndex, filter, options, showOptions} = this.get()
            if(!showOptions) {
                return
            }
            showOptions = true
            switch(event.key) {
                case 'ArrowDown':
                    if(activeOptionIndex + 1 < options.length) {
                        activeOptionIndex++
                    }
                    break;
                case 'ArrowUp':
                    if(activeOptionIndex) {
                        activeOptionIndex--
                    }
                    break;
                case 'Escape':
                    activeOptionIndex = 0
                    showOptions = false
                    break;
                case 'Enter':
                    this.get().field.select(options[activeOptionIndex])
                    activeOptionIndex = 0
                    filter = ''
                    showOptions = false
                    event.preventDefault()
                    break;
            }
            if(!showOptions) {
                this.hideOptions()
            }
            this.set({activeOptionIndex, filter})
        },
        select(option) {
            this.get().field.select(option)
            this.hideOptions()
            this.set({filter: ''})
        },
        showOptions(element, event) {
            if(!this.get().showOptions) {
                if(this.get().field.multiOptions.length) {
                    this.set({
                        showOptions: true,
                        dropdownTopPx: element.offsetHeight + 6
                    })
                    addHeightWatch(this, this.refs.multiSelect)
                    event.stopPropagation()
                }

                // dropdownPxFromTop
            }
            element.lastElementChild.focus()
        },
        unselect(option, event) {
            this.get().field.unselect(option)
            event.stopPropagation()
            this.set({filter: ''})
        }
    },
    oncreate() {
        const field = this.get().field
        this.get().field.pages.push(this)
    },
    ondestroy() {
        removeHeightWatch(this)
    },
    store: () => store
}

</script>
