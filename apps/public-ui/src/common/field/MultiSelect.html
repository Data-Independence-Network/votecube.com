<svelte:document
    on:click="onDocumentClick(event)"
    on:keydown="onDocumentKeydown(event)"
></svelte:document>
{#if $forms}
<div
    class="multi-select"
>
    <label
        class="field-label"
        use:for="{id}"
    >{label}</label>
    <section
        class="selections"
        on:click="showOptions(this, event)"
    >
    {#each selections as selection}
        <section
            class="selection"
        >
            <div
                class="selection-contents"
            >
            {selection.text}
            </div>
            <span
                class="unselect"
                on:click="unselect(selection, event)"
            >
                <s class="bar"></s>
                <s class="bar"></s>
            </span>
        </section>
    {/each}
    <input
    type="text"
    bind:value="filter"
    >
    </section>
    {#if showOptions}
    <ul
        style="top: {dropdownPxFromTop}px;"
    >
        {#each options as option}
        <li
            class="option"
            on:click="select(option)"
        >{option.text}</li>
        {/each}
    </ul>
    {/if}
    {#if touched}
        {#each errors as error}
    <span class="pure-form-message error">{error.message}</span>
        {/each}
    {/if}
</div>
{/if}

<style>

    input[type="text"] {
        border: 0;
        box-shadow: none;
        display: inline-block;
        padding-left: 5px;
        width: 50px;
    }

    li {
        list-style: none;
        padding: 5px;
    }

    ul {
        background-color: white;
        border: 1px solid gray;
        max-height: 300px;
        position: absolute;
        width: 100%;
        z-index: 100;
    }

    .multi-select {
        position: relative;
    }

    .selection {
        background-color: #ccc;
        border: 1px solid #000;
        border-radius: 4px;
        color: black;
        display: inline-block;
        margin: 5px 0 5px 5px;
        padding-left: 8px;
    }

    .selection-contents {
        float: left;
        padding-top: 8px;
    }

    .selections {
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: inset 0 1px 3px #ddd;
        min-height: 2.25em;
        width: 100%;
    }

    .selection-selected {

    }

    .unselect {
        display: inline-block;
        height: 26px;
        margin-top: 4px;
        position: relative;
        width: 26px;
    }

    .unselect .bar {
        background-color: white;
        display: block;
        height: 2px;
        width: 20px;
        position: absolute;
        right: 4px;
        top: 12px;
    }

    .unselect .bar:first-child {
        transform: rotate(-45deg);
    }

    .unselect .bar:last-child {
        transform: rotate(45deg);
    }

</style>

<script>
import store from '../../store.js'

export default {
    actions: {
        for(node, id) {
            if(id) {
                node.id = id;
            }
        },
        id(node, id) {
            if(id) {
                node.id = id;
            }
        }
    },
    computed: {
        errors: ({delta, field}) => field.errors,
        label: ({delta, field}) => field.label,
        selections: ({delta, field}) => field.value,
        options: ({delta, field, filter}) => filter
        ? field.multiOptions
            .filter(option =>
                option.text.toLowerCase().indexOf(filter.toLowerCase()) > -1)
        : field.multiOptions,
        touched: ({delta, field}) => field.touched
    },
    data() {
        return {
            filter: ''
        }
    },
    immutable: true,
    methods: {
        onBlur(event) {
            this.get().field.onBlur()
        },
        onDocumentClick(event) {
            this.set({showOptions: false})
        },
        onDocumentKeydown(event) {
            if(!this.get().showOptions) {
                return;
            }
            switch(event.key) {
                case 'ArrowDown':
                case 'ArrowUp':
                case 'Escape':
                    console.log(event);
                    break;
                case 'Enter':
                    console.log(event);
                    event.preventDefault()
            }
        },
        onInput(event) {
            this.get().field.onInput()
        },
        select(option) {
            this.get().field.select(option)
            this.set({showOptions: false})
            this.set({filter: ''})
        },
        showOptions(element, event) {
            if(!this.get().showOptions) {
                if(this.get().field.multiOptions.length) {
                    this.set({
                        showOptions: true,
                        dropdownPxFromTop: element.offsetHeight
                    })
                    event.stopPropagation()
                }

                // dropdownPxFromTop
            }
            element.lastElementChild.focus()
        },
        unselect(option, event) {
            this.get().field.unselect(option)
            event.stopPropagation()
            this.set({filter: ''})
        }
    },
    oncreate() {
        const field = this.get().field
        this.get().field.pages.push(this)
    },
    store: () => store
}
</script>