{#if $forms && colors}
<section>

	<table
			class="sliders"
	>
		<tr>
			<td>
				<div>
					<AddRemoveButton
							add="{false}"
							on:select="change('red', -1)"
							size="35"
							styles="{minusStyles}"
					></AddRemoveButton>
					<input
							class="redSlider"
							max="255"
							min="0"
							on:input="syncInput()"
							ref:redSlider
							type="range"
							value="{color.red}"
					>
					<AddRemoveButton
							add="{true}"
							on:select="change('red', 1)"
							size="35"
							styles="{plusStyles}"
					></AddRemoveButton>
					<var>
						{color.red}
					</var>
				</div>
			</td>
		</tr>
		<tr>
			<td>
				<div>
					<AddRemoveButton
							add="{false}"
							on:select="change('green', -1)"
							size="35"
							styles="{minusStyles}"
					></AddRemoveButton>
					<input
							class="greenSlider"
							max="255"
							min="0"
							on:input="syncInput()"
							ref:greenSlider
							type="range"
							value="{color.green}"
					>
					<AddRemoveButton
							add="{true}"
							on:select="change('green', 1)"
							size="35"
							styles="{plusStyles}"
					></AddRemoveButton>
					<var>
						{color.green}
					</var>
				</div>
			</td>
		</tr>
		<tr>
			<td>
				<div>
					<AddRemoveButton
							add="{false}"
							on:select="change('blue', -1)"
							size="35"
							styles="{minusStyles}"
					></AddRemoveButton>
					<input
							class="blueSlider"
							max="255"
							min="0"
							on:input="syncInput()"
							ref:blueSlider
							type="range"
							value="{color.blue}"
					>
					<AddRemoveButton
							add="{true}"
							on:select="change('blue', 1)"
							size="35"
							styles="{plusStyles}"
					></AddRemoveButton>
					<var>
						{color.blue}
					</var>
				</div>
			</td>
		</tr>
	</table>
	<div>
		<select
				on:input="selectColor(this.selectedIndex)"
				ref:select
		>
			{#each colors as color, index}
			<option
					value="{index}"
			>
				{color.name}
			</option>
			{/each}
		</select>
		{#if trackOriginal}
		<UndoIcon
				multiLine="y"
				on:select="revert()"
		></UndoIcon>
		{/if}
		<br>
		<figure
				style="background-color: rgb({color.red}, {color.green}, {color.blue});
							 color: #{getTextColor(color)};"
		>
			T
		</figure>
	</div>
</section>
{/if}

<style>
	input {
		-webkit-appearance: none; /* Override default CSS styles */
		appearance: none;
		background: #aaa;
		height: 5px;
		left: 37px;
		outline: none; /* Remove outline */
		position: absolute;
		top: 20px;
		width: calc(100% - 75px); /* Full-width */
	}

	input::-webkit-slider-thumb {
		-webkit-appearance: none; /* Override default look */
		appearance: none;
		border: 3px groove gray;
		border-radius: 3px;
		cursor: pointer; /* Cursor on hover */
		height: 35px; /* Slider handle height */
		width: 35px; /* Set a specific slider handle width */
	}

	input::-moz-range-thumb {
		border: 3px groove gray;
		border-radius: 3px;
		cursor: pointer; /* Cursor on hover */
		display: inline-block;
		height: 35px; /* Slider handle height */
		width: 35px; /* Set a specific slider handle width */
	}

	select {
		display: block;
		margin: auto;
	}

	figure {
		border: 4px groove gray;
		border-radius: 4px;
		font-size: 2.3em;
		height: 55px;
		margin: auto;
		width: 55px;
	}

	section {
		position: relative;
		text-align: center;
	}

	section > div {
		margin-top: -5px;
	}

	select {
		width: 150px;
	}

	table {
		margin-top: 20px;
		width: 100%;
	}

	td {
		height: 65px;
	}

	td > div {
		position: relative;
		height: 100%;
	}

	var {
		/*height: 30px;*/
		/*left: -15px;*/
		float: top;
		left: calc(50% - 20px);
		position: absolute;
		top: -19px;
		width: 40px;
	}

	.redSlider::-webkit-slider-thumb {
		background: #f22;
	}

	.redSlider::-moz-range-thumb {
		background: #f22;
	}

	.greenSlider::-webkit-slider-thumb {
		background: #2f2;
	}

	.greenSlider::-moz-range-thumb {
		background: #2f2;
	}

	.blueSlider::-webkit-slider-thumb {
		background: #22f;
	}

	.blueSlider::-moz-range-thumb {
		background: #22f;
	}

</style>

<script>
	import {getTextColor}  from '../../helpers/general'
	import {
		getColorKey,
		getColors
	}                      from '../../libs/colors'
	import store           from '../../store.js'
	import AddRemoveButton from '../control/button/AddRemoveButton.html'
	import UndoIcon        from '../icon/UndoIcon.html'

	export default {
		components: {
			AddRemoveButton,
			UndoIcon
		},
		computed: {
			errors: ({delta, field}) => field.errors,
			modified: ({delta, errors, field}) =>
				!errors.length && field.rules.trackOriginal && !field.theIsOriginal,
			requiredInvalid: ({delta, errors, field}) =>
				field.validatorMap.required && errors.length,
			requiredValid: ({delta, errors, field, modified}) =>
				!modified && field.validatorMap.required && !errors.length,
			trackOriginal: ({delta, field}) => field.rules.trackOriginal
		},
		data: () => ({
			plusStyles: 'display: inline-block; position: absolute; right: 0px; top: 5.5px;',
			minusStyles: 'display: inline-block; position: absolute; left: 0px; top: 5.5px;',
		}),
		helpers: {
			getTextColor
		},
		methods: {
			change(
				primary,
				value
			) {
				const {color}        = this.get()
				const exitingPrimary = parseInt(color[primary])

				if (exitingPrimary + value > 255) {
					return
				} else if (exitingPrimary + value < 0) {
					return
				}
				color[primary] = exitingPrimary + value
				color[primary] = color[primary].toString()
				const {field}  = this.get()
				setColor(color, field, this)
			},
			revert() {
				const {colorMap, field} = this.get()
				field.revert()

				const color = field.value
				matchColor(color, colorMap, this.refs.select)
				this.set({color})
			},
			selectColor(
				colorIndex
			) {
				const {colors} = this.get()
				const color    = copyColor(colors[colorIndex])
				const {field}  = this.get()
				setColor(color, field, this)
			},
			syncInput() {
				const {color, colorMap, field} = this.get()
				color.red                      = this.refs.redSlider.value
				color.green                    = this.refs.greenSlider.value
				color.blue                     = this.refs.blueSlider.value

				matchColor(color, colorMap, this.refs.select)

				this.set({color})
				field.validate()
			}
		},
		oncreate() {
			getColors().then(({
				                  colors,
				                  colorMap
			                  }) => {
				const {field} = this.get()

				const color = field.value
					? field.value
					: copyColor(colors[132])
				this.set({colors, colorMap, color})

				field.setAsField(this)

				if (!field.value) {
					field.value = color
				}
				field.validate()

				matchColor(color, colorMap, this.refs.select)
			})
		},
		ondestroy() {
			this.get().field.removeComponent(this)
		},
		store: () => store
	}

	function matchColor(
		color,
		colorMap,
		select
	) {
		const colorKey     = getColorKey(color)
		const matchedColor = colorMap[colorKey]
		let selectedIndex  = 132
		if (matchedColor) {
			selectedIndex = matchedColor.index
		}
		setTimeout(() => {
			select.selectedIndex = selectedIndex
		})
	}

	function copyColor(
		color
	) {
		return {
			name: color.name,
			...color
		}
	}

	function setColor(
		color,
		field,
		page
	) {
		field.value    = color
		field.validate()
		page.set({color})
	}

</script>