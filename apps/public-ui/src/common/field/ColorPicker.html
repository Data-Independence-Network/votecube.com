{#if $forms && colors}
<div>
	<table>
		<tr>
			<td>
				<select
								on:input="selectColor(this.selectedIndex)"
								ref:select
				>
					{#each colors as color, index}
					<option
									value="{index}"
					>
						{color.name}
					</option>
					{/each}
				</select>
				{#if trackOriginal}
				<UndoIcon
								multiLine="y"
								on:select="revert()"
				></UndoIcon>
				{/if}
			</td>
			<td>
				<figure
								style="background-color: rgb({color.red}, {color.green}, {color.blue})"
				></figure>
			</td>
		</tr>
	</table>
</div>
<section>
	<input
					class="redSlider"
					max="255"
					min="0"
					on:input="syncInput()"
					ref:redSlider
					type="range"
					value="{color.red}"
	>
</section>
<section>
	<input
					class="greenSlider"
					max="255"
					min="0"
					on:input="syncInput()"
					ref:greenSlider
					type="range"
					value="{color.green}"
	>
</section>
<section>
	<input
					class="blueSlider"
					max="255"
					min="0"
					on:input="syncInput()"
					ref:blueSlider
					type="range"
					value="{color.blue}"
	>
</section>
{/if}

<style>

	input {
		-webkit-appearance: none; /* Override default CSS styles */
		appearance: none;
		background: #aaa;
		height: 5px; /* Specified height */
		outline: none; /* Remove outline */
		width: 100%; /* Full-width */
	}

	input::-webkit-slider-thumb {
		-webkit-appearance: none; /* Override default look */
		appearance: none;
		border: 3px groove gray;
		border-radius: 3px;
		cursor: pointer; /* Cursor on hover */
		height: 45px; /* Slider handle height */
		width: 45px; /* Set a specific slider handle width */
	}

	input::-moz-range-thumb {
		cursor: pointer; /* Cursor on hover */
		border: 3px groove gray;
		border-radius: 3px;
		height: 45px; /* Slider handle height */
		width: 45px; /* Set a specific slider handle width */
	}

	section {
		margin: 35px 0;
	}

	select {
		display: block;
		margin: auto;
	}

	figure {
		border: 4px groove gray;
		border-radius: 6px;
		height: 90px;
		margin: auto;
		width: 90px;
	}

	table {
		width: 100%;
	}

	.redSlider::-webkit-slider-thumb {
		background: #f22;
	}

	.redSlider::-moz-range-thumb {
		background: #f22;
	}

	.greenSlider::-webkit-slider-thumb {
		background: #2f2;
	}

	.greenSlider::-moz-range-thumb {
		background: #2f2;
	}

	.blueSlider::-webkit-slider-thumb {
		background: #22f;
	}

	.blueSlider::-moz-range-thumb {
		background: #22f;
	}

</style>

<script>
	import {
		getColorKey,
		getColors
	}               from '../../libs/colors'
	import store    from '../../store.js'
	import UndoIcon from '../icon/UndoIcon.html'

	export default {
		components: {
			UndoIcon
		},
		computed: {
			errors: ({delta, field}) => field.errors,
			modified: ({delta, errors, field}) =>
				!errors.length && field.rules.trackOriginal && !field.theIsOriginal,
			requiredInvalid: ({delta, errors, field}) =>
				field.validatorMap.required && errors.length,
			requiredValid: ({delta, errors, field, modified}) =>
				!modified && field.validatorMap.required && !errors.length,
			trackOriginal: ({delta, field}) => field.rules.trackOriginal
		},
		methods: {
			revert() {
				const {colorMap, field} = this.get()
				field.revert()

				const color = field.value
				matchColor(color, colorMap, this.refs.select)
				this.set({color})
			},
			selectColor(
				colorIndex
			) {
				const {colors} = this.get()
				const color    = copyColor(colors[colorIndex])
				const {field}  = this.get()
				field.value    = color
				field.validate()
				this.set({color})
			},
			syncInput() {
				const {color, colorMap, field} = this.get()
				color.red                      = this.refs.redSlider.value
				color.green                    = this.refs.greenSlider.value
				color.blue                     = this.refs.blueSlider.value

				matchColor(color, colorMap, this.refs.select)

				this.set({color})
				field.validate()
			}
		},
		oncreate() {
			getColors().then(({
				                  colors,
				                  colorMap
			                  }) => {
				const {field} = this.get()

				const color = field.value
					? field.value
					: copyColor(colors[132])
				this.set({colors, colorMap, color})

				field.setAsField(this)

				if (!field.value) {
					field.value = color
				}
				field.validate()

				matchColor(color, colorMap, this.refs.select)
			})
		},
		ondestroy() {
			this.get().field.removeComponent(this)
		},
		store: () => store
	}

	function matchColor(
		color,
		colorMap,
		select
	) {
		const colorKey     = getColorKey(color)
		const matchedColor = colorMap[colorKey]
		let selectedIndex  = 132
		if (matchedColor) {
			selectedIndex = matchedColor.index
		}
		setTimeout(() => {
			select.selectedIndex = selectedIndex
		})
	}

	function copyColor(
		color
	) {
		return {
			name: color.name,
			...color
		}
	}

</script>