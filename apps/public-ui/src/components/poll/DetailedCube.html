<figure
		id="cube"
>
	<!--			on:click="toggleView(cubeView, event)"-->
	{#if poll}
	{#each positions as position, i}
	<div
			class="surface {loading ? 'loading' : ''} {rotating ? 'rotating' : ''}"
			id="s{i}"
			style="
            background-color: #{getColor(delta, poll, position.axis)};
              "
	>
		{#if !loading && !rotating}
		<header>
			{#if position.dir > 0}
			<!--						character="A"-->
			<CharacterButton
					character="A"
					fontSize="23"
					fontX="14.5"
					fontY="23"
					size="30"
					strokeWidth="0"
					styles="left: 1px; position: absolute; top: 0px;"
			></CharacterButton>
			{/if}
			<!--			<span>-->
			{getSideText(delta, 'confirm', poll, position.axis, position.dir)}
			<!--				</span>-->
			{#if position.dir < 0}
			<!--						character="A"-->
			<CharacterButton
					character="B"
					fontSize="23"
					fontX="14.5"
					fontY="23"
					size="30"
					strokeWidth="0"
					styles="right: 1px; position: absolute; top: 0px;"
			></CharacterButton>
			{/if}
		</header>
		{#if positionMode}
		<Positioner
				on:moveRight="moveRight(position.axis, position.dir, poll)"
				on:moveDown="moveDown(position.axis, position.dir, poll)"
				on:moveLeft="moveLeft(position.axis, position.dir, poll)"
				on:moveUp="moveUp(position.axis, position.dir, poll)"
				on:switchDir="switchDir(position.axis, position.dir, poll)"
		></Positioner>
		{/if}
		<p>
			{getSideText(delta, 'cube', poll, position.axis, position.dir)}
		</p>
		<!--
		{#if position.dir == -1}
		<footer>
			<var>
				<CharacterButton
						character="B"
				></CharacterButton>
			</var>
			<span>
					{getSideText(delta, 'confirm', poll, position.axis, position.dir)}
				</span>
		</footer>
		{/if}
		-->
		{/if}
	</div>
	{/each}
	{/if}
</figure>
<style>

	@media (min-width: 321px) {

		#cube > div {
			font-size: 1.9em;
			line-height: 1.2em;
		}

	}

	#cube {
		height: 320px;
		margin: auto;
		position: relative;
		/*transform: rotateX(0deg) rotateY(-90deg);*/
		transform-style: preserve-3d;
		/*top: 50%;*/
		width: 320px;
	}

	#cube > div {
		/*border: 5px groove gray;*/
		border: 5px solid gray;
		border-radius: 10px;
		color: #000;
		/*font-size: 2.0em;*/
		font-size: 1.7em;
		font-weight: bold;
		/*height: 320px;*/
		height: 311px;
		/*line-height: 2.0em;*/
		line-height: 1.2em;
		position: absolute;
		/*width: 320px;*/
		width: 311px;
		/*
		height: 360px;
		width: 360px;
		padding: 20px;
		font-size: 1.8em;
		line-height: 2em;
		*/
	}


	#s0 {
		/*background: hsla(  0, 100%, 50%, 0.95);*/
		transform: rotateX(90deg) translateZ(160px) /*translateZ(200px)*/;
	}

	#s1 {
		transform: translateZ(160px) /*translateZ(200px)*/;
	}

	#s2 {
		transform: rotateY(90deg) translateZ(160px) /*translateZ(200px)*/;
	}

	#s3 {
		transform: rotateY(180deg) translateZ(160px) /*translateZ(200px)*/;
	}

	#s4 {
		transform: rotateY(-90deg) translateZ(160px) /*translateZ(200px)*/;
	}

	#s5 {
		transform: rotateX(-90deg) rotate(180deg) translateZ(160px) /*translateZ(200px)*/;
	}

	div {
		transition: width 700ms, height 700ms, transform 700ms;
		transition-timing-function: ease-out;
	}

	div.rotating {
		transform: rotateX(180deg) rotateY(180deg) !important;
	}

	div.loading {
		width: 1px !important;
		height: 1px !important;
	}

	/*footer,*/
	header {
		color: #fff;
		background-color: #000;
		font-size: 0.8em;
		font-weight: 500;
		height: 30px;
		line-height: 1em;
		overflow: hidden;
		position: relative;
		text-align: center;
		text-overflow: ellipsis;
		width: 100%;
		white-space: nowrap;
	}

	header {
		top: 0px
	}

	/*	footer {
			bottom: 0px;
			position: absolute;
		}*/

	p {
		margin-block-start: 0em;
		margin-block-end: 0em;
		padding: 0 10px;
	}

	/*	span {
			position: absolute;
			left: 55px;
			top: 7px;
		}

		span {
			display: inline-block;
		}*/

	.surface {
		position: relative;
	}

</style>

<script>
	import {
		clearView,
		mutationApi,
		setView
	}                      from '@votecube/cube-logic'
	import {
		fade,
		fly
	}                      from 'svelte-transitions'
	import CharacterButton from '../../common/control/button/CharacterButton.html'
	import {
		getColor,
		getSideText
	}                      from '../../helpers/cube'
	import Positioner      from './create/Positioner.html'

	export default {
		components: {
			CharacterButton,
			Positioner
		},
		computed: {
			horizontalLayout: ({verticalLayout}) => !verticalLayout
		},
		data() {
			return {
				loading: true,
				positions: [{
					axis: 'x',
					dir: 1
				}, {
					axis: 'y',
					dir: 1
				}, {
					axis: 'z',
					dir: 1
				}, {
					axis: 'y',
					dir: -1
				}, {
					axis: 'z',
					dir: -1
				}, {
					axis: 'x',
					dir: -1
				}],
				rotating: false
			}
		},
		helpers: {
			getColor,
			getSideText
		},
		methods: {
			moveDown(
				axis,
				dir,
				poll
			) {
				move(this, poll, axis, dir, [
					['y', 1], // x+
					['y', 1], // x-
					['x', -1], // y+
					['x', -1], // y-
					['x', -1], // z+
					['x', -1] // z-
				])
			},
			moveLeft(
				axis,
				dir,
				poll
			) {
				move(this, poll, axis, dir, [
					['z', -1], // x+
					['z', 1], // x-
					['z', -1], // y+
					['z', 1], // y-
					['y', 1], // z+
					['y', -1] // z-
				])
			},
			moveRight(
				axis,
				dir,
				poll
			) {
				move(this, poll, axis, dir, [
					['z', 1], // x+
					['z', -1], // x-
					['z', 1], // y+
					['z', -1], // y-
					['y', -1], // z+
					['y', 1] // z-
				])
			},
			moveUp(
				axis,
				dir,
				poll
			) {
				move(this, poll, axis, dir, [
					['y', -1], // x+
					['y', -1], // x-
					['x', 1], // y+
					['x', 1], // y-
					['x', 1], // z+
					['x', 1] // z-
				])
			},
			switchDir(
				axis,
				dir,
				poll
			) {
				switchPoles(this, poll, axis, dir)
			},
			/*			toggleView(
							cubeView,
							event
						) {
							if (!cubeView) {
								this.fire('select', event)
							}
						}*/
		},
		oncreate() {
			setView('cube')
			mutationApi.recompute()
			this.stateListener = this.on('state', ({changed, current, previous}) => {
				if (current.vote) {
					this.get().vote.changeMillis = 128
					if (this.stateListener) {
						this.stateListener.cancel()
					}
				}
			})
			setTimeout(() => {
				this.set({loading: false, rotating: true})
				setTimeout(() => {
					this.set({rotating: false})
				}, 700)
			}, 100)
		},
		ondestroy() {
			clearView('cube')
		},
		transitions: {
			fade,
			fly
		}
		// onstate({changed, current}) {
		// 	if (!current.poll) {
		// 		return
		// 	}
		//
		// 	// let cubeElement
		// 	// if (changed.cubeView) {
		// 	// 	let options = {
		// 	// 		// x: 400,
		// 	// 		// y: 400,
		// 	// 		// duration: 700
		// 	// 	}
		// 	// 	// cubeElement = document.getElementById('cube')
		// 	// 	// cubeElement.classList.remove('cubeView')
		// 	// 	// if (current.cubeView) {
		// 	// 	// 	cubeElement.classList.add('cubeView')
		// 	// 	// 	// options.x = -options.x
		// 	// 	// 	// options.y = -options.y
		// 	// 	// }
		// 	// 	setTimeout(() => {
		// 	// 		transition(this, 'viewport', fade, options)
		// 	// 	})
		// 	// }
		//
		// 	if (changed.moveType) {
		// 		cubeElement = document.getElementById('cube')
		// 		cubeElement.classList.remove('toggle')
		// 		if (current.moveType === 'toggle') {
		// 			cubeElement.classList.add('toggle')
		// 		}
		// 	}
		// }
	}

	function move(
		component,
		poll,
		axis,
		dir,
		switchToDefinitions
	) {
		let switchPositions = getSwitchArray(axis, dir, switchToDefinitions)
		repositionAll(poll, switchPositions)

		component.fire('cubeAltered')
	}

	function switchPoles(
		component,
		poll,
		axis,
		dir
	) {
		let switchPositions = [{
			axis,
			dir
		},
			{
				axis,
				dir: dir === 1 ? -1 : 1
			}]

		const switchPollFactorPositions = getSwitchPollFactorPositions(poll, switchPositions)
		reposition(switchPollFactorPositions, 0, 1)

		component.fire('cubeAltered')
	}

	function getSwitchArray(
		axis,
		dir,
		switchToDefinitions
	) {
		switch (axis) {
			case 'x':
				if (dir == 1) {
					// X+ -> Z+
					return getSwitchPositions('x', 1, switchToDefinitions[0])
				} else {
					// X- -> Z-
					return getSwitchPositions('x', -1, switchToDefinitions[1])
				}
			case 'y':
				if (dir == 1) {
					// Y+ -> Z+
					return getSwitchPositions('y', 1, switchToDefinitions[2])
				} else {
					// Y- -> Z-
					return getSwitchPositions('y', -1, switchToDefinitions[3])
				}
			case 'z':
				if (dir == 1) {
					// Z+ -> Y-
					return getSwitchPositions('z', 1, switchToDefinitions[4])
				} else {
					// Z- -> Y+
					return getSwitchPositions('z', -1, switchToDefinitions[5])
				}
		}
	}

	function getSwitchPositions(
		axis,
		dir,
		to
	) {
		const [toAxis, toDir] = to
		const oppositeDir     = dir == 1 ? -1 : 1
		const toOppositeDir   = toDir == 1 ? -1 : 1
		return [{
			axis,
			dir
		},
			{
				axis: toAxis,
				dir: toDir
			},
			{
				axis,
				dir: oppositeDir
			},
			{
				axis: toAxis,
				dir: toOppositeDir
			}]
	}

	function repositionAll(
		poll,
		switchPositions
	) {
		const switchPollFactorPositions = getSwitchPollFactorPositions(poll, switchPositions)
		reposition(switchPollFactorPositions, 0, 1)
		reposition(switchPollFactorPositions, 2, 3)
	}

	function getSwitchPollFactorPositions(
		poll,
		switchPositions
	) {
		const switchPollFactorPositions = []
		switchPositions.forEach((
			switchPosition
		) => {
			switchPollFactorPositions.push(poll.pollsFactorsPositions.filter(
				pollFactorPosition =>
					switchPosition.axis === pollFactorPosition.axis
					&& switchPosition.dir === pollFactorPosition.dir)[0])
		})

		return switchPollFactorPositions
	}

	function reposition(
		switchPollFactorPositions,
		fromIndex,
		toIndex
	) {
		const fromFactorPosition                            = switchPollFactorPositions[fromIndex].factorPosition
		const fromColor                                     = switchPollFactorPositions[fromIndex].color
		const toFactorPosition                              = switchPollFactorPositions[toIndex].factorPosition
		const toColor                                       = switchPollFactorPositions[toIndex].color
		switchPollFactorPositions[fromIndex].factorPosition = toFactorPosition
		switchPollFactorPositions[fromIndex].color          = toColor
		switchPollFactorPositions[toIndex].factorPosition   = fromFactorPosition
		switchPollFactorPositions[toIndex].color            = fromColor
	}

</script>
