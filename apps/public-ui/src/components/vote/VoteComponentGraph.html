{#if poll && vote}
<table
		class="{classes}"
>
	{#each voteDims as voteDim, i}
	<tr>
		<td
				class="ranking"
				on:click="onClick(cubeView)"
		>
			{#if !i && !cubeView}
			<CubeMiniature
					delta="{delta}"
					poll="{poll}"
					vote="{vote}"
			></CubeMiniature>
			{:elseif cubeView && showPosition(voteDim, delta)}
			<figure
					style="background-color: #{getColor(delta, poll, voteDim.axis)};"
					transition:fly="{x: -50, duration: 700}"
			>
				<header></header>
				<CharacterButton
						character="{factorOutcome(voteDim, factorDelta)}"
						fontSize="20"
						fontX="12"
						fontY="19"
						size="24"
						strokeWidth="1"
						styles="left: {factorMiniLeft(voteDim, factorDelta)}px; position: absolute; top: 1px;"
				></CharacterButton>
			</figure>
			{/if}
		</td>
		<td
				class="chart"
				on:click="fire('toggleChart')"
		>
			<table>
				<tr>
					<td
							class="a"
					>
						{#if haveWidth(voteDim, 1, factorDelta)}
						<div
								class="bar {aClass(voteDim, factorDelta)}"
								id="bar_{i}"
								style="
        background-color: #{getColor(delta, poll, voteDim.axis)};
        width: {getWidth(voteDim, factorDelta)}%;
            "
						>
						</div>
						{/if}
					</td>
					<td
							class="b"
					>
						{#if haveWidth(voteDim, -1, factorDelta)}
						<div
								class="bar {bClass(voteDim, factorDelta)}"
								id="bar_{i}"
								style="
        background-color: #{getColor(delta, poll, voteDim.axis)};
        width: {getWidth(voteDim, factorDelta)}%;
            "
						>
						</div>
						{/if}
					</td>
				</tr>
			</table>
		</td>
		<td
				class="percent"
				on:click="fire('togglePercent', event)"
		>
			{#if showPosition(voteDim, delta)}
			<!--
			<CharacterButton
					character="{factorOutcome(voteDim)}"
					fontSize="20"
					fontX="12"
					fontY="19"
					size="24"
					strokeWidth="1"
					styles="left: 3px; position: absolute; top: 3px;"
			></CharacterButton>
			-->
			<span
					class="value"
					in:fade
			>{factorPercent(voteDim, factorDelta)}</span>
			<span
					class="sign"
					in:fade
			>%</span>
			{/if}
		</td>
	</tr>
	{/each}
	<tr>
		<td
				style="position: relative"
		>
			<div
					class="ageSuitabilityDash"
			>
				<var>
					<ShieldButton
							styles="left: 0px; position: absolute; top: 1px;"
							viewBox="0 0 100 100"
					></ShieldButton>
					<span
							class="ageSuitability"
					>{ageSuitability}</span>
				</var>
			</div>
		</td>
		<td
		>
			<table>
				<tr>
					<td
							style="width: 50%"
					>
						<div
								class="spacer"
						></div>
						<div
								class="aAxisLabel"
						>
							A
						</div>
						<div
								class="zeroAxisLabel"
						>
							0
						</div>
					</td>
					<td
							style="width: 50%"
					>
						<div
								class="spacer"
						></div>
						<div
								class="bAxisLabel"
						>
							B
						</div>
					</td>
				</tr>
			</table>
		</td>
		<td
				class="overall"
		>
			<div
					class="totals"
			>
				<summary>
					<div
							class="label"
					>Net:
					</div>
					<CharacterButton
							character="{outcome}"
							fontSize="22"

							fontX="13"
							fontY="21"
							size="26"
							strokeWidth="1"
							styles="left: 7px; position: absolute; top: 1px;"
					></CharacterButton>
					<span
							class="value"
					>{total}</span>
					<span
							class="sign"
					>%</span>
				</summary>
			</div>
		</td>
	</tr>
</table>
{/if}
<style>
	@media (min-width: 321px) {
		.bAxisLabel {
			display: block !important;
		}

		.totals {
			top: 30px !important;
		}

		.ageSuitabilityDash {
			top: 30px !important;
		}
	}

	div.bar {
		height: 23px;
		margin-top: 3px;
	}

	div.spacer {
		height: 1px;
		width: 100%;
		border-right: 1px solid white;
	}

	figure {
		width: 45px;
		height: 25px;
		position: relative;
		border: 1px solid gray;
		border-radius: 3px;
	}

	header {
		background-color: black;
		height: 5px;
		position: absolute;
		top: 0px;
		width: 100%;
	}

	span {
		display: inline-block;
		font-family: "Lucida Console";
		font-size: 1.4em;
		height: 29px;
		line-height: 33px;
		position: absolute;
		top: 0px;
		vertical-align: center;
	}

	span.total {
		line-height: 45px;
	}

	span.totalLabel {
		font-weight: normal;
		left: -20px;
	}

	summary,
	var {
		position: relative;
	}

	summary .label {
		position: absolute;
		top: 4px;
		left: -25px;
	}

	summary .sign {
		font-size: 1.0em;
		font-weight: 100;
		position: absolute;
		right: 9px;
		top: 0px;
	}

	summary .value {
		left: 28px;
		position: absolute;
		text-align: right;
		top: -1px;
		width: 50px;
	}

	table {
		width: 100%;
	}

	td {
		/*padding-top: 1px;*/
		position: relative;
	}

	td.ranking {
		width: 80px;
	}

	.a {
		border-right: 1px solid black;
	}

	.a,
	.b {
		height: 26px;
		width: 50%;
	}

	.a div {
		float: right
	}

	.aAxisLabel {
		bottom: -20px;
		/*left: -20px;*/
		left: -4px;
		position: absolute;
	}

	.ageSuitability {
		position: absolute;
		left: 30px;
		top: -1px;
	}

	.ageSuitabilityDash {
		color: black;
		left: 5px;
		position: absolute;
		top: 4px;
	}

	.bAxisLabel {
		bottom: -20px;
		display: none;
		position: absolute;
		right: -5px;
		/*right: -25px;*/
	}

	.chart {
		border-left: 1px solid gray;
		border-right: 1px solid gray;
		height: 26px;
	}

	.leftDirection {
		border-left: 2px solid black;
	}

	.percent {
		color: #606060;
		position: relative;
		width: 80px;
	}

	.percent .sign {
		font-size: 1.0em;
		font-weight: 100;
		position: absolute;
		right: 10px;
		top: 1px;
	}

	.percent .value {
		left: 12px;
		position: absolute;
		text-align: right;
		width: 45px;
	}

	.rightDirection {
		border-right: 2px solid black;
	}

	.totals {
		top: 4px;
		color: black;
		left: -21px;
		position: absolute;
		width: 100px;
	}

	.totals .value {
		font-size: 1.5em;
	}

	/*
		.minus td {
			vertical-align: top;
		}*/

	/*
	.pageFigure td,
	.pageTable td {

		padding: 5px;
		vertical-align: middle;
	}
	*/

	/*	.plus div {
			margin-bottom: 0px;
		}*/

	.zeroAxisLabel {
		bottom: -20px;
		position: absolute;
		right: -5.5px;
		/*right: -7px;*/
	}

</style>

<script>
	import {
		fade,
		fly
	}                      from 'svelte-transitions'
	import CharacterButton from '../../common/control/button/CharacterButton.html'
	import ShieldButton    from '../../common/control/button/ShieldButton.html'
	import {transition}    from '@votecube/public-logic/src/helpers/animation'
	import {getColor}      from '../../helpers/cube'
	import store           from '../../store'
	import CubeMiniature   from '../poll/CubeMiniature.html'
	import DetailedCube    from '../poll/DetailedCube.html'

	export default {
		components: {
			CharacterButton,
			CubeMiniature,
			DetailedCube,
			ShieldButton
		},
		computed: {
			ageSuitability: ({delta, poll}) => {
				if (!poll) {
					return '?'
				}
				switch (poll.ageSuitability) {
					case 0:
					case 7:
					case 13:
					case 17:
					case 21:
						return poll.ageSuitability + '+'
					default:
						return '?'
				}
			},
			signedTotal: ({voteDims, factorDelta}) => voteDims.reduce((
				total,
				voteDim
			) => total + voteDim.factorValue * voteDim.factorDir, 0),
			outcome: ({signedTotal, factorDelta}) => {
				if (signedTotal === 0) {
					return ' '
				}
				return signedTotal > 0 ? 'A' : 'B'
			},
			total:
				({signedTotal, factorDelta}) => Math.abs(signedTotal),
			// outcomeFontY: ({outcome}) => outcome === 'B' ? 21 : 21
		},
		helpers: {
			aClass:
				voteDim => voteDim.factorDir === 1 ? 'leftDirection' : '',
			bClass:
				voteDim => voteDim.factorDir === -1 ? 'rightDirection' : '',
			factorOutcome:
				voteDim => voteDim.factorDir > 0 ? 'A' : 'B',
			factorMiniLeft:
				voteDim => voteDim.factorDir > 0 ? 0 : 19,
			factorPercent:
				voteDim => voteDim.factorValue,
			getColor,
			getWidth:
				voteDim => voteDim.factorValue,
			haveWidth: (
				voteDim,
				dir
			) => voteDim.factorDir === dir,
			showPosition:
				voteDim => voteDim.value || voteDim.factorValue,
		},
		methods: {
			onClick(cubeView) {
				this.fire('toggleView')
			}
		},
		oncreate() {
			this.storeListener = store.on('state', ({changed, current, previous}) => {
				if (!changed.cardMove || this.get().cubeView) {
					return
				}
				const {move, moved} = current.cardMove

				if (moved.length === 3) {
					const options = {
						duration: 300,
						y: 26
					}
					setTimeout(() => {
						transition(this, 'bar_' + 0, fly, options)
						transition(this, 'bar_' + 1, fly, options)
						transition(this, 'bar_' + 2, fly, {duration: 700, y: -56})
					})
					return
				}

				let has0 = moved.indexOf(0) >= 0
				let has1 = moved.indexOf(1) >= 0

				const options = moved.map(
					index => {
						const y = getMoveY(index, has0, has1)
						return {
							duration: move === 1 ? 300 : 900,
							y
						}
					})

				setTimeout(() => {
					transition(this, 'bar_' + moved[0], fly, options[0])
					transition(this, 'bar_' + moved[1], fly, options[1])
				})
			})
		},
		ondestroy() {
			this.storeListener.cancel()
		},
		store: () => store,
		transitions: {
			fade,
			fly
		}
	}

	function getMoveY(
		index,
		has0,
		has1
	) {
		switch (index) {
			case 0:
				return has1 ? 26 : 52
			case 1:
				return has0 ? -26 : 26
			case 2:
				return has1 ? -26 : -52
		}
	}

</script>