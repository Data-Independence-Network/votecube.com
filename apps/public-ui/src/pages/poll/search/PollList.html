{#await load}
{:then}
<article
		transition:fade="{duration: 700}"
>
	{#if form}
	<form>
		<AutoComplete
				field="{form.fields.theme}"
		></AutoComplete>
	</form>
	<table>
		{#each polls as poll}
		<PollListItem
				logicUtils="{logicUtils}"
				mode="{mode}"
				on:select="goTo(poll.key, poll.rootVariationKey)"
				poll="{poll}"
		></PollListItem>
		{/each}
	</table>
	<PollListFab
			entityNames="Polls"
			on:factors="showFactors()"
			on:sort="setAction('sort')"
			on:filter="setAction('filter')"
			on:outcomes="showOutcomes()"
	></PollListFab>
	<!--
	<VirtualList items={factors} component={ListItem} />
	-->
	{#if ['filter', 'sort'].indexOf(action) > -1}
	<!--			contentClass="smallPadding"-->
	<ActionPopover
			customCancel="{true}"
			on:cancel="setAction('none')"
	>
		<div slot="header">
			{#if action === 'filter'}
			Coming soon - Filtering
			{:elseif action === 'sort'}
			Coming soon - Sorting
			{/if}
		</div>
		<div slot="content">
			<br>
			<h3>
				{#if action === 'filter'}
				Ability filter Poll results is coming right after Opinions and will be
				released mid-Alpha.
				{:elseif action === 'sort'}
				Ability sort Poll results is at the same time as the ability to filter
				and will be released mid-Alpha.
				{/if}
				<br>
				<br>
				Please see the <a
					on:click="goToReleasePlan()"
			>Release Plan</a> for details.
			</h3>
			<br>
		</div>
		<!--
		<div slot="actions">
			<VoteButton
					on:select="vote()"
			></VoteButton>
		</div>
	-->
		<div slot="cancel">
			<CancelButton
					on:select="setAction('none')"
			></CancelButton>
		</div>
	</ActionPopover>
	{/if}

	{/if}
</article>
{:catch error}
{error}
{getError(error)}
{/await}
<style>

	article {
		height: initial;
		position: relative;
		max-width: 420px;
		width: 100%;
	}

	table {
		width: 100%;
	}

</style>
<script>
	import {DI}          from '@airport/di'
	import {
		LOGIC_UTILS,
		POLL_MANAGER
	}                    from '@votecube/public-logic'
	import {fade}        from 'svelte-transitions'
	import CancelButton  from '../../../common/control/button/CancelButton.html'
	import AutoComplete  from '../../../common/field/AutoComplete.svelte'
	// import VirtualList from '@sveltejs/svelte-virtual-list';
	import ActionPopover from '../../../common/shell/ActionPopover.html'
	import PollListFab   from '../../../components/poll/PollListFab.html'
	import * as forms    from '../../../form/forms'
	import {loadForms}   from '../../../libs/forms'
	import * as routes   from '@votecube/public-logic/src/routes'
	import store         from '@votecube/public-logic/src/store'
	import PollListItem  from './PollListItem.html'

	export default {
		components: {
			ActionPopover,
			AutoComplete,
			CancelButton,
			PollListFab,
			PollListItem,
			// VirtualList
		},
		data() {
			return {
				mode: 'factors',
				load: new Promise((resolve) => {
					setTimeout(() => {
						resolve(initPage())
					}, 1)
				})
			}
		},
		helpers: {
			getError(
				error
			) {
				console.log(error)
			}
		},
		methods: {
			goTo(
				pollKey,
				pollVariationKey
			) {
				routes.navigateToPage(routes.POLL_MAIN, {
					mode: 'vote',
					pollKey,
					pollVariationKey,
				})
			},
			goToReleasePlan() {
				routes.navigateToPage(routes.RELEASE_PLAN)
			},
			setAction(
				action
			) {
				this.set({action, error: ''})
			},
			showFactors() {
				this.set({mode: 'factors'})
			},
			showOutcomes() {
				this.set({mode: 'outcomes'})
			},
		},
		oncreate() {
			initPage.page = this
		},
		ondestroy() {
			forms.clearForm(this)
		},
		store: () => store,
		transitions: {
			fade
		}
	}

	async function initPage() {
		const container                 = DI.ui('PollList')
		const [logicUtils, pollManager] =
			      await container.get(LOGIC_UTILS, POLL_MANAGER)
		const [
			      formFactory,
			      polls
		      ]                         = await Promise.all([
			loadForms(initPage.page.store),
			findPolls(null, pollManager)
		])

		const theme = formFactory.options([], [{
			id: 1,
			text: 'Politics'
		}, {
			id: 2,
			text: 'Culture'
		}, {
			id: 3,
			text: 'Technology'
		}, {
			id: 4,
			text: 'Space'
		}, {
			id: 5,
			text: 'Security'
		}])

		theme.onChange((aTheme) => {
			findPolls(aTheme, pollManager).then(
				polls => {
					initPage.page.set({polls})
				})
		})

		const filter = formFactory.group('List', {
			theme
		}, [], initPage.page.store.get().text.UI.Poll)

		initPage.page.set({container, logicUtils, polls})
		forms.ensureForm(filter, initPage.page)

		initPage.page.store.set({
			pageTitle: 'Polls'
		})
	}

	async function findPolls(
		theme,
		pollManager
	) {
		if (!theme) {
			return pollManager.getAllPolls()
		} else {
			return pollManager.getPollsForTheme(theme.id)
		}
	}
</script>
