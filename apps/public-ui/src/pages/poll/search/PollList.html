<article
		transition:fade="{duration: 700}"
>
	{#if form}
	<form>
		<AutoComplete
				field="{form.fields.theme}"
		></AutoComplete>
	</form>
	<table>
		{#each polls as poll}
		<PollListItem
				mode="{mode}"
				on:select="goTo(poll.key, poll.rootVariationKey)"
				poll="{poll}"
		></PollListItem>
		{/each}
	</table>
	<PollListFab
			entityNames="Polls"
			on:factors="showFactors()"
			on:sort="setAction('sort')"
			on:filter="setAction('filter')"
			on:outcomes="showOutcomes()"
	></PollListFab>
	<!--
	<VirtualList items={factors} component={ListItem} />
	-->
	{#if ['filter', 'sort'].indexOf(action) > -1}
	<!--			contentClass="smallPadding"-->
	<ActionPopover
			customCancel="{true}"
			on:cancel="setAction('none')"
	>
		<div slot="header">
			{#if action === 'filter'}
			Coming soon - Filtering
			{:elseif action === 'sort'}
			Coming soon - Sorting
			{/if}
		</div>
		<div slot="content">
			<br>
			<h3>
				{#if action === 'filter'}
				Ability filter Poll results is coming right after Opinions and will be
				released mid-Alpha.
				{:elseif action === 'sort'}
				Ability sort Poll results is at the same time as the ability to filter
				and will be released mid-Alpha.
				{/if}
				<br>
				<br>
				Please see the <a
					on:click="goToReleasePlan()"
			>Release Plan</a> for details.
			</h3>
			<br>
		</div>
		<!--
		<div slot="actions">
			<VoteButton
					on:select="vote()"
			></VoteButton>
		</div>
	-->
		<div slot="cancel">
			<CancelButton
					on:select="setAction('none')"
			></CancelButton>
		</div>
	</ActionPopover>
	{/if}

	{/if}
</article>

<style>

	article {
		height: initial;
		position: relative;
		max-width: 420px;
		width: 100%;
	}

	table {
		width: 100%;
	}

</style>
<script>
	import {DI}           from '@airport/di'
	import {POLL_DAO}            from '@votecube/public-db'
	import {fade}                from 'svelte-transitions'
	import CancelButton         from '../../../common/control/button/CancelButton.html'
	import AutoComplete         from '../../../common/field/AutoComplete.html'
	// import VirtualList from '@sveltejs/svelte-virtual-list';
	import Text                 from '../../../common/field/Text.html'
	import ActionPopover        from '../../../common/shell/ActionPopover.html'
	import PollListFab          from '../../../components/poll/PollListFab.html'
	import * as forms           from '../../../form/forms'
	import {fromPollListingDoc} from '../../../helpers/db/fromConverter'
	import {loadForms}          from '../../../libs/forms'
	import * as routes          from '../../../routes'
	import store                from '../../../store'
	import PollListItem         from './PollListItem.html'

	export default {
		components: {
			ActionPopover,
			AutoComplete,
			CancelButton,
			PollListFab,
			PollListItem,
			Text,
			// VirtualList
		},
		data() {
			return {
				mode: 'factors'
			}
		},
		methods: {
			goTo(
				pollKey,
				pollVariationKey
			) {
				routes.navigateToPage(routes.POLL_INFO_CUBE, {
					mode: 'vote',
					pollKey,
					pollVariationKey,
				})
			},
			goToReleasePlan() {
				routes.navigateToPage(routes.RELEASE_PLAN)
			},
			setAction(
				action
			) {
				this.set({action, error: ''})
			},
			showFactors() {
				this.set({mode: 'factors'})
			},
			showOutcomes() {
				this.set({mode: 'outcomes'})
			},
		},
		oncreate() {
			initPage(this)
		},
		ondestroy() {
			forms.clearForm(this)
		},
		store: () => store,
		transitions: {
			fade
		}
	}

	async function initPage(page) {
		const pollDao = await DI.get(POLL_DAO)
		const [
			    {OptionsField, FieldGroup},
			    polls
		    ]         = await Promise.all([
			loadForms(page),
			findPolls(null, pollDao)
		])

		const theme = new OptionsField([], [{
			id: 1,
			text: 'Politics'
		}, {
			id: 2,
			text: 'Culture'
		}, {
			id: 3,
			text: 'Technology'
		}, {
			id: 4,
			text: 'Space'
		}, {
			id: 5,
			text: 'Security'
		}])

		theme.onChange((aTheme) => {
			findPolls(aTheme, pollDao).then(
				polls => {
					page.set({polls})
				})
		})

		const filter = new FieldGroup('List', {
			theme
		}, [], page.store.get().text.UI.Poll)

		page.set({polls})
		forms.ensureForm(filter, page)

		page.store.set({
			pageTitle: 'Polls'
		})
	}

	async function findPolls(
		theme,
		pollDao
	) {
		let dbDocs
		if (!theme) {
			dbDocs = await pollDao.getAll()
		} else {
			dbDocs = await pollDao.getForTheme(theme.id)
		}

		return dbDocs.map(fromPollListingDoc)
	}
</script>
