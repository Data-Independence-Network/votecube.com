<article>
    {#if previewMode}
    <a
            class:bottomLeft="!$verticalLayout"
            class:topLeft="$verticalLayout"
            on:click="togglePositionMode()"
    >
        <PositionButton
                color="{dirPosButtonColor}"
        ></PositionButton>
    </a>
    {/if}
    <main
            class:offToRight="!$verticalLayout"
    >
        <section
                id="viewport"
                style="
  transform: scale({zoomFactor}, {zoomFactor});
"
                class:leftViewport="!$verticalLayout"
        >
            <figure
                    id="cube"
            >
                {#if poll}
                {#each positions as position, i}
                <div
                        class="surface"
                        id="s{i}"
                        style="
            background-color: #{getColor(delta, poll, position.axis)};
                "
                >
                    {#if position.dir == 1}
                    <header>
                        {getSideText(delta, 'confirm', poll, position.axis, position.dir)}
                    </header>
                    {/if}
                    {#if positionMode}
                    <Positioner
                            on:moveRight="moveRight(position.axis, position.dir)"
                            on:moveDown="moveDown(position.axis, position.dir)"
                            on:moveLeft="moveLeft(position.axis, position.dir)"
                            on:moveUp="moveUp(position.axis, position.dir)"
                            on:switchDir="switchDir(position.axis, position.dir)"
                    ></Positioner>
                    {/if}
                    <p>
                        {getSideText(delta, 'cube', poll, position.axis, position.dir)}
                    </p>
                    {#if position.dir == -1}
                    <footer>
                        {getSideText(delta, 'confirm', poll, position.axis, position.dir)}
                    </footer>
                    {/if}
                </div>
                {/each}
                {/if}
            </figure>
        </section>
    </main>
    {#if vote}
    {#if percentMode}
    <PercentPicker
            on:close="togglePercentPicker()"
            on:move="move(event)"
            on:moveToValue="moveToValue(event)"
            poll="{poll}"
            vote="{vote}"
    ></PercentPicker>
    {:else}
    {#if previewMode}
    <LeftButton
            classes="{modifyActionButtonPosition}"
            on:select="toPollForm($routeParams)"
    ></LeftButton>
    {:else}
    <a
            class="app-button {modifyActionButtonPosition}"
            on:click="togglePercentPicker()"
    >
        %
    </a>
    {/if}
    <table
            class="{$verticalLayout ? 'bottom-factor-table' : 'right-factor-table'}"
    >
        <tr>
            {#if $verticalLayout}
            <td
            >
                <FactorInfoButton
                        axis='x'
                        delta="{delta}"
                        mode="page"
                        on:toggle="toggleSurface('x')"
                        poll="{poll}"
                        voteDim="{vote.x}"
                ></FactorInfoButton>
            </td>
            <td
            >
                <FactorInfoButton
                        axis='y'
                        delta="{delta}"
                        mode="page"
                        on:toggle="toggleSurface('y')"
                        poll="{poll}"
                        voteDim="{vote.y}"
                ></FactorInfoButton>
            </td>
            <td>
                <FactorInfoButton
                        axis='z'
                        delta="{delta}"
                        mode="page"
                        on:toggle="toggleSurface('z')"
                        poll="{poll}"
                        voteDim="{vote.z}"
                ></FactorInfoButton>
            </td>
            {/if}
        </tr>
        {#if !$verticalLayout}
        <tr>
            <td>
                <FactorInfoButton
                        axis='z'
                        delta="{delta}"
                        mode="page"
                        on:toggle="toggleSurface('z')"
                        poll="{poll}"
                        voteDim="{vote.z}"
                ></FactorInfoButton>
            </td>
        </tr>
        <tr>
            <td>
                <FactorInfoButton
                        axis='y'
                        delta="{delta}"
                        mode="page"
                        on:toggle="toggleSurface('y')"
                        poll="{poll}"
                        voteDim="{vote.y}"
                ></FactorInfoButton>
            </td>
        </tr>
        <tr>
            <td
            >
                <FactorInfoButton
                        axis='x'
                        delta="{delta}"
                        mode="page"
                        on:toggle="toggleSurface('x')"
                        poll="{poll}"
                        voteDim="{vote.x}"
                ></FactorInfoButton>
            </td>
        </tr>
        {/if}
    </table>
    {#if previewMode}
    <BuildButton
            classes="{submitButtonPosition}"
            on:select="checkBuild()"
    ></BuildButton>
    {:else}
    <VoteButton
            classes="{submitButtonPosition}"
            on:select="confirmVote()"
    ></VoteButton>
    {/if}
    {/if}
    {#if confirm}
    {#if saving}
    <ActionPopover
            on:cancel="closeConfirm()"
            viewOnly="!error"
            infoOnly="error"
    >
        <div slot="header">
            {saving}
        </div>
        <div slot="content">
            {error}
        </div>
    </ActionPopover>
    {:elseif voting}
    <ActionPopover
            contentClass="smallPadding"
            on:cancel="closeConfirm()"
    >
        <div slot="header">
            Confirm Vote
        </div>
        <div slot="content">
            <div>
                {poll.name}
            </div>
            <VoteComponentGraph
                    bind:delta
                    bind:poll
                    verticalLayout="Y"
                    bind:vote
                    maxBarSize="60"
                    mode="confirm"
            ></VoteComponentGraph>
        </div>
        <div slot="actions">
            <VoteButton
                    on:select="vote()"
            ></VoteButton>
        </div>
    </ActionPopover>
    {:else}
    <ActionPopover
            on:cancel="closeConfirm()"
    >
        <div slot="header">
            Please Confirm
        </div>
        <div slot="content">
            Create the "{poll.name}" poll?
        </div>
        <div slot="actions">
            <BuildButton
                    on:select="build()"
            ></BuildButton>
        </div>
    </ActionPopover>
    {/if}
    {/if}
    {/if}
</article>
<style>
    @media (min-width: 62em) {
        article {
            width: 54%;
        }

        .bottom-factor-table {
            width: calc(54% - 140px) !important;
        }
    }

    article {
        position: absolute;
    }

    footer,
    header {
        color: #fff;
        background-color: #000;
        font-size: 0.9em;
        font-weight: 500;
        line-height: 1em;
        overflow: hidden;
        text-align: center;
        text-overflow: ellipsis;
        width: 100%;
        white-space: nowrap;
    }

    footer {
        bottom: 0px;
        position: absolute;
    }

    main {
        position: absolute;
        top: 33%;
        left: 50%;
        margin-right: -50%;
        transform: translate(-50%, -50%);
    }

    p {
        margin-block-start: 0em;
        margin-block-end: 0em;
        padding: 0 10px;
    }

    table {
        z-index: 2;
    }

    .bottom-factor-table {
        bottom: 10px;
        color: black;
        margin-left: 70px;
        margin-right: 70px;
        position: fixed;
        width: calc(100% - 140px);
    }

    .leftViewport {
        right: 20%;
    }

    .offToRight {
        left: 33%;
    }

    .right-factor-table {
        height: calc(100% - 84px);
        margin-top: 20px;
        position: fixed;
        right: 75px;
        top: 44px;
    }

    .surface {
        position: relative;
    }

    #viewport {
        height: 100%;
        perspective: 900px; /* FIXME: make the cube more approachable 1500px ~ 2500px;*/
        /* 1500 increases range from 11% to 9%, 2500 increases to 6% */
        perspective-origin: 50% 160px; /* 670px; */
        /*transform: scale(0.75,0.75);*/
        width: 100%;
    }

    #cube {
        height: 320px;
        margin: auto;
        position: relative;
        /*transform: rotateX(0deg) rotateY(-90deg);*/
        transform-style: preserve-3d;
        transition: transform 128ms linear;
        /*top: 50%;*/
        width: 320px;
    }

    #cube > div {
        /*border: 5px groove gray;*/
        border: 5px solid gray;
        border-radius: 10px;
        color: #000;
        font-size: 1.7em;
        /*height: 320px;*/
        height: 311px;
        line-height: 1.7em;
        position: absolute;
        /*width: 320px;*/
        width: 311px;
        /*
        height: 360px;
        width: 360px;
        padding: 20px;
        font-size: 1.8em;
        line-height: 2em;
        */
    }

    #s0 {
        /*background: hsla(  0, 100%, 50%, 0.95);*/
        transform: rotateX(90deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s1 {
        transform: translateZ(160px) /*translateZ(200px)*/;
    }

    #s2 {
        transform: rotateY(90deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s3 {
        transform: rotateY(180deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s4 {
        transform: rotateY(-90deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s5 {
        transform: rotateX(-90deg) rotate(180deg) translateZ(160px) /*translateZ(200px)*/;
    }

</style>

<script>
	import {DI}               from '@airport/di'
	import {POLL_DAO}         from '@votecube/public-db'
	import BuildButton        from '../../../common/control/button/BuildButton.html'
	import FactorInfoButton   from '../../../common/control/button/FactorInfoButton.html'
	import LeftButton         from '../../../common/control/button/LeftButton.html'
	import PositionButton     from '../../../common/control/button/PositionButton.html'
	import VoteButton         from '../../../common/control/button/VoteButton.html'
	import PercentPicker      from '../../../common/control/PercentPicker.html'
	import ActionPopover      from '../../../common/shell/ActionPopover.html'
	import Positioner         from '../../../components/poll/create/Positioner.html'
	import VoteComponentGraph from '../../../components/vote/VoteComponentGraph.html'

	import {setupCubeView}   from '../../../database'
	import {
		getColor,
		getSideText
	}                        from '../../../helpers/cube'
	import {
		setCubeAdjustment,
		shutDownCubeListener
	}                        from '../../../libs/cubeLogic'
	import {setResizeCllBck} from '../../../resizer'
	import * as routes       from '../../../routes'
	import store             from '../../../store'

	export default {
		components: {
			ActionPopover,
			BuildButton,
			FactorInfoButton,
			PositionButton,
			Positioner,
			LeftButton,
			PercentPicker,
			VoteButton,
			VoteComponentGraph
		},
		computed: {
			dirPosButtonColor: ({positionMode}) => positionMode
				? '0b0'
				: '000',
			previewMode: ({mode}) => mode === 'build' || mode === 'alter',
			modifyActionButtonPosition: ({$verticalLayout}) => $verticalLayout
				? 'bottomLeft'
				: 'bottomRight',
			submitButtonPosition: ({$verticalLayout}) => $verticalLayout
				? 'bottomRight'
				: 'topRight'
		},
		data() {
			return {
				positions: [{
					axis: 'x',
					dir: 1
				}, {
					axis: 'y',
					dir: 1
				}, {
					axis: 'z',
					dir: 1
				}, {
					axis: 'y',
					dir: -1
				}, {
					axis: 'z',
					dir: -1
				}, {
					axis: 'x',
					dir: -1
				}],
				currentZoom: 1,
				percentMode: false,
				delta: 0,
				verticalLayout: true,
				zoomFactor: 0.65
			}
		},
		helpers: {
			getColor,
			getSideText
		},
		methods: {
			build() {
				this.set({saving: 'Saving ...'})
				DI.get(POLL_DAO).then(
					pollDao => {
					    const poll = this.get().poll
              return pollDao.save(this.get().poll).then(() => {
                  this.set({confirm: false})
                  routes.navigateToPage(routes.POLL_SEARCH_LIST)
              }).catch((error) => {
                  this.set({error, saving: 'Error'})
              })
          })

			},
			checkBuild() {
				this.set({confirm: true, error: '', saving: false, voting: false})
			},
			closeConfirm() {
				setCubeAdjustment(this.get().cubeListener, true)
				this.set({confirm: false})
			},
			confirmVote() {
				setCubeAdjustment(this.get().cubeListener, false)
				this.set({confirm: true, error: '', saving: false, voting: true})
			},
			move(
				event
			) {
				this.get().mutationApi.move(
					event.factor,
					event.position,
					event.percentChange
				)
			},
			moveDown(
				axis,
				dir
			) {
				move(this, axis, dir, [
					['y', 1], // x+
					['y', 1], // x-
					['x', -1], // y+
					['x', -1], // y-
					['x', -1], // z+
					['x', -1] // z-
				])
			},
			moveLeft(
				axis,
				dir
			) {
				move(this, axis, dir, [
					['z', -1], // x+
					['z', 1], // x-
					['z', -1], // y+
					['z', 1], // y-
					['y', 1], // z+
					['y', -1] // z-
				])
			},
			moveRight(
				axis,
				dir
			) {
				move(this, axis, dir, [
					['z', 1], // x+
					['z', -1], // x-
					['z', 1], // y+
					['z', -1], // y-
					['y', -1], // z+
					['y', 1] // z-
				])
			},
			moveToValue(
				event
			) {
				this.get().mutationApi.moveToValue(event.factor, event.value)
			},
			moveUp(
				axis,
				dir
			) {
				move(this, axis, dir, [
					['y', -1], // x+
					['y', -1], // x-
					['x', 1], // y+
					['x', 1], // y-
					['x', 1], // z+
					['x', 1] // z-
				])
			},
			switchDir(
				axis,
				dir
			) {
				switchPoles(this, axis, dir)
			},
			togglePercentPicker() {
				const percentMode = !this.get().percentMode
				setCubeAdjustment(this.get().cubeListener, !percentMode)
				this.set({percentMode})
			},
			togglePositionMode() {
				this.set({positionMode: !this.get().positionMode})
			},
			toggleSurface(
				factorKey
			) {
				this.get().mutationApi.toggleSurface(factorKey)
				this.set({delta: this.get().delta + 1})
			},
			toPollForm(
				$routeParams
			) {
				routes.navigateToPage(routes.POLL_INFO_MAIN, $routeParams)
			},
			vote() {
				// this.set({confirm: false})
				DI.get(POLL_DAO).then(
					voteDao =>
						voteDao.save(this.get().poll).then(() => {
							this.set({confirm: false})
							routes.navigateToPage(routes.POLL_SEARCH_LIST)
						}).catch((error) => {
							this.set({error, saving: 'Error'})
						})
				)
			}
		},
		oncreate() {
			setResizeCllBck((
				portalHeight,
				windowWidth
			) => {
				const figureHeight = portalHeight * 0.55 + 95

				const cubeAreaLeastFactor = windowWidth < figureHeight
					? windowWidth
					: figureHeight

				const zoomFactor = (Math.sqrt(cubeAreaLeastFactor) * 3) / 100

				this.set({zoomFactor})
			}, this.store)

			const {mode, pollId} = this.store.get().routeParams

			setupCubeView(mode, pollId, this).then()

			this.store.set({
				cube: true,
				noOverflow: true
			})
		},
		ondestroy() {
			shutDownCubeListener(this.get().cubeListener, this)
			setResizeCllBck(null)
			this.store.set({
				cube: false,
				noOverflow: false
			})
		},
		store: () => store
	}

	function move(
		page,
		axis,
		dir,
		switchToDefinitions
	) {
		const {delta, poll} = page.get()
		let switchPositions = getSwitchArray(axis, dir, switchToDefinitions)
		repositionAll(poll, switchPositions)

		page.set({delta: delta + 1})
	}

	function switchPoles(
		page,
		axis,
		dir
	) {
		const {delta, poll} = page.get()
		let switchPositions = [{
			axis,
			dir
		},
			{
				axis,
				dir: dir === 1 ? -1 : 1
			}]

		const switchPollFactorPositions = getSwitchPollFactorPositions(poll, switchPositions)
		reposition(switchPollFactorPositions, 0, 1)

		page.set({delta: delta + 1})
	}

	function getSwitchArray(
		axis,
		dir,
		switchToDefinitions
	) {
		switch (axis) {
			case 'x':
				if (dir == 1) {
					// X+ -> Z+
					return getSwitchPositions('x', 1, switchToDefinitions[0])
				} else {
					// X- -> Z-
					return getSwitchPositions('x', -1, switchToDefinitions[1])
				}
			case 'y':
				if (dir == 1) {
					// Y+ -> Z+
					return getSwitchPositions('y', 1, switchToDefinitions[2])
				} else {
					// Y- -> Z-
					return getSwitchPositions('y', -1, switchToDefinitions[3])
				}
			case 'z':
				if (dir == 1) {
					// Z+ -> Y-
					return getSwitchPositions('z', 1, switchToDefinitions[4])
				} else {
					// Z- -> Y+
					return getSwitchPositions('z', -1, switchToDefinitions[5])
				}
		}
	}

	function getSwitchPositions(
		axis,
		dir,
		to
	) {
		const [toAxis, toDir] = to
		const oppositeDir     = dir == 1 ? -1 : 1
		const toOppositeDir   = toDir == 1 ? -1 : 1
		return [{
			axis,
			dir
		},
			{
				axis: toAxis,
				dir: toDir
			},
			{
				axis,
				dir: oppositeDir
			},
			{
				axis: toAxis,
				dir: toOppositeDir
			}]
	}

	function repositionAll(
		poll,
		switchPositions
	) {
		const switchPollFactorPositions = getSwitchPollFactorPositions(poll, switchPositions)
		reposition(switchPollFactorPositions, 0, 1)
		reposition(switchPollFactorPositions, 2, 3)
	}

	function getSwitchPollFactorPositions(
		poll,
		switchPositions
	) {
		const switchPollFactorPositions = []
		switchPositions.forEach((
			switchPosition
		) => {
			switchPollFactorPositions.push(poll.pollsFactorsPositions.filter(
				pollFactorPosition =>
					switchPosition.axis === pollFactorPosition.axis
					&& switchPosition.dir === pollFactorPosition.dir)[0])
		})

		return switchPollFactorPositions
	}

	function reposition(
		switchPollFactorPositions,
		fromIndex,
		toIndex
	) {
		const fromFactorPosition                            = switchPollFactorPositions[fromIndex].factorPosition
		const fromColor                                     = switchPollFactorPositions[fromIndex].color
		const toFactorPosition                              = switchPollFactorPositions[toIndex].factorPosition
		const toColor                                       = switchPollFactorPositions[toIndex].color
		switchPollFactorPositions[fromIndex].factorPosition = toFactorPosition
		switchPollFactorPositions[fromIndex].color          = toColor
		switchPollFactorPositions[toIndex].factorPosition   = fromFactorPosition
		switchPollFactorPositions[toIndex].color            = fromColor
	}

</script>
