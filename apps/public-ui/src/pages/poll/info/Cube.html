<article>
{#if previewMode}
    <a
        class:verticalDimensionPosition="$verticalLayout"
        class:horizontalDimensionPosition="!$verticalLayout"
        on:click="togglePositionMode()"
    >
        <DirectionPositionButton
            color="{dirPosButtonColor}"
        ></DirectionPositionButton>
    </a>
{/if}
    <section
            id="viewport"
            style="
  transform: scale({zoomFactor}, {zoomFactor});
"
            class:leftViewport="!$verticalLayout"
    >
        <figure
                id="cube"
        >
{#if poll}
            <div
                class="surface"
                id="s1"
                style="
            background-color: #{getColor(delta, poll, 'x')};
                "
            >
    {#if positionMode}
                <DirectionPositioner
                    on:moveRight="moveRight('x', 1)"
                    on:moveDown="moveDown('x', 1)"
                    on:moveLeft="moveLeft('x', 1)"
                    on:moveUp="moveUp('x', 1)"
                    on:switchDir="switchDir('x', 1)"
                ></DirectionPositioner>
    {/if}
                {getSideText(delta, poll, 'x', 1)}
            </div>
            <div
                class="surface"
                id="s2"
                style="
            background-color: #{getColor(delta, poll, 'y')};
                "
            >
    {#if positionMode}
                <DirectionPositioner
                    on:moveRight="moveRight('y', 1)"
                    on:moveDown="moveDown('y', 1)"
                    on:moveLeft="moveLeft('y', 1)"
                    on:moveUp="moveUp('y', 1)"
                    on:switchDir="switchDir('y', 1)"
                ></DirectionPositioner>
    {/if}
                {getSideText(delta, poll, 'y', 1)}
            </div>
            <div
                class="surface"
                id="s3"
                style="
            background-color: #{getColor(delta, poll, 'z')};
                "
            >
    {#if positionMode}
                <DirectionPositioner
                    on:moveRight="moveRight('z', 1)"
                    on:moveDown="moveDown('z', 1)"
                    on:moveLeft="moveLeft('z', 1)"
                    on:moveUp="moveUp('z', 1)"
                    on:switchDir="switchDir('z', 1)"
                ></DirectionPositioner>
    {/if}
                {getSideText(delta, poll, 'z', 1)}
            </div>
            <div
                class="surface"
                id="s4"
                style="
            background-color: #{getColor(delta, poll, 'y')};
                "
            >
    {#if positionMode}
                <DirectionPositioner
                    on:moveRight="moveRight('y', -1)"
                    on:moveDown="moveDown('y', -1)"
                    on:moveLeft="moveLeft('y', -1)"
                    on:moveUp="moveUp('y', -1)"
                    on:switchDir="switchDir('y', -1)"
                ></DirectionPositioner>
    {/if}
                {getSideText(delta, poll, 'y', -1)}
            </div>
            <div
                class="surface"
                id="s5"
                style="
            background-color: #{getColor(delta, poll, 'z')};
                "
            >
    {#if positionMode}
                <DirectionPositioner
                    on:moveRight="moveRight('z', -1)"
                    on:moveDown="moveDown('z', -1)"
                    on:moveLeft="moveLeft('z', -1)"
                    on:moveUp="moveUp('z', -1)"
                    on:switchDir="switchDir('z', -1)"
                ></DirectionPositioner>
    {/if}
                {getSideText(delta, poll, 'z', -1)}
            </div>
            <div
                class="surface"
                id="s6"
                style="
            background-color: #{getColor(delta, poll, 'x')};
                "
            >
    {#if positionMode}
                <DirectionPositioner
                    on:moveRight="moveRight('x', -1)"
                    on:moveDown="moveDown('x', -1)"
                    on:moveLeft="moveLeft('x', -1)"
                    on:moveUp="moveUp('x', -1)"
                    on:switchDir="switchDir('x', -1)"
                ></DirectionPositioner>
    {/if}
                {getSideText(delta, poll, 'x', -1)}
            </div>
{/if}
        </figure>
    </section>
{#if vote}
    {#if percentMode}
    <PercentPicker
        on:close="togglePercentPicker()"
        on:move="move(event)"
        on:moveToValue="moveToValue(event)"
        poll="{poll}"
        vote="{vote}"
    ></PercentPicker>
    {:else}
        {#if previewMode}
    <LeftButton
        classes="{modifyActionButtonPosition}"
        on:select="toPollForm()"
    ></LeftButton>
        {:else}
    <a
        class="app-button {modifyActionButtonPosition}"
        on:click="togglePercentPicker()"
    >
        %
    </a>
        {/if}
    <table
        class="{$verticalLayout ? 'bottom-dimension-table' : 'right-dimension-table'}"
    >
    <tr>
        {#if $verticalLayout}
        <td
        >
            <DimensionInfoButton
                delta="{delta}"
                axis='x'
                on:toggle="toggleSurface('x')"
                poll="{poll}"
                voteDim="{vote.x}"
            ></DimensionInfoButton>
        </td>
        <td
        >
            <DimensionInfoButton
                delta="{delta}"
                axis='y'
                on:toggle="toggleSurface('y')"
                poll="{poll}"
                voteDim="{vote.y}"
            ></DimensionInfoButton>
        </td>
        <td>
            <DimensionInfoButton
                delta="{delta}"
                axis='z'
                on:toggle="toggleSurface('z')"
                poll="{poll}"
                voteDim="{vote.z}"
            ></DimensionInfoButton>
        </td>
        {/if}
    </tr>
        {#if !$verticalLayout}
    <tr>
        <td>
            <DimensionInfoButton
                delta="{delta}"
                axis='z'
                on:toggle="toggleSurface('z')"
                poll="{poll}"
                voteDim="{vote.z}"
            ></DimensionInfoButton>
        </td>
    </tr>
    <tr>
        <td>
            <DimensionInfoButton
                delta="{delta}"
                axis='y'
                on:toggle="toggleSurface('y')"
                poll="{poll}"
                voteDim="{vote.y}"
            ></DimensionInfoButton>
        </td>
    </tr>
    <tr>
        <td
        >
            <DimensionInfoButton
                delta="{delta}"
                axis='x'
                on:toggle="toggleSurface('x')"
                poll="{poll}"
                voteDim="{vote.x}"
            ></DimensionInfoButton>
        </td>
    </tr>
        {/if}
    </table>
        {#if previewMode}
    <BuildButton
        classes="{submitButtonPosition}"
        on:select="checkBuild()"
    ></BuildButton>
        {:else}
    <VoteButton
        classes="{submitButtonPosition}"
    ></VoteButton>
        {/if}
    {/if}
    {#if confirming}
    <Popover
        width="90%"
    >
        <div slot="content">
        {#if saving}
            <header>
                {saving}
            </header>
            {#if error}
            <p>
                {error}
            </p>
            <footer
                style="text-align: center;"
            >
                <CancelButton
                    on:select="doNotBuild()"
                ></CancelButton>
            </footer>
            {/if}
        {:else}
            <header>
                Please Confirm
            </header>
            <p>
                Create the "{poll.name}" poll?
            </p>
            <footer>
                <CancelButton
                    on:select="doNotBuild()"
                ></CancelButton>
                <BuildButton
                    classes="floatRight"
                    on:select="build()"
                ></BuildButton>
            </footer>
        {/if}
        </div>
    </Popover>
    {/if}
{/if}
</article>
<style>
    div[slot="content"] {
        color: #222;
    }
    footer {
        margin: 0 20%;
    }
    header {
        font-size: 1.3em;
        font-weight: bold;
        text-align: center;
        margin: 15px 0;
        width: 100%;
    }
    p {
        text-align: center;
    }
    .bottom-dimension-table {
        bottom: 10px;
        color: black;
        margin-left: 70px;
        margin-right: 70px;
        position: fixed;
        width: calc(100% - 140px);
    }

    .horizontalDimensionPosition {
            position: fixed;
            bottom: 10px;
            left: 8px;
    }

    .leftViewport {
        right: 20%;
    }

    .right-dimension-table {
        height: calc(100% - 84px);
        margin-top: 20px;
        position: fixed;
        right: 75px;
        top: 44px;
    }

    .verticalDimensionPosition {
            position: fixed;
            top: 55px;
            left: 8px;
    }

    .surface {
        position: relative;
    }

    #viewport {
        height: 100%;
        perspective: 900px; /* FIXME: make the cube more approachable 1500px ~ 2500px;*/
        /* 1500 increases range from 11% to 9%, 2500 increases to 6% */
        perspective-origin: 50% 160px; /* 670px; */
        position: fixed;
        top: 0px;
        /*transform: scale(0.75,0.75);*/
        width: 100%;
    }

    #cube {
        height: 320px;
        margin: auto;
        position: relative;
        /*transform: rotateX(0deg) rotateY(-90deg);*/
        transform-style: preserve-3d;
        transition: transform 128ms linear;
        /*top: 50%;*/
        width: 320px;
    }

    #cube > div {
        position: absolute;
        /*
        height: 360px;
        width: 360px;
        padding: 20px;
        font-size: 1.8em;
        line-height: 2em;
        */
        height: 300px;
        width: 300px;
        padding: 10px;
        font-size: 1.7em;
        line-height: 1.7em;
        color: #000;
        border-radius: 10px;
        border: 5px groove gray;
    }

    #s1  {
        /*background: hsla(  0, 100%, 50%, 0.95);*/
        transform: rotateX(90deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s2 {
        transform: translateZ(160px) /*translateZ(200px)*/;
    }

    #s3 {
        transform: rotateY(90deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s4 {
        transform: rotateY(180deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s5 {
        transform: rotateY(-90deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s6 {
        transform: rotateX(-90deg) rotate(180deg) translateZ(160px) /*translateZ(200px)*/;
    }

</style>

<script>
import BuildButton from '../../../common/control/button/BuildButton.html'
import CancelButton from '../../../common/control/button/CancelButton.html'
import DimensionInfoButton from '../../../common/control/button/DimensionInfoButton.html'
import DirectionPositionButton from '../../../common/control/button/DirectionPositionButton.html'
import LeftButton from '../../../common/control/button/LeftButton.html'
import PercentPicker from '../../../common/control/PercentPicker.html'
import DirectionPositioner from '../../../components/poll/create/DirectionPositioner.html'
import VoteButton from '../../../common/control/button/VoteButton.html'
import Popover from '../../../common/shell/Popover.html'
import {pollDao} from '../../../dao/poll';
import {voteDao} from '../../../dao/vote';
import {getColor, getSideText} from '../../../helpers/cube';
import {loadCubeLogic, setCubeAdjustment, shutDownCubeListener} from '../../../libs/cubeLogic'
import {setResizeCllBck} from '../../../resizer'
import * as routes from '../../../routes'
import store from '../../../store';

export default {
    components: {
        BuildButton,
        CancelButton,
        DimensionInfoButton,
        DirectionPositionButton,
        DirectionPositioner,
        LeftButton,
        PercentPicker,
        Popover,
        VoteButton
    },
    computed: {
        dirPosButtonColor: ({positionMode}) => positionMode
            ? '0b0'
            : '000',
        previewMode: ({mode}) => mode === 'build',
        modifyActionButtonPosition: ({$verticalLayout}) => $verticalLayout
            ? 'bottomLeft'
            : 'bottomRight',
        submitButtonPosition: ({$verticalLayout}) => $verticalLayout
            ? 'bottomRight'
            : 'topRight'
    },
    data() {
        return {
            currentZoom: 1,
            percentMode: false,
            delta: 0,
            verticalLayout: true,
            zoomFactor: 0.65
        }
    },
	helpers: {
		getColor,
		getSideText
	},
    methods: {
        build() {
            this.set({saving: 'Saving ...'})
            pollDao.save(this.get().poll).then(() => {
                this.set({confirming: false})
                routes.navigateToPage(routes.POLL_SEARCH_LIST)
            }).catch((error) => {
                this.set({error, saving: 'Error'})
            });
        },
        checkBuild() {
            this.set({confirming: true, error: null, saving: false})
        },
        doNotBuild() {
            this.set({confirming: false})
        },
        move(
            event
        ) {
            this.get().mutationApi.move(
                event.dimension,
                event.direction,
                event.percentChange
            )
        },
        moveDown(
            axis,
            dir
        ) {
            move(this, axis, dir, [
                    ['y', 1], // x+
                    ['y', 1], // x-
                    ['x', -1], // y+
                    ['x', -1], // y-
                    ['x', -1], // z+
                    ['x', -1] // z-
                ])
        },
        moveLeft(
            axis,
            dir
        ) {
            move(this, axis, dir, [
                    ['z', -1], // x+
                    ['z', 1], // x-
                    ['z', -1], // y+
                    ['z', 1], // y-
                    ['y', 1], // z+
                    ['y', -1] // z-
                ])
        },
        moveRight(
            axis,
            dir
        ) {
            move(this, axis, dir, [
                    ['z', 1], // x+
                    ['z', -1], // x-
                    ['z', 1], // y+
                    ['z', -1], // y-
                    ['y', -1], // z+
                    ['y', 1] // z-
                ])
        },
        moveToValue(
            event
        ) {
            this.get().mutationApi.moveToValue(event.dimension, event.value)
        },
        moveUp(
            axis,
            dir
        ) {
            move(this, axis, dir, [
                    ['y', -1], // x+
                    ['y', -1], // x-
                    ['x', 1], // y+
                    ['x', 1], // y-
                    ['x', 1], // z+
                    ['x', 1] // z-
                ])
        },
        switchDir(
            axis,
            dir
        ) {
            switchPoles(this, axis, dir)
        },
        togglePercentPicker() {
            const percentMode = !this.get().percentMode
            setCubeAdjustment(this.get().cubeListener, !percentMode)
            this.set({percentMode})
        },
        togglePositionMode() {
            this.set({positionMode: !this.get().positionMode})
        },
        toggleSurface(
            dimensionKey
        ) {
            this.get().mutationApi.toggleSurface(dimensionKey)
            this.set({delta: this.get().delta + 1})
        },
        toPollForm() {
            routes.navigateToPage(routes.POLL_INFO_MAIN)
        }
    },
    oncreate() {
        setResizeCllBck((
            portalHeight,
            windowWidth
        ) => {
            const figureHeight = portalHeight * 0.55 + 95

            const cubeAreaLeastDimension = windowWidth < figureHeight
                ? windowWidth
                : figureHeight

            const zoomFactor = (Math.sqrt(cubeAreaLeastDimension) * 3) / 100

            this.set({zoomFactor})
        }, this.store)

        const {mode, pollId} = this.store.get().routeParams;

        Promise.all([
            loadCubeLogic(this, (vote) => {
                this.set({delta: this.get().delta + 1})
            }),
            voteDao.findMyVoteForPoll(pollId)
        ]).then(([
            setPositionDataAndMove,
            vote
        ]) => {
            if(!vote) {
                if(pollId == 0) {
                    routes.navigateToPage(routes.POLL_INFO_MAIN)
                }
                return
            }
            const poll = vote.poll
            this.set({mode, poll, vote})
            setPositionDataAndMove(vote)
        })

        this.store.set({noOverflow: true})
    },
    ondestroy() {
        shutDownCubeListener(this.get().cubeListener, this)
        setResizeCllBck(null)
        this.store.set({noOverflow: false})
    },
    store: () => store
}

function move(
    page,
    axis,
    dir,
    switchToDefinitions
) {
    const {delta, poll} = page.get()
    let switchPositions = getSwitchArray(axis, dir, switchToDefinitions);
    repositionAll(poll, switchPositions)

    page.set({delta: delta + 1})
}

function switchPoles(
    page,
    axis,
    dir
) {
    const {delta, poll} = page.get()
    let switchPositions = [{
            axis,
            dir
        },
        {
            axis,
            dir: dir === 1 ? -1 : 1
        }]

   const switchPollDimDirs = getSwitchPollDimDirs(poll, switchPositions)
   reposition(switchPollDimDirs, 0, 1)

   page.set({delta: delta + 1})
}

function getSwitchArray(
    axis,
    dir,
    switchToDefinitions
) {
    switch(axis) {
    case 'x':
        if(dir == 1) {
            // X+ -> Z+
            return getSwitchPositions('x', 1, switchToDefinitions[0])
        } else {
            // X- -> Z-
            return getSwitchPositions('x', -1, switchToDefinitions[1])
        }
    case 'y':
        if(dir == 1) {
            // Y+ -> Z+
            return getSwitchPositions('y', 1, switchToDefinitions[2])
        } else {
            // Y- -> Z-
            return getSwitchPositions('y', -1, switchToDefinitions[3])
        }
    case 'z':
        if(dir == 1) {
            // Z+ -> Y-
            return getSwitchPositions('z', 1, switchToDefinitions[4])
        } else {
            // Z- -> Y+
            return getSwitchPositions('z', -1, switchToDefinitions[5])
        }
    }
}

function getSwitchPositions(
    axis,
    dir,
    to
) {
    const [toAxis, toDir] = to
    const oppositeDir = dir == 1 ? -1 : 1
    const toOppositeDir = toDir == 1 ? -1 : 1
    return [{
            axis,
            dir
        },
        {
            axis: toAxis,
            dir: toDir
        },
        {
            axis,
            dir: oppositeDir
        },
        {
            axis: toAxis,
            dir: toOppositeDir
        }]
}

function repositionAll(
    poll,
    switchPositions
) {
   const switchPollDimDirs = getSwitchPollDimDirs(poll, switchPositions)
   reposition(switchPollDimDirs, 0, 1)
   reposition(switchPollDimDirs, 2, 3)
}

function getSwitchPollDimDirs(
    poll,
    switchPositions
) {
    const switchPollDimDirs = []
       switchPositions.forEach((
               switchPosition
           ) => {
               switchPollDimDirs.push(poll.pollsDimensionsDirections.filter(
                   pollDimensionDirection =>
                   switchPosition.axis === pollDimensionDirection.axis
                   && switchPosition.dir === pollDimensionDirection.dir )[0])
       })

    return switchPollDimDirs
}

function reposition(
    switchPollDimDirs,
    fromIndex,
    toIndex
) {
   const fromDimDir = switchPollDimDirs[fromIndex].dimensionDirection
   const fromColor = switchPollDimDirs[fromIndex].color
   const toDimDir = switchPollDimDirs[toIndex].dimensionDirection
   const toColor = switchPollDimDirs[toIndex].color
   switchPollDimDirs[fromIndex].dimensionDirection = toDimDir
   switchPollDimDirs[fromIndex].color = toColor
   switchPollDimDirs[toIndex].dimensionDirection = fromDimDir
   switchPollDimDirs[toIndex].color = fromColor
}

</script>
