<article>
	<!--
			class:topLeft="!cubeView && !$verticalLayout"
			-->
	<!-- for toggling the view -->
	<!--
	<nav>
	</nav>
	should clicking on non-buttons cause the view to change - probably not,
	the interface should be simple and orthogonal, only the buttons toggle,
	not free floating icons.

	And all buttons are always behind the Fab

	Fab has all of the actions related to that screen, system wide
	actions are in ?top menu?

	for example for the poll screens Fab shows the:

	vertical - on screen actions
	horizontal - related views

	?but what if you have to navigate to an unrelated view?  some views
	are accessible from anywhere, like:
		create new poll
		poll listings (there is only one with filters)
		favorites (like bookmarks of saved listing filters) - post beta launch
		about (mission statement and the team)

	so a top level menu seems appropriate, BUT we can hide it until
	you click on the Fab.  But in that case, where does the poll title
	go - probably just across the screen on the top, without a menu.
	That leaves more space for the title (of poll or just screen,
	if needed)

	how important are animations

	for ranking view it is important that:

		using it is intuitive
		the information on it ties in with the rest the cube and the percentages

	general UI automation:

		while it is very important it is not essential for the initial launch

	to a certain degree transition between the default ranking screen and the
	cube screen is important, we should tie in the main ranking with the miniature
	cube speaks for itself

	clicking:

	All clickable buttons are round, so the individual dimension buttons are
	also round.  To make them toggle up and down images are used (for lack of
	a better known way).
	-->
	<main
			class:offToRight="cubeView && !$verticalLayout"
			class:icon="!cubeView"
			class:full="cubeView"
			in:fly='{y:-200, x: 200, duration: 750, easing: elasticOut}'
	>
		<DetailedCube
				cubeView="{cubeView}"
				delta="{delta}"
				moveType="{moveType}"
				on:cubeAltered="pollAltered()"
				on:select="toggleView(cubeView, true)"
				poll="{poll}"
				positionMode="{positionMode}"
				verticalLayout="{verticalLayout}"
				zoomFactor="{cubeZoom}"
		></DetailedCube>
	</main>
	<div>
		<!--
				class:topLeft="cubeView && !$verticalLayout"
				-->
		<aside
				class:icon="cubeView"
				class:full="!cubeView"
		>
			{#if !cubeView}
			<FactorRanking
					closing="{beforeCubeView}"
					delta="{delta}"
					manualControls="{manualControls}"
					on:directionCorrected="pollAltered()"
					on:rankingAdjusted="pollAdjusted()"
					poll="{poll}"
					verticalLayout="{verticalLayout}"
					vote="{vote}"
			></FactorRanking>
			{/if}
		</aside>
	</div>
	{#if vote}
	{#if percentMode}
	<PercentPicker
			delta="{delta}"
			on:close="togglePercentPicker()"
			on:move="move(event)"
			on:moveToValue="moveToValue(event)"
			poll="{poll}"
			vote="{vote}"
	></PercentPicker>
	{:else}

	<VoteComponentGraph
			classes="mainView"
			cubeView="{cubeView}"
			delta="{dynamicDelta}"
			poll="{poll}"
			vote="{dynamicVote}"
	></VoteComponentGraph>
	{#if cubeView}
	<FactorRankingMiniature
			delta="{delta}"
			on:select="toggleView(cubeView, false)"
			poll="{poll}"
			vote="{vote}"
	></FactorRankingMiniature>
	{/if}
	<!--
			class="{$verticalLayout ? 'bottom-factor-table' : 'right-factor-table'}"
	-->
	<table
			class="bottom-factor-table"
			in:fly="{y: 200, delay: 800, duration: 1000}"
	>
		<tr>
			<!--			{#if $verticalLayout}-->
			<td
			>
				<FactorInfoButton
						axis='x'
						cubeView="{cubeView}"
						delta="{dynamicDelta}"
						mode="page"
						on:toggle="toggleSurface('x')"
						poll="{poll}"
						voteDim="{dynamicVote.x}"
				></FactorInfoButton>
			</td>
			<td
			>
				<FactorInfoButton
						axis='y'
						cubeView="{cubeView}"
						delta="{dynamicDelta}"
						mode="page"
						on:toggle="toggleSurface('y')"
						poll="{poll}"
						voteDim="{dynamicVote.y}"
				></FactorInfoButton>
			</td>
			<td>
				<FactorInfoButton
						axis='z'
						cubeView="{cubeView}"
						delta="{dynamicDelta}"
						mode="page"
						on:toggle="toggleSurface('z')"
						poll="{poll}"
						voteDim="{dynamicVote.z}"
				></FactorInfoButton>
			</td>
			<!--			{/if}-->
		</tr>
		<!--
		{#if !$verticalLayout}
		<tr>
			<td>
				<FactorInfoButton
						axis='z'
						delta="{delta}"
						mode="page"
						on:toggle="toggleSurface('z')"
						poll="{poll}"
						voteDim="{vote.z}"
				></FactorInfoButton>
			</td>
		</tr>
		<tr>
			<td>
				<FactorInfoButton
						axis='y'
						delta="{delta}"
						mode="page"
						on:toggle="toggleSurface('y')"
						poll="{poll}"
						voteDim="{vote.y}"
				></FactorInfoButton>
			</td>
		</tr>
		<tr>
			<td
			>
				<FactorInfoButton
						axis='x'
						delta="{delta}"
						mode="page"
						on:toggle="toggleSurface('x')"
						poll="{poll}"
						voteDim="{vote.x}"
				></FactorInfoButton>
			</td>
		</tr>
		{/if}
		-->
	</table>
	{/if}
	<PollFab
	>
	</PollFab>
	{#if confirm}
	{#if saving}
	<ActionPopover
			on:cancel="closeConfirm()"
			viewOnly="!error"
			infoOnly="error"
	>
		<div slot="header">
			{saving}
		</div>
		<div slot="content">
			{error}
		</div>
	</ActionPopover>
	{:elseif voting}
	<ActionPopover
			contentClass="smallPadding"
			on:cancel="closeConfirm()"
	>
		<div slot="header">
			Confirm Vote
		</div>
		<div slot="content">
			<div>
				{poll.name}
			</div>
			<VoteComponentSummary
					bind:delta
					bind:poll
					verticalLayout="Y"
					bind:vote
					maxBarSize="60"
					mode="confirm"
			></VoteComponentSummary>
		</div>
		<div slot="actions">
			<VoteButton
					on:select="vote()"
			></VoteButton>
		</div>
	</ActionPopover>
	{:else}
	<ActionPopover
			on:cancel="closeConfirm()"
	>
		<div slot="header">
			Please Confirm
		</div>
		<div slot="content">
			Create the "{poll.name}" poll?
		</div>
		<div slot="actions">
			<BuildButton
					on:select="build()"
			></BuildButton>
		</div>
	</ActionPopover>
	{/if}
	{/if}
	{/if}
	{#if $confirmAlter}
	<ActionPopover
			on:cancel="doNotAlter()"
	>
		<div slot="header">
			Alter Poll
		</div>
		<div slot="content">
			Alter this poll?
		</div>
		<div slot="actions">
			<AlterButton
					on:select="alter($routeParams)"
			></AlterButton>
		</div>
	</ActionPopover>
	{/if}
</article>
<style>
	@media (min-width: 62em) {
		article {
			width: 54%;
		}

		.bottom-factor-table {
			width: calc(54% - 140px) !important;
		}
	}

	article {
		position: absolute;
	}

	aside {
		/* position below the cube to make miniature cube clickable when in ranking view */
		/*z-index: -2; not relevant, icons are not clickable for simplicity*/
	}

	main {
		left: 50%;
		margin-right: -50%;
		position: absolute;
		top: 33%;
		transform: translate(-50%, -50%);
		/* position below other controls to main them clickable when in cubeView */
		/*z-index: -1; // not relevant icons are not clickable for simplicity*/
	}

	main.icon {
		height: 50px;
		left: initial;
		margin-right: initial;
		position: fixed;
		left: -10px;
		top: 40px;
		width: 50px;
		transform: initial;
	}

	/*
		main.icon.topLeft {
			position: fixed;
			left: -10px;
			top: 35px;
			z-index: 3;
		}
	*/

	aside.full {
		margin-top: 70px;
	}

	aside.icon {
		position: absolute;
	}

	table {
		z-index: 2;
	}

	.bottom-factor-table {
		bottom: 10px;
		color: black;
		margin-left: 70px;
		margin-right: 70px;
		position: fixed;
		width: calc(100% - 140px);
	}

	.leftViewport {
		right: 20%;
	}

	.offToRight {
		left: 33%;
	}

	.right-factor-table {
		height: calc(100% - 84px);
		margin-top: 20px;
		position: fixed;
		right: 75px;
		top: 44px;
	}

</style>

<script>
	import {DI}                 from '@airport/di'
	import {
		POLL_DAO,
		VOTE_DAO
	}                           from '@votecube/public-db'
	import {fly}                from 'svelte-transitions'
	import AlterButton          from '../../../common/control/button/AlterButton.html'
	import BuildButton          from '../../../common/control/button/BuildButton.html'
	import EditButton           from '../../../common/control/button/EditButton.html'
	import FactorInfoButton
	                            from '../../../common/control/button/FactorInfoButton.html'
	import VoteButton           from '../../../common/control/button/VoteButton.html'
	import PercentPicker        from '../../../common/control/PercentPicker.html'
	import ActionPopover        from '../../../common/shell/ActionPopover.html'
	import DetailedCube         from '../../../components/poll/DetailedCube.html'
	import FactorRanking        from '../../../components/poll/FactorRanking.html'
	import FactorRankingMiniature
	                            from '../../../components/poll/FactorRankingMiniature.html'
	import PollFab              from '../../../components/poll/PollFab.html'
	import VoteComponentGraph   from '../../../components/vote/VoteComponentGraph.html'
	import VoteComponentSummary from '../../../components/vote/VoteComponentSummary.html'

	import {setupCubeView}   from '../../../database'
	import {
		setCubeAdjustment,
		shutDownCubeListener
	}                        from '../../../libs/cubeLogic'
	import {setResizeCllBck} from '../../../resizer'
	import * as routes       from '../../../routes'
	import store             from '../../../store'

	export default {
		components: {
			ActionPopover,
			AlterButton,
			BuildButton,
			DetailedCube,
			EditButton,
			FactorInfoButton,
			FactorRanking,
			FactorRankingMiniature,
			PercentPicker,
			PollFab,
			VoteButton,
			VoteComponentGraph,
			VoteComponentSummary
		},
		computed: {
			choiceRankingZoom: ({cubeView, miniatureScale, zoomFactor}) =>
				cubeView ? miniatureScale * zoomFactor : 1,
			cubeZoom: ({cubeView, miniatureScale, zoomFactor}) =>
				cubeView ? zoomFactor : miniatureScale * zoomFactor,
			dirPosButtonColor: ({positionMode}) => positionMode
				? '0b0'
				: '000',
			dynamicVote: ({cubeView, currentVote, vote}) =>
				cubeView ? vote : currentVote,
			dynamicDelta: ({cubeView, delta, factorDelta}) =>
				cubeView ? delta : factorDelta,
			manualControls: ({cubeView, manualControlsOn}) =>
				cubeView ? false : manualControlsOn,
			previewMode: ({$mode}) => $mode === 'build' || $mode === 'alter',
			// modifyActionButtonPosition: ({$verticalLayout}) => $verticalLayout
			// 	? 'bottomLeft'
			// 	: 'bottomRight',
			// submitButtonPosition: ({$verticalLayout}) => $verticalLayout
			// 	? 'bottomRight'
			// 	: 'topRight',
		},
		data() {
			return {
				cubeView: false,
				currentVote: {
					x: {
						value: 0,
						dir: 0
					},
					y: {
						value: 0,
						dir: 0
					},
					z: {
						value: 0,
						dir: 0
					}
				},
				delta: 0,
				factorDelta: 0, // Only for the factor cubes
				manualControlsOn: true,
				miniatureScale: 0.2,
				percentMode: false,
				verticalLayout: true,
				zoomFactor: 0.65
			}
		},
		methods: {
			alter($routeParams) {
				this.store.set({confirmAlter: false})
				routes.navigateToPage(routes.POLL_INFO_MAIN, {
					...$routeParams,
					mode: 'alter'
				})
			},
			confirmAlter(event) {
				this.store.set({confirmAlter: true})
			},
			doNotAlter() {
				this.store.set({confirmAlter: false})
			},
			build() {
				save(this)
			},
			checkBuild() {
				this.set({confirm: true, error: '', saving: false, voting: false})
			},
			closeConfirm() {
				setCubeAdjustment(this.get().cubeListener, true)
				this.set({confirm: false})
			},
			confirmVote() {
				setCubeAdjustment(this.get().cubeListener, false)
				this.set({confirm: true, error: '', saving: false, voting: true})
			},
			pollAltered() {
				const {delta} = this.get()
				this.set({delta: delta + 1})
			},
			pollAdjusted() {
				this.pollAltered()
				this.get().mutationApi.recompute()
			},
			move(
				event
			) {
				this.get().mutationApi.move(
					event.factor,
					event.position,
					event.percentChange
				)
			},
			moveToValue(
				event
			) {
				this.get().mutationApi.moveToValue(event.factor, event.value)
			},
			toggleManualControls() {
				this.set({manualControlsOn: !this.get().manualControlsOn})
			},
			togglePercentPicker() {
				const percentMode = !this.get().percentMode
				setCubeAdjustment(this.get().cubeListener, !percentMode)
				this.set({percentMode})
			},
			togglePositionMode() {
				let positionMode = !this.get().positionMode
				let cubeView     = positionMode ? true : this.get().cubeView
				this.set({cubeView, positionMode})
			},
			toggleSurface(
				factorKey
			) {
				const {cubeView, delta, moveType, mutationApi} = this.get()
				this.set({moveType: 'toggle'})
				setTimeout(() => {
					mutationApi.toggleSurface(factorKey)
					this.set({delta: delta + 1})
					setTimeout(() => {
						this.set({moveType})
					}, 500)
				}, 1)
			},
			toggleView(
				currentlyInCubeView,
				forCubeView,
			) {
				toggleView(currentlyInCubeView, forCubeView, this)
			},
			toPollForm(
				$routeParams
			) {
				routes.navigateToPage(routes.POLL_INFO_MAIN, $routeParams)
			},
			vote() {
				vote(this)
			}
		},
		oncreate() {
			const {mode, pollId} = this.store.get().routeParams

			resize(this)
			setupCubeView(pollId, this).then(() => {
				toggleView(!this.get().cubeView, this.get().cubeView, this)
			})
			this.store.set({
				cube: true,
				mode,
				noOverflow: true
			})
			this.stateListener = this.on('state', ({changed, current, previous}) => {
					if (current.cubeView
						|| !changed.delta
						|| !current.vote) {
						return
					}

					let currentVote = current.currentVote
					if (votesEqual(currentVote, current.vote)) {
						return
					}

					let lastVote = currentVote
					currentVote  = copyVoteToTween(current.vote)

					// Not needed, current vote is always set
					// if (!lastVote) {
					// 	this.set({currentVote})
					// 	return
					// }

					if (current.currentVoteInterval) {
						clearInterval(current.currentVoteInterval)
					}

					let currentVoteInterval = scheduleFactorTweens(
						lastVote,
						currentVote,
						this
					)
					this.set({currentVote, currentVoteInterval})
				}
			)
		},
		ondestroy() {
			setResizeCllBck(null)
			shutDownCubeListener(this.get().cubeListener, this)
			this.stateListener.cancel()
			this.store.set({
				cube: false,
				noOverflow: false
			})
		}
		,
		store: () => store,
		transitions:
			{
				fly
			}
	}

	function toggleView(
		currentlyInCubeView,
		forCubeView,
		page
	) {
		if (forCubeView) {
			if (!currentlyInCubeView) {
				// Animate Factor Rankings out of the view
				page.set({beforeCubeView: forCubeView})

				page.get().cubeListener.resumeInteraction()
				page.set({cubeView: forCubeView})
			}
		} else {
			if (currentlyInCubeView) {
				page.get().cubeListener.suspendInteraction()
				page.set({cubeView: forCubeView})
			}
		}
	}

	function resize(page) {
		setResizeCllBck((
			portalHeight,
			windowWidth
		) => {
			const figureHeight = portalHeight * 0.55 + 95

			const cubeAreaLeastFactor = windowWidth < figureHeight
				? windowWidth
				: figureHeight

			const zoomFactor = (Math.sqrt(cubeAreaLeastFactor) * 3) / 100

			page.set({zoomFactor})
		}, page.store)
	}

	async function save(
		page
	) {
		page.set({saving: 'Saving ...'})
		const pollDao = await DI.get(POLL_DAO)
		const poll    = page.get().poll
		try {
			await pollDao.save(poll, {})
			page.set({confirm: false})
			routes.navigateToPage(routes.POLL_SEARCH_LIST)
		} catch (error) {
			page.set({error, saving: 'Error'})
		}
	}

	async function vote(
		page
	) {
		// page.set({confirm: false})
		const voteDao = await DI.get(VOTE_DAO)
		try {
			await voteDao.save(page.get().poll)
			page.set({confirm: false})
			routes.navigateToPage(routes.POLL_SEARCH_LIST)
		} catch (error) {
			page.set({error, saving: 'Error'})
		}
	}

	function votesEqual(
		lastVote,
		vote
	) {
		return lastVote && vote
			&& lastVote.x.dir === vote.x.dir
			&& lastVote.y.dir === vote.y.dir
			&& lastVote.z.dir === vote.z.dir
			&& lastVote.x.value === vote.x.value
			&& lastVote.y.value === vote.y.value
			&& lastVote.z.value === vote.z.value
	}

	function copyVoteToTween(
		vote
	) {
		return {
			x: {
				value: vote.x.value,
				dir: vote.x.dir
			},
			y: {
				value: vote.y.value,
				dir: vote.y.dir
			},
			z: {
				value: vote.z.value,
				dir: vote.z.dir
			}
		}
	}

	function scheduleFactorTweens(
		oldVote,
		newVote,
		page
	) {
		const durationMills = 400
		// const durationMills    = 15000
		// const durationMills    = 300
		const numFrames        = Math.ceil(durationMills / 17)
		let numRemainingFrames = numFrames

		let config = {}
		config.x   = setupFactorTween('x', oldVote, newVote, numFrames)
		config.y   = setupFactorTween('y', oldVote, newVote, numFrames)
		config.z   = setupFactorTween('z', oldVote, newVote, numFrames)

		let intervalHandle = setInterval(() => {
			runFactorTween(config.x, numRemainingFrames)
			runFactorTween(config.y, numRemainingFrames)
			runFactorTween(config.z, numRemainingFrames)

			numRemainingFrames--
			if (!numRemainingFrames) {
				setFinalFactor(newVote.x, config.x)
				setFinalFactor(newVote.y, config.y)
				setFinalFactor(newVote.z, config.z)
				clearInterval(intervalHandle)
			}

			page.set({factorDelta: page.get().factorDelta + 1})
		}, 17)

		return intervalHandle
	}

	function setupFactorTween(
		axis,
		oldVote,
		newVote,
		numFrames
	) {

		const oldVoteFactor = oldVote[axis]
		const newVoteFactor = newVote[axis]

		const oldVoteValue = oldVoteFactor.value
		const newVoteValue = newVoteFactor.value

		let zeroValueFrameNumber     = 0
		let numNewDirFrames
		let numOldDirFrames          = 0
		let newDirFrameNumber        = 0
		let numRemainingOldDirFrames = 0
		if (oldVoteFactor.dir !== newVoteFactor.dir) {
			const valueDifference    = oldVoteValue + newVoteValue
			const oldVoteFraction    = oldVoteValue / valueDifference
			numOldDirFrames          = zeroValueFrameNumber = Math.ceil(numFrames * oldVoteFraction)
			numRemainingOldDirFrames = numOldDirFrames
			numNewDirFrames          = numFrames - numOldDirFrames
			newDirFrameNumber        = -numOldDirFrames
			newVoteFactor.factorDir  = oldVoteFactor.dir
		} else {
			numNewDirFrames         = numFrames
			newVoteFactor.factorDir = newVoteFactor.dir
		}

		return {
			newDirFrameNumber,
			newVoteFactor,
			newVoteValue,
			numNewDirFrames,
			numOldDirFrames,
			numRemainingOldDirFrames,
			oldVoteFactor,
			oldVoteValue,
			zeroValueFrameNumber
		}
	}

	function runFactorTween(
		config,
		numRemainingFrames
	) {
		config.newDirFrameNumber++

		const {
			      newDirFrameNumber,
			      newVoteFactor,
			      newVoteValue,
			      numNewDirFrames,
			      numOldDirFrames,
			      numRemainingOldDirFrames,
			      oldVoteFactor,
			      oldVoteValue,
			      zeroValueFrameNumber
		      } = config

		if (zeroValueFrameNumber) {
			if (newVoteFactor.dir
				&& numRemainingFrames === zeroValueFrameNumber) {
				newVoteFactor.factorValue = 0
				newVoteFactor.factorDir   = newVoteFactor.dir
			} else if (!newVoteFactor.dir
				|| numRemainingFrames > zeroValueFrameNumber) {
				// Always go here if the factor is being removed (dir === 0)
				newVoteFactor.factorValue = Math.floor(oldVoteValue / numOldDirFrames * numRemainingOldDirFrames)
				newVoteFactor.factorDir   = oldVoteFactor.dir
			} else {
				newVoteFactor.factorValue = Math.floor(newVoteValue / numNewDirFrames * newDirFrameNumber)
				newVoteFactor.factorDir   = newVoteFactor.dir
			}
		} else {
			const factorValue         = oldVoteValue + ((newVoteValue - oldVoteValue) / numNewDirFrames * newDirFrameNumber)
			newVoteFactor.factorValue = newVoteValue > oldVoteValue ? Math.floor(factorValue) : Math.ceil(factorValue)
			newVoteFactor.factorDir   = newVoteFactor.dir
		}

		config.numRemainingOldDirFrames--
	}

	function setFinalFactor(
		newVoteAxis,
		axisConfig
	) {
		// if(!newVoteFactor.dir) {
		newVoteAxis.factorDir   = axisConfig.newVoteFactor.dir
		// }
		newVoteAxis.factorValue = axisConfig.newVoteFactor.value
	}

</script>
