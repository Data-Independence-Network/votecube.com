<article>
	<!--
			class:topLeft="!cubeView && !$verticalLayout"
			-->
	<main
			class:offToRight="cubeView && !$verticalLayout"
			class:icon="!cubeView"
			class:full="cubeView"
			on:click="toggleView(cubeView, true)"
			in:fly='{y:-200, x: 200, duration: 750, easing: elasticOut}'
	>
		<DetailedCube
				delta="{delta}"
				on:cubeAltered="pollAltered()"
				poll="{poll}"
				positionMode="{positionMode}"
				verticalLayout="{verticalLayout}"
				zoomFactor="{cubeZoom}"
		></DetailedCube>
	</main>
	<div>
		<!--
				class:topLeft="cubeView && !$verticalLayout"
				-->
		<aside
				class:icon="cubeView"
				class:full="!cubeView"
		>
			<ChoiceRanking
					delta="{delta}"
					iconMode="{cubeView}"
					manualControls="{manualControls}"
					on:directionCorrected="pollAltered()"
					on:rankingAdjusted="pollAdjusted()"
					on:select="toggleView(cubeView, false)"
					poll="{poll}"
					verticalLayout="{verticalLayout}"
					vote="{vote}"
					zoomFactor="{choiceRankingZoom}"
			></ChoiceRanking>
		</aside>
	</div>
	{#if vote}
	{#if percentMode}
	<PercentPicker
			delta="{delta}"
			on:close="togglePercentPicker()"
			on:move="move(event)"
			on:moveToValue="moveToValue(event)"
			poll="{poll}"
			vote="{vote}"
	></PercentPicker>
	{:else}
	<!--
			class="{$verticalLayout ? 'bottom-factor-table' : 'right-factor-table'}"
	-->
	<table
			class="bottom-factor-table"
			in:fly="{y: 200, delay: 800, duration: 1000}"
	>
		<tr>
			<!--			{#if $verticalLayout}-->
			<td
			>
				<FactorInfoButton
						axis='x'
						delta="{delta}"
						mode="page"
						on:toggle="toggleSurface('x')"
						poll="{poll}"
						voteDim="{vote.x}"
				></FactorInfoButton>
			</td>
			<td
			>
				<FactorInfoButton
						axis='y'
						delta="{delta}"
						mode="page"
						on:toggle="toggleSurface('y')"
						poll="{poll}"
						voteDim="{vote.y}"
				></FactorInfoButton>
			</td>
			<td>
				<FactorInfoButton
						axis='z'
						delta="{delta}"
						mode="page"
						on:toggle="toggleSurface('z')"
						poll="{poll}"
						voteDim="{vote.z}"
				></FactorInfoButton>
			</td>
			<!--			{/if}-->
		</tr>
		<!--
		{#if !$verticalLayout}
		<tr>
			<td>
				<FactorInfoButton
						axis='z'
						delta="{delta}"
						mode="page"
						on:toggle="toggleSurface('z')"
						poll="{poll}"
						voteDim="{vote.z}"
				></FactorInfoButton>
			</td>
		</tr>
		<tr>
			<td>
				<FactorInfoButton
						axis='y'
						delta="{delta}"
						mode="page"
						on:toggle="toggleSurface('y')"
						poll="{poll}"
						voteDim="{vote.y}"
				></FactorInfoButton>
			</td>
		</tr>
		<tr>
			<td
			>
				<FactorInfoButton
						axis='x'
						delta="{delta}"
						mode="page"
						on:toggle="toggleSurface('x')"
						poll="{poll}"
						voteDim="{vote.x}"
				></FactorInfoButton>
			</td>
		</tr>
		{/if}
		-->
	</table>
	{/if}
	<Fab
	>
	</Fab>
	{#if confirm}
	{#if saving}
	<ActionPopover
			on:cancel="closeConfirm()"
			viewOnly="!error"
			infoOnly="error"
	>
		<div slot="header">
			{saving}
		</div>
		<div slot="content">
			{error}
		</div>
	</ActionPopover>
	{:elseif voting}
	<ActionPopover
			contentClass="smallPadding"
			on:cancel="closeConfirm()"
	>
		<div slot="header">
			Confirm Vote
		</div>
		<div slot="content">
			<div>
				{poll.name}
			</div>
			<VoteComponentGraph
					bind:delta
					bind:poll
					verticalLayout="Y"
					bind:vote
					maxBarSize="60"
					mode="confirm"
			></VoteComponentGraph>
		</div>
		<div slot="actions">
			<VoteButton
					on:select="vote()"
			></VoteButton>
		</div>
	</ActionPopover>
	{:else}
	<ActionPopover
			on:cancel="closeConfirm()"
	>
		<div slot="header">
			Please Confirm
		</div>
		<div slot="content">
			Create the "{poll.name}" poll?
		</div>
		<div slot="actions">
			<BuildButton
					on:select="build()"
			></BuildButton>
		</div>
	</ActionPopover>
	{/if}
	{/if}
	{/if}
	{#if $confirmAlter}
	<ActionPopover
			on:cancel="doNotAlter()"
	>
		<div slot="header">
			Alter Poll
		</div>
		<div slot="content">
			Alter this poll?
		</div>
		<div slot="actions">
			<AlterButton
					on:select="alter($routeParams)"
			></AlterButton>
		</div>
	</ActionPopover>
	{/if}
</article>
<style>
	@media (min-width: 62em) {
		article {
			width: 54%;
		}

		.bottom-factor-table {
			width: calc(54% - 140px) !important;
		}
	}

	article {
		position: absolute;
	}

	main {
		left: 50%;
		margin-right: -50%;
		position: absolute;
		top: 33%;
		transform: translate(-50%, -50%);
	}

	main.icon {
		height: 50px;
		left: initial;
		margin-right: initial;
		position: fixed;
		right: 35px;
		top: 40px;
		width: 50px;
		transform: initial;
	}

	/*
		main.icon.topLeft {
			position: fixed;
			left: -10px;
			top: 35px;
			z-index: 3;
		}
	*/

	aside.full {
		margin-top: 70px;
	}

	aside.icon {
		position: absolute;
	}

	table {
		z-index: 2;
	}

	.bottom-factor-table {
		bottom: 10px;
		color: black;
		margin-left: 70px;
		margin-right: 70px;
		position: fixed;
		width: calc(100% - 140px);
	}

	.leftViewport {
		right: 20%;
	}

	.offToRight {
		left: 33%;
	}

	.right-factor-table {
		height: calc(100% - 84px);
		margin-top: 20px;
		position: fixed;
		right: 75px;
		top: 44px;
	}

</style>

<script>
	import {DI}               from '@airport/di'
	import {
		POLL_DAO,
		VOTE_DAO
	}                         from '@votecube/public-db'
	import {fly}              from 'svelte-transitions'
	import AlterButton        from '../../../common/control/button/AlterButton.html'
	import BuildButton        from '../../../common/control/button/BuildButton.html'
	import EditButton         from '../../../common/control/button/EditButton.html'
	import FactorInfoButton   from '../../../common/control/button/FactorInfoButton.html'
	import VoteButton         from '../../../common/control/button/VoteButton.html'
	import PercentPicker      from '../../../common/control/PercentPicker.html'
	import ActionPopover      from '../../../common/shell/ActionPopover.html'
	import ChoiceRanking      from '../../../components/poll/ChoiceRanking.html'
	import DetailedCube       from '../../../components/poll/DetailedCube.html'
	import Fab                from '../../../components/poll/Fab.html'
	import VoteComponentGraph from '../../../components/vote/VoteComponentGraph.html'

	import {setupCubeView}   from '../../../database'
	import {
		setCubeAdjustment,
		shutDownCubeListener
	}                        from '../../../libs/cubeLogic'
	import {setResizeCllBck} from '../../../resizer'
	import * as routes       from '../../../routes'
	import store             from '../../../store'

	export default {
		components: {
			ActionPopover,
			AlterButton,
			BuildButton,
			ChoiceRanking,
			DetailedCube,
			EditButton,
			Fab,
			FactorInfoButton,
			PercentPicker,
			VoteButton,
			VoteComponentGraph
		},
		computed: {
			choiceRankingZoom: ({cubeView, miniatureScale, zoomFactor}) =>
				cubeView ? miniatureScale * zoomFactor : 1,
			cubeZoom: ({cubeView, miniatureScale, zoomFactor}) =>
				cubeView ? zoomFactor : miniatureScale * zoomFactor,
			dirPosButtonColor: ({positionMode}) => positionMode
				? '0b0'
				: '000',
			previewMode: ({$mode}) => $mode === 'build' || $mode === 'alter',
			// modifyActionButtonPosition: ({$verticalLayout}) => $verticalLayout
			// 	? 'bottomLeft'
			// 	: 'bottomRight',
			// submitButtonPosition: ({$verticalLayout}) => $verticalLayout
			// 	? 'bottomRight'
			// 	: 'topRight',
		},
		data() {
			return {
				cubeView: false,
				delta: 0,
				manualControls: true,
				miniatureScale: 0.2,
				percentMode: false,
				verticalLayout: true,
				zoomFactor: 0.65
			}
		},
		methods: {
			alter($routeParams) {
				this.store.set({confirmAlter: false})
				routes.navigateToPage(routes.POLL_INFO_MAIN, {
					...$routeParams,
					mode: 'alter'
				})
			},
			confirmAlter(event) {
				this.store.set({confirmAlter: true})
			},
			doNotAlter() {
				this.store.set({confirmAlter: false})
			},
			build() {
				save(this)
			},
			checkBuild() {
				this.set({confirm: true, error: '', saving: false, voting: false})
			},
			closeConfirm() {
				setCubeAdjustment(this.get().cubeListener, true)
				this.set({confirm: false})
			},
			confirmVote() {
				setCubeAdjustment(this.get().cubeListener, false)
				this.set({confirm: true, error: '', saving: false, voting: true})
			},
			pollAltered() {
				const {delta} = this.get()
				this.set({delta: delta + 1})
			},
			pollAdjusted() {
				this.pollAltered()
				this.get().mutationApi.recompute()
			},
			move(
				event
			) {
				this.get().mutationApi.move(
					event.factor,
					event.position,
					event.percentChange
				)
			},
			moveToValue(
				event
			) {
				this.get().mutationApi.moveToValue(event.factor, event.value)
			},
			toggleManualControls() {
				this.set({manualControls: !this.get().manualControls})
			},
			togglePercentPicker() {
				const percentMode = !this.get().percentMode
				setCubeAdjustment(this.get().cubeListener, !percentMode)
				this.set({percentMode})
			},
			togglePositionMode() {
				let positionMode = !this.get().positionMode
				let cubeView     = positionMode ? true : this.get().cubeView
				this.set({cubeView, positionMode})
			},
			toggleSurface(
				factorKey
			) {
				this.get().mutationApi.toggleSurface(factorKey)
				this.set({delta: this.get().delta + 1})
			},
			toggleView(
				currentlyInCubeView,
				forCubeView,
			) {
				toggleView(currentlyInCubeView, forCubeView, this)
			},
			toPollForm(
				$routeParams
			) {
				routes.navigateToPage(routes.POLL_INFO_MAIN, $routeParams)
			},
			vote() {
				vote(this)
			}
		},
		oncreate() {
			const {mode, pollId} = this.store.get().routeParams

			resize(this)
			setupCubeView(pollId, this).then(() => {
				toggleView(!this.get().cubeView, this.get().cubeView, this)
			})
			this.store.set({
				cube: true,
				mode,
				noOverflow: true
			})
		},
		ondestroy() {
			setResizeCllBck(null)
			shutDownCubeListener(this.get().cubeListener, this)
			this.store.set({
				cube: false,
				noOverflow: false
			})
		},
		store: () => store,
		transitions: {fly}
	}

	function toggleView(
		currentlyInCubeView,
		forCubeView,
		page
	) {
		if (forCubeView) {
			if (!currentlyInCubeView) {
				page.get().cubeListener.resumeInteraction()
				page.set({cubeView: forCubeView})
			}
		} else {
			if (currentlyInCubeView) {
				page.get().cubeListener.suspendInteraction()
				page.set({cubeView: forCubeView})
			}
		}
	}

	function resize(page) {
		setResizeCllBck((
			portalHeight,
			windowWidth
		) => {
			const figureHeight = portalHeight * 0.55 + 95

			const cubeAreaLeastFactor = windowWidth < figureHeight
				? windowWidth
				: figureHeight

			const zoomFactor = (Math.sqrt(cubeAreaLeastFactor) * 3) / 100

			page.set({zoomFactor})
		}, page.store)
	}

	async function save(
		page
	) {
		page.set({saving: 'Saving ...'})
		const pollDao = await DI.get(POLL_DAO)
		const poll    = page.get().poll
		try {
			await pollDao.save(poll, {})
			page.set({confirm: false})
			routes.navigateToPage(routes.POLL_SEARCH_LIST)
		} catch (error) {
			page.set({error, saving: 'Error'})
		}
	}

	async function vote(
		page
	) {
		// page.set({confirm: false})
		const voteDao = await DI.get(VOTE_DAO)
		try {
			await voteDao.save(page.get().poll)
			page.set({confirm: false})
			routes.navigateToPage(routes.POLL_SEARCH_LIST)
		} catch (error) {
			page.set({error, saving: 'Error'})
		}
	}

</script>
