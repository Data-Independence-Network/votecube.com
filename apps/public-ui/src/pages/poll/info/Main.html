{#if form}
<form>
	<legend>Create Poll</legend>
	<Text
			field="{form.fields.name}"
	></Text>
	<div class="pure-control-group">
		<AutoComplete
				field="{form.fields.theme}"
		></AutoComplete>
	</div>
	<div
			class="outcomes"
	>
		<div
				class="A"
		>
			<CharacterButton
					character="A"
					fontSize="20"
					fontX="12"
					fontY="19"
					size="24"
					strokeWidth="1"
			></CharacterButton>
			<TextArea
					field="{form.fields.outcomes.fields.A}"
					floatLabel="{false}"
					mid="{false}"
					mini="{true}"
			></TextArea>
		</div>
		<div
				class="B"
		>
			<CharacterButton
					character="B"
					fontSize="20"
					fontX="12"
					fontY="19"
					size="24"
					strokeWidth="1"
			></CharacterButton>
			<TextArea
					field="{form.fields.outcomes.fields.B}"
					floatLabel="{false}"
					mid="{false}"
					mini="{true}"
			></TextArea>
		</div>
	</div>
	<!--
	<div class="pure-control-group">
		<MultiSelect
				field="{form.fields.labels}"
		></MultiSelect>
	</div>
	<IconBlock
			fieldGroup="{form.fields.locations}"
			on:select="selectLocations($routeParams)"
	>
		<div slot="icon">
			<LocationIcon
					width="42"
			></LocationIcon>
		</div>
		<div slot="text">
			{#if locations && locations.touched}
			{#if continents.length}
			{#if countries.length}
			{#if states.length}
			{#if cities.length}
			Cities:
			<br>
			{getArrayValueTexts(cities)}
			<br>
			<br>
			{/if}
			States:
			<br>
			{getArrayValueTexts(states)}
			<br>
			<br>
			{/if}
			Countries:
			<br>
			{getArrayValueTexts(countries)}
			<br>
			<br>

			{/if}
			Continents:
			<br>
			{getArrayValueTexts(continents)}
			{:else}
			Select Geography
			{/if}
			{:else}
			Select Geography
			{/if}
		</div>
	</IconBlock>

	<IconBlock
			fieldGroup="{form.fields.timeframe}"
			on:select="selectTimeframe($routeParams)"
	>
		<div slot="icon">
			<TimeIcon></TimeIcon>
		</div>
		<div slot="text">
			{#if timeframe && timeframe.touched}
			<table
					class="timeframe"
			>
				<tr>
					<td>
						Start Date:
					</td>
					<td>
						{getDate(timeframe.fields.startDate.value)}
					</td>
				</tr>
				<tr>
					<td>
						End Date:
					</td>
					<td>
						{getDate(timeframe.fields.endDate.value)}
					</td>
				</tr>
			</table>
			{:else}
			Select Time-frame
			{/if}
		</div>
	</IconBlock>
	-->
	<SelectionBlock
			factor="{form.fields.factors.fields.first}"
			text="{form.fields.factors.text.first}"
			on:select="selectFactor(form.fields.factors.fields.first, $routeParams)"
	></SelectionBlock>
	<SelectionBlock
			factor="{form.fields.factors.fields.second}"
			text="{form.fields.factors.text.second}"
			on:select="selectFactor(form.fields.factors.fields.second, $routeParams)"
	></SelectionBlock>
	<SelectionBlock
			factor="{form.fields.factors.fields.third}"
			text="{form.fields.factors.text.third}"
			on:select="selectFactor(form.fields.factors.fields.third, $routeParams)"
	></SelectionBlock>
	<nav class="pure-controls">
		<PreviewButton
				classes="submitButton"
				highlightColor="{submitHighlight}"
				on:select="submit($routeParams, modified)"
		></PreviewButton>
	</nav>
</form>
{#if invalidAlter}
<ActionPopover
		on:cancel="ack()"
		infoOnly="Y"
>
	<div slot="header">
		Error
	</div>
	<div slot="content">
		Please make a modification.
	</div>
</ActionPopover>
{/if}
{/if}

<style>

	legend {
		display: none;
	}

	.A, .B {
		flex-basis: 100%;
		text-align: center;
	}

	.B {
		margin-left: 0.4em;
	}

	.outcomes {
		display: flex;
		margin-top: 10px;
		width: 100%;
	}

	.timeframe td {
		padding: 5px;
	}

	.timeframe td:first-child {
		text-align: right;
	}

	.timeframe td:nth-child(2) {
		text-align: left;
	}

</style>

<script>
	import CharacterButton          from '../../../common/control/button/CharacterButton.html'
	import PreviewButton            from '../../../common/control/button/PreviewButton.html'
	import AutoComplete             from '../../../common/field/AutoComplete.html'
	import IconBlock                from '../../../common/field/IconBlock.html'
	import MultiSelect              from '../../../common/field/MultiSelect.html'
	import Text                     from '../../../common/field/Text.html'
	import TextArea                 from '../../../common/field/TextArea.html'
	import LocationIcon             from '../../../common/icon/LocationIcon.html'
	import TimeIcon                 from '../../../common/icon/TimeIcon.html'
	import ActionPopover            from '../../../common/shell/ActionPopover.html'
	import SelectionBlock           from '../../../components/factor/SelectionBlock.html'
	import * as formCache           from '../../../form/cache'
	import * as forms               from '../../../form/forms'
	import * as pollFormCreator     from '../../../form/poll/creator'
	import * as pollFormToConverter from '../../../form/poll/toConverter'
	import {
		getArrayValueTexts,
		getDate
	}                               from '../../../helpers/general'
	import {PollStore}              from '../../../helpers/PollStore'
	import {loadForms}              from '../../../libs/forms'
	import * as routes              from '../../../routes'
	import store                    from '../../../store'

	export default {
		components: {
			ActionPopover,
			AutoComplete,
			CharacterButton,
			IconBlock,
			LocationIcon,
			MultiSelect,
			PreviewButton,
			SelectionBlock,
			Text,
			TextArea,
			TimeIcon
		},
		computed: {
			form: ({$pollStore}) => PollStore.currentVariation().form,
			// cities: ({form}) => form ? form.fields.locations.fields.cities.value : [],
			// continents: ({form}) => form ? form.fields.locations.fields.continents.value : [],
			// countries: ({form}) => form ? form.fields.locations.fields.countries.value : [],
			// locations: ({form}) => form ? form.fields.locations : null,
			modified: ({$routeParams, isOriginal, form}) => {
				if (!form
					|| $routeParams.mode !== 'alter'
					|| isOriginal) {
					return false
				}
				return !form.isOriginal()
			},
			/*
			factorsModified: ({$routeParams, isOriginal, form}) => {
				if (!form
					|| $routeParams.mode !== 'alter'
					|| isOriginal) {
					return false
				}
				return !form.fields.factors.isOriginal()
			},
			*/
			/*
locationOrTimeframeModified: ({$routeParams, isOriginal, form}) => {
	if (!form
		|| $routeParams.mode !== 'alter'
		|| isOriginal) {
		return false
	}
	return !form.fields.locations.isOriginal()
		|| !form.fields.timeframe.isOriginal()
},
 */
			name: ({test}) => true,
			// states: ({form}) => form ? form.fields.locations.fields.states.value : [],
			submitHighlight: ({
				                  $routeParams,
				                  modified,
				                  isValid
			                  }) => {
				if (!isValid) {
					return 'b00'
				}
				if ($routeParams.mode !== 'alter') {
					return '0b0'
				}

				return modified
					? '0b0'
					: 'b00'
			},
			// timeframe: ({form}) => form ? form.fields.timeframe : null
		},
		data() {
			return {
				poll: {
					name: ''
				}
			}
		},
		helpers: {
			getArrayValueTexts,
			getDate,
		},
		methods: {
			ack() {
				this.set({invalidAlter: false})
			},
			selectFactor(
				factorForm,
				$routeParams
			) {
				this.set({interFormNavigation: true})
				forms.setForm(forms.CREATE_FACTOR, factorForm)
				routes.navigateToPage(routes.FACTOR_INFO_MAIN, $routeParams)
			},
			selectLocations(
				$routeParams
			) {
				// this.set({keepPollId: $routeParams.pollId})
				routes.navigateToPage(routes.POLL_LOCATIONS, $routeParams)
			},
			selectTimeframe(
				$routeParams
			) {
				// this.set({keepPollId: $routeParams.pollId})
				routes.navigateToPage(routes.POLL_TIMEFRAME, $routeParams)
			},
			submit(
				$routeParams,
				modified
			) {
				const form = PollStore.currentVariation().form
				form.touch()

				if (!form.valid) {
					return
				}

				if (
					$routeParams.mode === 'alter'
					&& !modified) {
					this.set({invalidAlter: true})
					return
				}

				forms.navigateOnValid(this, routes.POLL_INFO_CUBE, $routeParams)
			}
		},
		oncreate() {
			initPage(this)
		},
		ondestroy() {
			formCache.savePollForm(this).then()
			forms.clearForm(this)
		},
		store: () => store
	}

	async function initPage(page) {
		const [
			      {ColorField, DateField, Field, FieldGroup, MatchingField, OptionsField, Validators},
			      // locations,
			      // _,
			      // [
			      // labelDao,
			      // pollDao
			      // , voteDao
			      // ]
		      ] = await Promise.all([
			loadForms(page),
			// loadLocations(),
			// loadLocText(page.store, 'en-us'),
			/*			DI.get(
							// FIXME: add PollStore to di
							// POLL_STORE
						)*/
		])

		// let labels = await labelDao.getAll()

		let form = forms.getForm(forms.CREATE_POLL_TOP)

		const {text} = page.store.get()

		if (!form) {
			const {mode} = formCache.getPollRouteParams(page)

			let currentVariation
			try {
				currentVariation = PollStore.currentVariation()
				if (!currentVariation.ui && mode !== 'build') {
					routes.navigateToPage(routes.POLL_LIST)
					return
				}
			} catch (error) {
				page.set({error})
				return
			}

			form = pollFormCreator.createPollForm(
				// labels,
				// locations,
				text.UI,
				ColorField,
				DateField,
				Field,
				FieldGroup,
				MatchingField,
				OptionsField,
				Validators)
			form.setTrackOriginal(mode === 'alter')
			form.validate()
			forms.setForm(forms.CREATE_POLL_TOP, form)
			currentVariation.form = form

			// form.fields.locations.optionText = text.LOCATIONS
			if (currentVariation.ui) {
				form.setValue(pollFormToConverter.dtoToForm(currentVariation.ui), !currentVariation.ui.draft)
				form.validate()
				if (mode !== 'create') {
					form.touch()
				}
			}
		}

		forms.ensureForm(form, page)

		page.store.set({
			pageTitle: 'Poll Info',
			// positionMap
		})
	}


</script>
