{#if form}
<form>
    <legend>Create Poll</legend>
    <Text
            field="{form.fields.name}"
    ></Text>
    <div class="pure-control-group">
        <AutoComplete
                field="{form.fields.theme}"
        ></AutoComplete>
    </div>
    <div class="pure-control-group">
        <MultiSelect
                field="{form.fields.labels}"
        ></MultiSelect>
    </div>
    <IconBlock
            fieldGroup="{form.fields.locations}"
            on:select="selectLocations($routeParams)"
    >
        <div slot="icon">
            <LocationIcon
                    width="42"
            ></LocationIcon>
        </div>
        <div slot="text">
            {#if locations && locations.touched}
            {#if continents.length}
            {#if countries.length}
            {#if states.length}
            {#if cities.length}
            <!-- TODO: cleanup -->
            Cities:
            <br>
            {getArrayValueTexts(cities)}
            <br>
            <br>
            {/if}
            <!-- TODO: cleanup -->
            States:
            <br>
            {getArrayValueTexts(states)}
            <br>
            <br>
            {/if}
            <!-- TODO: cleanup -->
            Countries:
            <br>
            {getArrayValueTexts(countries)}
            <br>
            <br>

            {/if}
            <!-- TODO: cleanup -->
            Continents:
            <br>
            {getArrayValueTexts(continents)}
            {:else}
            <!-- TODO: cleanup -->
            Select Geography
            {/if}
            {:else}
            <!-- TODO: cleanup -->
            Select Geography
            {/if}
        </div>
    </IconBlock>
    <IconBlock
            fieldGroup="{form.fields.timeframe}"
            on:select="selectTimeframe($routeParams)"
    >
        <div slot="icon">
            <TimeIcon></TimeIcon>
        </div>
        <div slot="text">
            {#if timeframe && timeframe.touched}
            <table
                    class="timeframe"
            >
                <tr>
                    <td>
                        Start Date:
                    </td>
                    <td>
                        {getDate(timeframe.fields.startDate.value)}
                    </td>
                </tr>
                <tr>
                    <td>
                        End Date:
                    </td>
                    <td>
                        {getDate(timeframe.fields.endDate.value)}
                    </td>
                </tr>
            </table>
            {:else}
            Select Time-frame
            {/if}
        </div>
    </IconBlock>
    <SelectionBlock
            factor="{form.fields.factors.fields.first}"
            text="{form.fields.factors.text.first}"
            on:select="selectFactor(form.fields.factors.fields.first, $routeParams)"
    ></SelectionBlock>
    <SelectionBlock
            factor="{form.fields.factors.fields.second}"
            text="{form.fields.factors.text.second}"
            on:select="selectFactor(form.fields.factors.fields.second, $routeParams)"
    ></SelectionBlock>
    <SelectionBlock
            factor="{form.fields.factors.fields.third}"
            text="{form.fields.factors.text.third}"
            on:select="selectFactor(form.fields.factors.fields.third, $routeParams)"
    ></SelectionBlock>
    <nav class="pure-controls">
        <PreviewButton
                classes="submitButton"
                highlightColor="{submitHighlight}"
                on:select="submit($routeParams, factorsModified, locationOrTimeframeModified)"
        ></PreviewButton>
    </nav>
</form>
{#if invalidAlter}
<ActionPopover
        on:cancel="ack()"
        infoOnly="Y"
>
    <div slot="header">
        Error
    </div>
    <div slot="content">
        Please modify either Location or Start/End dates or Factors to alter the poll.
    </div>
</ActionPopover>
{/if}
{/if}

<style>

    legend {
        display: none;
    }

    .timeframe td {
        padding: 5px;
    }

    .timeframe td:first-child {
        text-align: right;
    }

    .timeframe td:nth-child(2) {
        text-align: left;
    }

</style>

<script>
	import {DI}                           from '@airport/di'
	import {VOTE_DAO}                     from '@votecube/public-db'
	import PreviewButton                  from '../../../common/control/button/PreviewButton.html'
	import AutoComplete                   from '../../../common/field/AutoComplete.html'
	import IconBlock                      from '../../../common/field/IconBlock.html'
	import MultiSelect                    from '../../../common/field/MultiSelect.html'
	import Text                           from '../../../common/field/Text.html'
	import LocationIcon                   from '../../../common/icon/LocationIcon.html'
	import TimeIcon                       from '../../../common/icon/TimeIcon.html'
	import ActionPopover                  from '../../../common/shell/ActionPopover.html'
	import SelectionBlock                 from '../../../components/factor/SelectionBlock.html'
	import {labelDao}                     from '../../../dao/label'
	import {pollDao}                      from '../../../dao/poll'
	import * as formCache                 from '../../../form/cache'
	import * as forms                     from '../../../form/forms'
	import * as pollFormCreator           from '../../../form/poll/creator'
	import * as pollFormToConverter       from '../../../form/poll/toConverter'
	import {
		getArrayValueTexts,
		getDate
	}                                     from '../../../helpers/general'
	import {loadForms}                    from '../../../libs/forms'
	import {loadLocations}                from '../../../libs/locations'
	import {loadLocations as loadLocText} from '../../../libs/text/locations'
	import * as routes                    from '../../../routes'
	import store                          from '../../../store'

	export default {
		components: {
			ActionPopover,
			AutoComplete,
			IconBlock,
			LocationIcon,
			MultiSelect,
			PreviewButton,
			SelectionBlock,
			Text,
			TimeIcon
		},
		computed: {
			cities: ({form}) => form ? form.fields.locations.fields.cities.value : [],
			continents: ({form}) => form ? form.fields.locations.fields.continents.value : [],
			countries: ({form}) => form ? form.fields.locations.fields.countries.value : [],
			locations: ({form}) => form ? form.fields.locations : null,
			factorsModified: ({$routeParams, isOriginal, form}) => {
				if (!form
					|| $routeParams.mode !== 'alter'
					|| isOriginal) {
					return false
				}
				return !form.fields.factors.isOriginal()
			},
			locationOrTimeframeModified: ({$routeParams, isOriginal, form}) => {
				if (!form
					|| $routeParams.mode !== 'alter'
					|| isOriginal) {
					return false
				}
				return !form.fields.locations.isOriginal()
					|| !form.fields.timeframe.isOriginal()
			},
			name: ({test}) => true,
			states: ({form}) => form ? form.fields.locations.fields.states.value : [],
			submitHighlight: ({
				                  $routeParams,
				                  factorsModified,
				                  locationOrTimeframeModified,
				                  isValid
			                  }) => {
				if (!isValid) {
					return 'b00'
				}
				if ($routeParams.mode !== 'alter') {
					return '0b0'
				}

				return factorsModified || locationOrTimeframeModified
					? '0b0'
					: 'b00'
			},
			timeframe: ({form}) => form ? form.fields.timeframe : null
		},
		data() {
			return {
				poll: {
					name: ''
				}
			}
		},
		helpers: {
			getArrayValueTexts,
			getDate
		},
		methods: {
			ack() {
				this.set({invalidAlter: false})
			},
			createPoll() {
				const poll = this.get().poll
				if (!poll.name) {
					return
				}
			},
			selectFactor(
				factorForm,
				$routeParams
			) {
				this.set({keepPollId: $routeParams.pollId})
				forms.setForm(forms.CREATE_FACTOR, factorForm)
				routes.navigateToPage(routes.FACTOR_INFO_MAIN, $routeParams)
			},
			selectLocations(
				$routeParams
			) {
				this.set({keepPollId: $routeParams.pollId})
				routes.navigateToPage(routes.POLL_LOCATIONS, $routeParams)
			},
			selectTimeframe(
				$routeParams
			) {
				this.set({keepPollId: $routeParams.pollId})
				routes.navigateToPage(routes.POLL_TIMEFRAME, $routeParams)
			},
			submit(
				$routeParams,
				factorsModified,
				locationOrTimeframeModified
			) {
				const {form, routeParams} = this.get()
				form.touch()

				if (!form.valid) {
					return
				}

				if (
					routeParams.mode !== 'build'
					&& !factorsModified
					&& !locationOrTimeframeModified) {
					this.set({invalidAlter: true})
					return
				}

				forms.navigateOnValid(this, routes.POLL_INFO_CUBE, $routeParams)
			}
		},
		oncreate() {
			const {mode, pollId} = formCache.getPollRouteParams(this)

			Promise.all([
				loadForms(this),
				labelDao.getAll(),
				loadLocations(),
				loadLocText(this.store, 'en-us'),
				DI.get(VOTE_DAO)
			]).then(([
				         {DateField, Field, FieldGroup, MatchingField, OptionsField, Validators},
				         labels,
				         locations,
				         _,
				         poll
			         ]) => {
				let form = forms.getForm(forms.CREATE_POLL_TOP)

				const {text} = this.store.get()

				if (!form) {
					form = pollFormCreator.createPollForm(
						labels,
						locations,
						text.UI,
						DateField,
						Field,
						FieldGroup,
						MatchingField,
						OptionsField,
						Validators)
					form.setTrackOriginal(mode === 'alter')
					forms.setForm(forms.CREATE_POLL_TOP, form)
					pollDao.findByPollIdWithDetails(pollId).then((
						poll
					) => {
						if (!poll) {
							return
						}
						form.setValue(pollFormToConverter.dtoToForm(poll), !poll.draft)
						form.fields.locations.optionText = text.LOCATIONS
						form.validate()
						form.touch()
					}).catch((error) => {
						this.set({error})
					})
				}

				forms.ensureForm(form, this)
			})
			this.store.set({
				pageTitle: 'Poll Info'
			})
		},
		ondestroy() {
			formCache.savePollForm(this).then()
			forms.clearForm(this)
		},
		store: () => store
	}


</script>
