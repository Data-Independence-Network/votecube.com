{#if form}
<form>
	<legend>Create Poll</legend>
	<Text
			field="{form.fields.name}"
	></Text>
	<div class="pure-control-group">
		<AutoComplete
				field="{form.fields.theme}"
		></AutoComplete>
	</div>
	<div
			class="outcomes"
	>
		<div
				class="A"
		>
			<CharacterButton
					character="A"
					fontSize="20"
					fontX="12"
					fontY="19"
					size="24"
					strokeWidth="1"
			></CharacterButton>
			<TextArea
					field="{form.fields.outcomes.fields.A}"
					floatLabel="{false}"
					mid="{false}"
					mini="{true}"
			></TextArea>
		</div>
		<div
				class="B"
		>
			<CharacterButton
					character="B"
					fontSize="20"
					fontX="12"
					fontY="19"
					size="24"
					strokeWidth="1"
			></CharacterButton>
			<TextArea
					field="{form.fields.outcomes.fields.B}"
					floatLabel="{false}"
					mid="{false}"
					mini="{true}"
			></TextArea>
		</div>
	</div>
	<!--
	<div class="pure-control-group">
		<MultiSelect
				field="{form.fields.labels}"
		></MultiSelect>
	</div>
	<IconBlock
			fieldGroup="{form.fields.locations}"
			on:select="selectLocations($routeParams)"
	>
		<div slot="icon">
			<LocationIcon
					width="42"
			></LocationIcon>
		</div>
		<div slot="text">
			{#if locations && locations.touched}
			{#if continents.length}
			{#if countries.length}
			{#if states.length}
			{#if cities.length}
			Cities:
			<br>
			{getArrayValueTexts(cities)}
			<br>
			<br>
			{/if}
			States:
			<br>
			{getArrayValueTexts(states)}
			<br>
			<br>
			{/if}
			Countries:
			<br>
			{getArrayValueTexts(countries)}
			<br>
			<br>

			{/if}
			Continents:
			<br>
			{getArrayValueTexts(continents)}
			{:else}
			Select Geography
			{/if}
			{:else}
			Select Geography
			{/if}
		</div>
	</IconBlock>

	<IconBlock
			fieldGroup="{form.fields.timeframe}"
			on:select="selectTimeframe($routeParams)"
	>
		<div slot="icon">
			<TimeIcon></TimeIcon>
		</div>
		<div slot="text">
			{#if timeframe && timeframe.touched}
			<table
					class="timeframe"
			>
				<tr>
					<td>
						Start Date:
					</td>
					<td>
						{getDate(timeframe.fields.startDate.value, logicUtils)}
					</td>
				</tr>
				<tr>
					<td>
						End Date:
					</td>
					<td>
						{getDate(timeframe.fields.endDate.value, logicUtils)}
					</td>
				</tr>
			</table>
			{:else}
			Select Time-frame
			{/if}
		</div>
	</IconBlock>
	-->
	<SelectionBlock
			factor="{form.fields.factors.fields[1]}"
			text="{form.fields.factors.text[1]}"
			on:select="selectFactor(form.fields.factors.fields[1], $routeParams)"
	></SelectionBlock>
	<SelectionBlock
			factor="{form.fields.factors.fields[2]}"
			text="{form.fields.factors.text[2]}"
			on:select="selectFactor(form.fields.factors.fields[2], $routeParams)"
	></SelectionBlock>
	<SelectionBlock
			factor="{form.fields.factors.fields[3]}"
			text="{form.fields.factors.text[3]}"
			on:select="selectFactor(form.fields.factors.fields[3], $routeParams)"
	></SelectionBlock>
	<nav class="pure-controls">
		<PreviewButton
				classes="submitButton"
				highlightColor="{submitHighlight}"
				on:select="submit($routeParams, modified)"
		></PreviewButton>
	</nav>
</form>
{#if invalidAlter}
<ActionPopover
		on:cancel="ack()"
		infoOnly="Y"
>
	<div slot="header">
		Error
	</div>
	<div slot="content">
		Please make a modification.
	</div>
</ActionPopover>
{/if}
{/if}

<style>

	legend {
		display: none;
	}

	.A, .B {
		flex-basis: 100%;
		text-align: center;
	}

	.B {
		margin-left: 0.4em;
	}

	.outcomes {
		display: flex;
		margin-top: 10px;
		width: 100%;
	}

	/*
		.timeframe td {
			padding: 5px;
		}

		.timeframe td:first-child {
			text-align: right;
		}

		.timeframe td:nth-child(2) {
			text-align: left;
		}
	*/
</style>

<script>
	import {DI}            from '@airport/di'
	import {
		POLL_FORM_LOGIC,
		POLL_MANAGER
	}                      from '@votecube/public-logic'
	import CharacterButton from '../../../common/control/button/CharacterButton.html'
	import PreviewButton   from '../../../common/control/button/PreviewButton.html'
	import AutoComplete    from '../../../common/field/AutoComplete.svelte'
	import Text            from '../../../common/field/Text.html'
	import TextArea        from '../../../common/field/TextArea.svelte'
	import ActionPopover   from '../../../common/shell/ActionPopover.html'
	import SelectionBlock  from '../../../components/factor/SelectionBlock.html'
	import * as formCache  from '../../../form/cache'
	import * as forms      from '../../../form/forms'
	import {loadForms}     from '../../../libs/forms'
	import * as routes     from '@votecube/public-logic/src/routes'
	import store           from '@votecube/public-logic/src/store'

	export default {
		components: {
			ActionPopover,
			AutoComplete,
			CharacterButton,
			PreviewButton,
			SelectionBlock,
			Text,
			TextArea,
		},
		computed: {
			// cities: ({form}) => form ? form.fields.locations.fields.cities.value : [],
			// continents: ({form}) => form ? form.fields.locations.fields.continents.value : [],
			// countries: ({form}) => form ? form.fields.locations.fields.countries.value : [],
			// locations: ({form}) => form ? form.fields.locations : null,
			modified: ({$routeParams, isOriginal, form}) => {
				if (!form
					|| $routeParams.mode !== 'alter'
					|| isOriginal) {
					return false
				}
				return !form.isOriginal()
			},
			/*
			factorsModified: ({$routeParams, isOriginal, form}) => {
				if (!form
					|| $routeParams.mode !== 'alter'
					|| isOriginal) {
					return false
				}
				return !form.fields.factors.isOriginal()
			},
			*/
			/*
locationOrTimeframeModified: ({$routeParams, isOriginal, form}) => {
	if (!form
		|| $routeParams.mode !== 'alter'
		|| isOriginal) {
		return false
	}
	return !form.fields.locations.isOriginal()
		|| !form.fields.timeframe.isOriginal()
},
 */
			name: ({test}) => true,
			// states: ({form}) => form ? form.fields.locations.fields.states.value : [],
			submitHighlight: ({
				                  $routeParams,
				                  modified,
				                  isValid
			                  }) => {
				if (!isValid) {
					return 'b00'
				}
				if ($routeParams.mode !== 'alter') {
					return '0b0'
				}

				return modified
					? '0b0'
					: 'b00'
			},
			// timeframe: ({form}) => form ? form.fields.timeframe : null
		},
		data() {
			return {
				form: null,
				poll: {
					name: ''
				}
			}
		},
		helpers: {
			/*
			getArrayValueTexts: (
				arrayValue,
			) => {
				const {container} = this.get()

				container.get(LOGIC_UTILS)

				if (!logicUtils) {
					return ''
				}
				return logicUtils.getArrayValueTexts(arrayValue)
			},
			getDate: (
				date
			) => {
				const {container} = this.get()

				container.get(LOGIC_UTILS)

				if (!logicUtils) {
					return ''
				}
				return logicUtils.getDate(date)
			}
			*/
		},
		methods: {
			ack() {
				this.set({invalidAlter: false})
			},
			selectFactor(
				factorForm,
				$routeParams
			) {
				this.set({interFormNavigation: true})
				forms.setForm(forms.CREATE_FACTOR, factorForm)
				routes.navigateToPage(routes.FACTOR_INFO_MAIN, $routeParams)
			},
			selectLocations(
				$routeParams
			) {
				// this.set({keepPollId: $routeParams.pollId})
				routes.navigateToPage(routes.POLL_LOCATIONS, $routeParams)
			},
			selectTimeframe(
				$routeParams
			) {
				// this.set({keepPollId: $routeParams.pollId})
				routes.navigateToPage(routes.POLL_TIMEFRAME, $routeParams)
			},
			submit(
				$routeParams,
				modified
			) {
				doSubmit($routeParams, modified, this).then()
			}
		},
		oncreate() {
			initPage(this).then()
		},
		ondestroy() {
			formCache.savePollForm(this).then()
			forms.clearForm(this)
		},
		store: () => store
	}

	async function initPage(page) {
		const container = DI.ui('PollForm')
		const [
			      formFactory,
			      // locations,
			      // _,
			      // [
			      // labelDao,
			      // pollDao
			      // , voteDao
			      // ]
		      ]         = await Promise.all([
			loadForms(page.store),
			// loadLocations(),
			// loadLocText(page.store, 'en-us'),
		])

		// let labels = await labelDao.getAll()

		let form = forms.getForm(forms.CREATE_POLL_TOP)

		const {text} = page.store.get()

		if (!form) {
			const {mode} = formCache.getPollRouteParams(page)

			try {
				const pollManager = await container.get(POLL_MANAGER)

				const currentVariation = pollManager.currentVariation
				if (!currentVariation.ui && mode !== 'build') {
					routes.navigateToPage(routes.POLL_LIST)
					return
				}

				const pollFormLogic = await container.get(POLL_FORM_LOGIC)

				form = await pollFormLogic.getPollForm(
					currentVariation,
					mode === 'alter',
					mode !== 'create',
					text,
					formFactory)

				forms.setForm(forms.CREATE_POLL_TOP, form)
			} catch (error) {
				page.set({error})
				return
			}
		}

		forms.ensureForm(form, page)

		page.set({
			container
		})

		page.store.set({
			form,
			pageTitle: 'Poll Info',
			// positionMap
		})
	}


	async function doSubmit(
		$routeParams,
		modified,
		page
	) {
		const {container} = page.get()

		const pollManager = await container.get(POLL_MANAGER)

		const form = pollManager.currentVariation.form
		form.touch()

		if (!form.valid) {
			return
		}

		if (
			$routeParams.mode === 'alter'
			&& !modified) {
			page.set({invalidAlter: true})
			return
		}

		forms.navigateOnValid(page, routes.POLL_MAIN, $routeParams)
	}

</script>
