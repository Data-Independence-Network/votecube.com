{#if vote}
<VoteComponentGraph
		bind:delta
		bind:maxBarSize
		bind:poll
		bind:verticalLayout="{$verticalLayout}"
		bind:vote
		mode="page"
		on:toggleX="toggleSurface('x')"
		on:toggleY="toggleSurface('y')"
		on:toggleZ="toggleSurface('z')"
></VoteComponentGraph>
{/if}

<script>
	import {shutDownCubeListener} from '@votecube/public-logic'
	import {
		navigateToPage,
		pageTitle
	}                             from '@votecube/public-logic/src'
	import VoteComponentGraph     from '../../../components/vote/VoteComponentGraph.html'
	import {setupCubeView}        from '@votecube/public-logic/src/database'
	import {setResizeCllBck}      from '@votecube/public-logic/src/resizer'
	import {POLL_INFO_MAIN}       from '../../../routes'
	import store                  from '../../../store'

	export default {
		components: {
			VoteComponentGraph
		},
		data() {
			return {
				factor: null,
				delta: 0
			}
		},
		methods: {
			toggleSurface(
				factor
			) {
				this.get().mutationApi.toggleSurface(factor)
				this.set({delta: this.get().delta + 1})
			}
		},
		oncreate() {
			setResizeCllBck((
				portalHeight,
				windowWidth,
				verticalLayout
			) => {
				let maxBarSize = portalHeight - 60

				if (verticalLayout) {
					maxBarSize = portalHeight / 2 - 20
				}

				this.set({maxBarSize})
			})

			const pollId = this.store.get().routeParams.pollId

			setupCubeView(null, pollId, this).then()
			this.store.set({noOverflow: true})
		},
		ondestroy() {
			shutDownCubeListener()
			setResizeCllBck(null)
			this.store.set({noOverflow: false})
		},
		store: () => store
	}let vote
	let poll
	let mode
	let delta

	async function setupCubeView(
		newMode,
		pollId,
		page
	) {
		const [
			      setPositionDataAndMove,
			      voteDao
		      ] = await Promise.all([
			loadCubeLogic(() => {
				delta += 1
			}),
			await DI.get(VOTE_DAO)
		])

		vote = await voteDao.findMyVoteForPoll(pollId)

		if (!vote) {
			if (pollId === 0) {
				navigateToPage(POLL_INFO_MAIN)
			}
			return
		}
		mode = newMode
		poll = vote.poll
		setPositionDataAndMove(vote)

		pageTitle.set(poll.name)
	}

</script>
