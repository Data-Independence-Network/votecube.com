<article
		transition:fade="{duration: 700}"
>
	{#if currentVariation && form}
	<!--
	<form>
		<Text
				field="{form.fields.search}"
		></Text>
	</form>
	-->

	{#if currentVariation.depth - 1}
	<nav>
		<div>
			<RightButton
					styles="transform: rotate(-90deg);"
					on:select="moveUpHierarchy(childVariations, currentVariation, navList)"
					size="25"
			></RightButton>
		</div>
		<var>
			&nbsp;&nbsp;{currentVariation.depth - 1}
		</var>
	</nav>
	{/if}
	<VariationListItem
			childMode="{false}"
			classes="{switchToClasses(switching, switchedToKey, currentVariation)}"
			logicUtils="{logicUtils}"
			mode="{mode}"
			navList="{navList}"
			on:select="goTo(currentVariation.pollKey, currentVariation.key)"
			variation="{currentVariation}"
	></VariationListItem>
	<div
			class="divider"
	></div>
	{#each childVariations as variation}
	<VariationListItem
			classes="{switchToClasses(switching, switchedToKey, variation)}"
			logicUtils="{logicUtils}"
			mode="{mode}"
			navList="{navList}"
			on:moveDownHierarchy="moveDownHierarchy(childVariations, variation, navList)"
			on:select="goTo(variation.pollKey, variation.key)"
			variation="{variation}"
	></VariationListItem>
	{/each}
	{#if !childVariations.length}
	<div
			class="noChildVariations"
	>
		No child variations exist yet.
	</div>
	{/if}
	<VariationListFab
			entityNames="Polls"
			on:factors="showFactors()"
			on:sort="setAction('sort')"
			on:filter="setAction('filter')"
			on:outcomes="showOutcomes()"
	></VariationListFab>
	<!--
	<VirtualList items={factors} component={ListItem} />
	-->
	{#if ['filter', 'sort'].indexOf(action) > -1}
	<!--			contentClass="smallPadding"-->
	<ActionPopover
			customCancel="{true}"
			on:cancel="setAction('none')"
	>
		<div slot="header">
			{#if action === 'filter'}
			Coming soon - Filtering
			{:elseif action === 'sort'}
			Coming soon - Sorting
			{/if}
		</div>
		<div slot="content">
			<br>
			<h3>
				{#if action === 'filter'}
				Ability filter Poll results is coming right after Opinions and will be
				released mid-Alpha.
				{:elseif action === 'sort'}
				Ability sort Poll results is at the same time as the ability to filter
				and will be released mid-Alpha.
				{/if}
				<br>
				<br>
				Please see the <a
					on:click="goToReleasePlan()"
			>Release Plan</a> for details.
			</h3>
			<br>
		</div>
		<!--
		<div slot="actions">
			<VoteButton
					on:select="vote()"
			></VoteButton>
		</div>
	-->
		<div slot="cancel">
			<CancelButton
					on:select="setAction('none')"
			></CancelButton>
		</div>
	</ActionPopover>
	{/if}

	{/if}
</article>

<style>
	article {
		height: initial;
		max-width: 420px;
		position: relative;
		width: 100%;
	}

	nav {
		display: flex;
		text-align: center;
		width: 100%;
	}

	nav > div {
		flex-basis: 100%;
		text-align: right;
	}

	nav > var {
		color: black;
		flex-basis: 100%;
		text-align: left;
		line-height: 27px;
		vertical-align: middle;
	}

	.divider {
		height: 3px;
		background-color: black;
		margin: 2px 10px 2px 10px;
		max-width: 100%;
	}

	.noChildVariations {
		padding: 15px;
		text-align: center;
		width: 100%;
	}

</style>
<script>
	import {DI}              from '@airport/di'
	import {
		LOGIC_UTILS,
		POLL_MANAGER
	}                        from '@votecube/public-logic'
	import {fade}            from 'svelte-transitions'
	import CancelButton      from '../../../common/control/button/CancelButton.html'
	import RightButton       from '../../../common/control/button/RightButton.html'
	// import VirtualList from '@sveltejs/svelte-virtual-list';
	import ActionPopover     from '../../../common/shell/ActionPopover.html'
	import VariationListFab  from '../../../components/poll/variation/VariationListFab.html'
	import * as forms        from '../../../form/forms'
	import {loadForms}       from '../../../libs/forms'
	import * as routes       from '@votecube/public-logic/src/routes'
	import store             from '@votecube/public-logic/src/store'
	import VariationListItem from './VariationListItem.html'

	export default {
		components: {
			ActionPopover,
			CancelButton,
			RightButton,
			VariationListFab,
			VariationListItem,
			// VirtualList
		},
		data() {
			return {
				mode: 'factors'
			}
		},
		helpers: {
			switchToClasses(
				switching,
				switchedToKey,
				currentVariation
			) {
				if (!switching) {
					return ''
				}
				const switchedToItem = switchedToKey === currentVariation.key
				if (switching === 1) {
					return switchedToItem ? '' : 'closing'
				} else if (switching === 2) {
					return switchedToItem ? '' : 'closed'
				}
			}
		},
		methods: {
			goTo(
				pollKey,
				pollVariationKey
			) {
				// FIXME: need a new mode, something like 'view' - since you can't vote on a variation
				routes.navigateToPage(routes.POLL_MAIN, {
					mode: 'vote',
					pollKey,
					pollVariationKey,
				})
			},
			goToReleasePlan() {
				routes.navigateToPage(routes.RELEASE_PLAN)
			},
			moveDownHierarchy(
				childVariations,
				moveToVariation,
				navList
			) {
				doMoveDown(moveToVariation, navList, childVariations.length, this)
			},
			moveUpHierarchy(
				childVariations,
				moveToVariation,
				navList,
			) {
				doMoveUp(moveToVariation, navList, childVariations.length, this)
			},
			setAction(
				action
			) {
				this.set({action, error: ''})
			},
			showFactors() {
				this.set({mode: 'factors'})
			},
			showOutcomes() {
				this.set({mode: 'outcomes'})
			},
		},
		oncreate() {
			initPage(this).then()
		},
		ondestroy() {
			forms.clearForm(this)
		},
		store: () => store,
		transitions: {
			fade
		}
	}

	async function initPage(page) {
		const container = DI.ui('VariationList')

		const {pollKey, pollVariationKey} = page.store.get().routeParams
		let [
			    currentVariation,
			    childVariations,
			    formFactory
		    ]                             = await getListingsAndOther(
			pollKey,
			pollVariationKey,
			loadForms(page.store),
			container
		)

		const filter = formFactory.group('List', {
			search: formFactory.field([])
		}, [], page.store.get().text.UI.Poll)


		const navList = {
			direction: 0,
			isTarget: true,
			previous: null,
			variation: currentVariation,
		}

		const logicUtils = await container.get(LOGIC_UTILS)

		page.set({childVariations, container, currentVariation, logicUtils, navList})
		forms.ensureForm(filter, page)

		page.store.set({
			pageTitle: 'Poll Variations'
		})
	}

	async function getListingsAndOther(
		pollKey,
		pollVariationKey,
		otherPromise,
		container
	) {
		const pollManager = await container.get(POLL_MANAGER)
		let [
			    currentVariation,
			    childVariations,
			    otherResult
		    ]             = await Promise.all([
			pollManager.getVariationListing(pollKey, pollVariationKey),
			pollManager.getChildVariationListings(pollKey, pollVariationKey),
			otherPromise,
		])

		return [
			currentVariation,
			childVariations,
			otherResult
		]
	}

	function doMoveDown(
		moveToVariation,
		navList,
		numChildren,
		page
	) {
		page.set({switching: 1, switchedToKey: moveToVariation.key})

		setTimeout(() => {
			page.set({switching: 2})
			getDataAndMoveDown(
				moveToVariation,
				navList,
				numChildren,
				page
			).then()
		}, 10)
	}

	function doMoveUp(
		moveToVariation,
		navList,
		numChildren,
		page
	) {
		page.set({switching: 1, switchedToKey: moveToVariation.key})

		setTimeout(() => {
			page.set({switching: 2})
			getDataAndMoveUp(
				moveToVariation,
				navList,
				numChildren,
				page
			).then()
		}, 10)
	}

	async function getDataAndMoveDown(
		moveToVariation,
		navList,
		numChildren,
		page
	) {
		const {
			      currentVariation,
			      childVariations,
		      } = await getSwitchData(
			moveToVariation.pollKey,
			moveToVariation.key,
			numChildren,
			page
		)

		if ([0, 1].indexOf(navList.direction) > -1
			&& navList.variation.key !== moveToVariation.key) {
			navList = {
				direction: 1,
				isTarget: false,
				previous: navList,
				variation: moveToVariation,
			}
		} else if (navList.direction === -1) {
			if (navList.variation.key === moveToVariation.key) {
				navList = navList.previous
			} else {
				navList = {
					direction: 1,
					isTarget: false,
					previous: navList,
					variation: moveToVariation,
				}
			}
		}

		finishSwitching(childVariations, currentVariation, navList, page)
	}

	async function getDataAndMoveUp(
		moveToVariation,
		navList,
		numChildren,
		page
	) {
		const {
			      currentVariation,
			      childVariations,
		      } = await getSwitchData(
			moveToVariation.pollKey,
			moveToVariation.parent.key,
			numChildren,
			page
		)

		if (navList.direction === -1) {
			navList = {
				direction: -1,
				isTarget: false,
				previous: navList,
				variation: currentVariation,
			}
		} else if (navList.direction === 0
			&& moveToVariation.key !== navList.variation.key) {
			navList = {
				direction: -1,
				isTarget: false,
				previous: navList,
				variation: moveToVariation,
			}
		} else if (navList.direction === 1) {
			navList = navList.previous
		}

		finishSwitching(childVariations, currentVariation, navList, page)
	}

	async function getSwitchData(
		pollKey,
		key,
		numChildren,
		page
	) {
		let [
			    currentVariation,
			    childVariations,
			    _
		    ] = await getListingsAndOther(
			pollKey,
			key,
			new Promise(
				resolve => {
					setTimeout(() => {
						resolve()
					}, numChildren ? 1500 : 0)
				}),
			page.get().container
		)

		return {
			currentVariation,
			childVariations,
		}
	}

	function finishSwitching(
		childVariations,
		currentVariation,
		navList,
		page
	) {
		page.set({
			childVariations,
			currentVariation,
			navList
		})
		setTimeout(() => {
			page.set({switching: 1})
			setTimeout(() => {
				page.set({switching: 0})
			}, childVariations.length ? 1500 : 0)
		}, 10)
	}

</script>
