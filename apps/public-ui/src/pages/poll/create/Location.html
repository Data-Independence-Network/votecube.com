{#if form}
<form class="pure-form pure-form-aligned">
    <fieldset>
        <div class="pure-control-group">
            <MultiSelect
                field="{form.fields.continents}"
            ></MultiSelect>
        </div>
        <div class="pure-control-group">
            <MultiSelect
                field="{form.fields.countries}"
            ></MultiSelect>
        </div>
        <div class="pure-control-group">
            <MultiSelect
                field="{form.fields.states}"
            ></MultiSelect>
        </div>
        <div class="pure-control-group">
            <MultiSelect
                field="{form.fields.cities}"
            ></MultiSelect>
        </div>
        <div class="pure-controls">
            <RightButton
                classes="submitButton"
                highlightColor="{submitHighlight}"
            ></RightButton>
        </div>
    </fieldset>
</form>
{/if}

<script>
import RightButton from '../../../common/control/button/RightButton.html'
import MultiSelect from '../../../common/field/MultiSelect.html'
import {getForm} from '../../../forms'
import {loadForms} from '../../../libs/forms'
import {loadLocations} from '../../../libs/locations'
import {loadLocations as loadLocText} from '../../../libs/text/locations'
import {loadUi} from '../../../libs/text/ui'
import store from '../../../store'

export default {
    components: {
        MultiSelect,
        RightButton
    },
    computed: {
        submitHighlight: ({isValid}) => isValid
        ? '0b0'
        : 'b00'
    },
    immutable: true,
    oncreate() {
        Promise.all([
            loadForms(this),
            loadLocations(),
            loadUi(this.store, 'en-us'),
            loadLocText(this.store, 'en-us')
        ]).then(([
            {FieldGroup, OptionsField, Validators},
            locations,
                    _,
                    _2
        ]) => {
            const text = this.store.get().text
            const continents = new OptionsField([
                    Validators.required()
                ], locations.continents)
            const countries = new OptionsField([
                ], locations.countries)
            const states = new OptionsField([
                ], locations.states)
            const cities = new OptionsField([
                ], locations.cities)
            const form = new FieldGroup('Location', {
                continents,
                countries,
                states,
                cities,
            }, [], this, text.UI.Poll.Create)

            if(!form.optionText) {
                form.optionText = text.LOCATIONS

                continents.onChange((
                selectedContinents
                ) => {
                    selectSubLocation(selectedContinents, locations.countries, countries)
                })
                countries.onChange((
                    selectedCountries
                ) => {
                    selectSubLocation(selectedCountries, locations.states, states)
                })
                states.onChange((
                    selectedStates
                ) => {
                    selectSubLocation(selectedStates, locations.cities, cities)
                })
            }
            this.set({form: getForm().location})
        })
    },
    store: () => store
}

function selectSubLocation(
    selectedParentLocations,
    childLocations,
    childLocationField
) {
    const matchingChildLocations = []
    for(const parentLocation of selectedParentLocations) {
        for(const country of childLocations) {
            if(country.parent == parentLocation.key) {
                matchingChildLocations.push(country)
            }
        }
        // continent.key
    }
    childLocationField.options = matchingChildLocations

}

</script>