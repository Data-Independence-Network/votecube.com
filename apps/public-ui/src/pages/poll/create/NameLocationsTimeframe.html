{#if form}
<form class="pure-form">
    <fieldset>
        <legend>Create Poll</legend>
        <Text
            field="{form.fields.name}"
        ></Text>
        <IconBlock
            fieldGroup="{form.fields.theme}"
        >
            <div slot="icon">
                <ThemeIcon
                ></ThemeIcon>
            </div>
            <div slot="text">
            Theme
            </div>
        </IconBlock>
        <IconBlock
            fieldGroup="{form.fields.labels}"
        >
            <div slot="icon">
                <LabelIcon
                ></LabelIcon>
            </div>
            <div slot="text">
            Label(s)
            </div>
        </IconBlock>
        <IconBlock
            fieldGroup="{form.fields.locations}"
            on:select="selectLocations()"
        >
            <div slot="icon">
                <LocationIcon
                    width="42"
                ></LocationIcon>
            </div>
            <div slot="text">
    {#if locations && locations.touched}
        {#if continents.length}
            {#if countries.length}
                {#if states.length}
                    {#if cities.length}
                Cities:
                <br>
                {getArrayValueTexts(cities)}
                <br>
                <br>
                    {/if}
                States:
                <br>
                {getArrayValueTexts(states)}
                <br>
                <br>
                {/if}
                Countries:
                <br>
                {getArrayValueTexts(countries)}
                <br>
                <br>

            {/if}
                Continents:
                <br>
                {getArrayValueTexts(continents)}
        {:else}
                Select Location
        {/if}
    {:else}
                Select Location
    {/if}
            </div>
        </IconBlock>
        <IconBlock
            fieldGroup="{form.fields.timeframe}"
            on:select="selectTimeframe()"
        >
            <div slot="icon">
                <TimeIcon></TimeIcon>
            </div>
            <div slot="text">
    {#if timeframe && timeframe.touched}
                <table>
                    <tr>
                        <td>
                            Start Date:
                        </td>
                        <td>
                            {getDate(timeframe.fields.startDate.value)}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            End Date:
                        </td>
                        <td>
                            {getDate(timeframe.fields.endDate.value)}
                        </td>
                    </tr>
                </table>
    {:else}
                Select Time-frame
    {/if}
            </div>
        </IconBlock>
    {#if form.fields.dimensions.valid}
        {#each filledDimensions as dimension}
        <SelectionBlock
                    dimension="{dimension}"
                    on:select="selectDimensions()"
        ></SelectionBlock>
        {/each}
    {:else}
        <IconBlock
            fieldGroup="{form.fields.dimensions}"
            on:select="selectDimensions()"
        >
            <div slot="icon">
                <DimensionsIcon></DimensionsIcon>
            </div>
            <div slot="text">
            Dimensions
            </div>
        </IconBlock>
    {/if}
        <nav class="pure-controls">
            <RightButton
                classes="submitButton"
                highlightColor="{submitHighlight}"
            ></RightButton>
        </nav>
    </fieldset>
</form>
{/if}

<style>

    legend {
        display: none;
    }

</style>

<script>
import RightButton from '../../../common/control/button/RightButton.html'
import Text from '../../../common/field/Text.html'
import IconBlock from '../../../common/field/IconBlock.html'
import DimensionsIcon from '../../../common/icon/DimensionsIcon.html'
import LabelIcon from '../../../common/icon/LabelIcon.html'
import LocationIcon from '../../../common/icon/LocationIcon.html'
import ThemeIcon from '../../../common/icon/ThemeIcon.html'
import TimeIcon from '../../../common/icon/TimeIcon.html'
import SelectionBlock from '../../../components/dimension/SelectionBlock.html'
import * as forms from '../../../forms'
import {loadForms} from '../../../libs/forms'
import {loadLocations} from '../../../libs/locations'
import {loadUi} from '../../../libs/text/ui'
import {getArrayValueTexts, getDate} from '../../../helpers/general'
import * as routes from '../../../routes'
import store from '../../../store'

export default {
    components: {
        DimensionsIcon,
        IconBlock,
        LabelIcon,
        LocationIcon,
        RightButton,
        SelectionBlock,
        Text,
        ThemeIcon,
        TimeIcon
    },
    computed: {
        cities: ({form}) => form ? form.fields.locations.fields.cities.value : [],
        continents: ({form}) => form ? form.fields.locations.fields.continents.value : [],
        countries: ({form}) => form ? form.fields.locations.fields.countries.value : [],
        filledDimensions: ({form}) => {
            if(!form) {
                return null
            }
            const dimensions = [];
            const fields = form.fields.dimensions.fields
            for(const fieldName in fields) {
                const field = fields[fieldName]
                if(field.valid && field.hasChildValues) {
                    dimensions.push(field)
                }
            }
            return dimensions
        },
        locations: ({form}) => form ? form.fields.locations : null,
        name: ({test}) => true,
        states: ({form}) => form ? form.fields.locations.fields.states.value : [],
        submitHighlight: ({isValid}) => isValid
        ? '0b0'
        : 'b00',
        timeframe: ({form}) => form ? form.fields.timeframe : null
    },
    data() {
        return {
            poll: {
                name: ''
            }
        }
    },
	helpers: {
		getArrayValueTexts,
		getDate
	},
    methods: {
        createPoll() {
            const poll = this.get().poll
            if(!poll.name) {
                return
            }
        },
        selectDimensions() {
            routes.navigateToPage(routes.SELECT_POLL_DIMENSIONS)
        },
        selectLocations() {
            routes.navigateToPage(routes.SELECT_POLL_LOCATIONS)
        },
        selectTimeframe() {
            routes.navigateToPage(routes.SELECT_POLL_TIMEFRAME)
        }
    },
    oncreate() {
        Promise.all([
            loadForms(this),
            loadLocations(),
            loadUi(this.store, 'en-us')
        ]).then(([
            {DateField, Field, FieldGroup, MatchingField, OptionsField, Validators},
            locations,
            _
        ]) => {
            let form = forms.getForm(forms.CREATE_POLL_TOP)

            if(!form) {
                form = createForm(
                    locations,
                    this.store.get().text.UI,
                    DateField,
                    Field,
                    FieldGroup,
                    MatchingField,
                    OptionsField,
                    Validators)
                forms.setForm(forms.CREATE_POLL_TOP, form)
            }

           forms.ensureForm(form, this)
        })
    },
    ondestroy() {
        forms.clearForm(this)
    },
    store: () => store
}

function createForm(
    locationsData,
    uiText,
    DateField,
    Field,
    FieldGroup,
    MatchingField,
    OptionsField,
    Validators
) {
    const text = uiText.Poll.Create;

    const dimensions = new FieldGroup('Dimensions', {
        first: createDimensionForm(
            uiText,
            Field,
            FieldGroup,
            MatchingField,
            Validators,
            [Validators.required()]
        ),
        second: createDimensionForm(
            uiText,
            Field,
            FieldGroup,
            MatchingField,
            Validators,
            [Validators.required()]
        ),
        third: createDimensionForm(
            uiText,
            Field,
            FieldGroup,
            MatchingField,
            Validators,
            []
        )
    }, [Validators.required()], text)

    const labels = new FieldGroup('Labels', {
        labels: new OptionsField([], [])
    }, [], text)

    const locations = new FieldGroup('Locations', {
        continents: new OptionsField([
                Validators.required()
            ], locationsData.continents, {
                multi: true
            }),
        countries: new OptionsField([
            ], locationsData.countries, {
                multi: true
            }),
        states: new OptionsField([
            ], locationsData.states, {
                multi: true
            }),
        cities: new OptionsField([
            ], locationsData.cities, {
                multi: true
            }),
    }, [Validators.required()], text)

    const startDate = new DateField([
        Validators.required(),
        Validators.minTomorrow()
    ])

    const theme = new FieldGroup('Theme', {
        theme: new OptionsField([
            // Validators.required()
        ], [])
    }, [
        // Validators.required()
        ], text)

    const timeframe = new FieldGroup('Timeframe', {
        startDate,
        endDate: new DateField([
                Validators.required(),
                Validators.minTomorrow(),
                Validators.greaterThanOrEquals(startDate)
            ]),
    }, [Validators.required()], text)

    return new FieldGroup('NameLocationsTimeframe', {
        dimensions,
        labels,
        locations,
        name: new Field([
            Validators.minLength(3),
            Validators.required()
        ], { maxLength: 40}),
        theme,
        timeframe
    }, [Validators.required()], text)
}

function createDimensionForm(
    uiText,
    Field,
    FieldGroup,
    MatchingField,
    Validators,
    formValidators
) {
    const name = new MatchingField([
        Validators.required(),
        Validators.minLength(5)
    ], {
        maxLength: 20
    })
    const topDirectionName = new MatchingField([
        Validators.required(),
        Validators.minLength(5)
    ], {
        maxLength: 120
    })
    const bottomDirectionName = new MatchingField([
        Validators.required(),
        Validators.minLength(5)
    ], {
        maxLength: 120
    })
    const topDirection = new FieldGroup('TopDirection', {
        name: topDirectionName
    }, [Validators.required()], uiText.Direction)
    const bottomDirection = new FieldGroup('BottomDirection', {
        name: bottomDirectionName
    }, [Validators.required()], uiText.Direction)

    // FIXME: move to appropriate place once matching is implemented
    name.onChange((
        value
    ) => {
        if(name.valid) {
           name.matches = ['a', 'b', 'c']
        } else {
            name.matches = null
        }
    })
    // FIXME: move to appropriate place once matching is implemented
    bottomDirectionName.onChange((
        value
    ) => {
        if(bottomDirectionName.valid) {
            bottomDirectionName.matches = ['a', 'b', 'c']
        } else {
            bottomDirectionName.matches = null
        }
    })
    // FIXME: move to appropriate place once matching is implemented
    topDirectionName.onChange((
        value
    ) => {
        if(topDirectionName.valid) {
            topDirectionName.matches = ['a', 'b', 'c']
        } else {
            topDirectionName.matches = null
        }
    })

    const color = new FieldGroup('PickColor', {
        picker: new Field([
            Validators.required()
        ])
    }, [Validators.required()], uiText.Dimension)

    return new FieldGroup('Create', {
        bottomDirection,
        color,
        name,
        topDirection
    }, formValidators, uiText.Dimension)
}
</script>
