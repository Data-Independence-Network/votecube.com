<div>
    <section
            id="viewport"
            style="
  transform: scale({zoomFactor}, {zoomFactor});
"
            class:leftViewport="!$verticalLayout"
    >
        <figure
                id="cube"
        >
            <div
                class="surface"
                id="s1"
                style="
            background-color: #{getColor(poll, 0)};
                "
            >
                {getSideText(poll, 0, 1)}
            </div>
            <div
                class="surface"
                id="s2"
                style="
            background-color: #{getColor(poll, 1)};
                "
            >
                {getSideText(poll, 1, 1)}
            </div>
            <div
                class="surface"
                id="s3"
                style="
            background-color: #{getColor(poll, 2)};
                "
            >
                {getSideText(poll, 2, 1)}
            </div>
            <div
                class="surface"
                id="s4"
                style="
            background-color: #{getColor(poll, 1)};
                "
            >
                {getSideText(poll, 1, -1)}
            </div>
            <div
                class="surface"
                id="s5"
                style="
            background-color: #{getColor(poll, 2)};
                "
            >
                {getSideText(poll, 2, -1)}
            </div>
            <div
                class="surface"
                id="s6"
                style="
            background-color: #{getColor(poll, 0)};
                "
            >
                {getSideText(poll, 0, -1)}
            </div>
        </figure>
    </section>
{#if percentMode}
    <PercentPicker
        on:close="togglePercentPicker()"
        on:move="move(event)"
        on:moveToValue="moveToValue(event)"
        poll="{poll}"
    ></PercentPicker>
{:else}
    <a
        class="app-button {$verticalLayout ? 'bottom-left' : 'top-right'}"
        on:click="togglePercentPicker()"
    >
        %
    </a>
    <table
        class="{$verticalLayout ? 'bottom-dimension-table' : 'right-dimension-table'}"
    >
    <tr>
        <td
        >
            <DimensionInfoButton
                delta="{toggleDelta}"
                dimension="{getDimension(poll, 0)}"
                displayValue="{getDisplayValue(poll, 0)}"
                index=0
                on:toggle="toggleSurface(poll, 0, 'x')"
            ></DimensionInfoButton>
        </td>
    {#if $verticalLayout}
        <td
        >
            <DimensionInfoButton
                delta="{toggleDelta}"
                dimension="{getDimension(poll, 1)}"
                displayValue="{getDisplayValue(poll, 1)}"
                index=1
                on:toggle="toggleSurface(poll, 1, 'y')"
            ></DimensionInfoButton>
        </td>
        <td>
            <DimensionInfoButton
                delta="{toggleDelta}"
                dimension="{getDimension(poll, 2)}"
                displayValue="{getDisplayValue(poll, 2)}"
                index=2
                on:toggle="toggleSurface(poll, 2, 'z')"
            ></DimensionInfoButton>
        </td>
    {/if}
    </tr>
    {#if !$verticalLayout}
    <tr>
        <td>
            <DimensionInfoButton
                delta="{toggleDelta}"
                dimension="{getDimension(poll, 1)}"
                displayValue="{getDisplayValue(poll, 1)}"
                index=1
                on:toggle="toggleSurface(poll, 1, 'y')"
            ></DimensionInfoButton>
        </td>
    </tr>
    <tr>
        <td>
            <DimensionInfoButton
                delta="{toggleDelta}"
                dimension="{getDimension(poll, 2)}"
                displayValue="{getDisplayValue(poll, 2)}"
                index=2
                on:toggle="toggleSurface(poll, 2, 'z')"
            ></DimensionInfoButton>
        </td>
    </tr>
    {/if}
    </table>
    <VoteButton
        classes="bottom-right"
    ></VoteButton>
{/if}
</div>

<style>
    .bottom-dimension-table {
        bottom: 10px;
        color: black;
        margin-left: 70px;
        margin-right: 70px;
        position: fixed;
        width: calc(100% - 140px);
    }

    .right-dimension-table {
        height: calc(100% - 84px);
        margin-top: 20px;
        position: fixed;
        right: 75px;
        top: 44px;
    }

    .leftViewport {
        right: 20%;
    }

    #viewport {
        height: 100%;
        perspective: 900px; /* FIXME: make the cube more approachable 1500px ~ 2500px;*/
        /* 1500 increases range from 11% to 9%, 2500 increases to 6% */
        perspective-origin: 50% 160px; /* 670px; */
        position: fixed;
        top: 0px;
        /*transform: scale(0.75,0.75);*/
        width: 100%;
    }

    #cube {
        height: 320px;
        margin: auto;
        position: relative;
        /*transform: rotateX(0deg) rotateY(-90deg);*/
        transform-style: preserve-3d;
        transition: transform 128ms linear;
        /*top: 50%;*/
        width: 320px;
    }

    #cube > div {
        position: absolute;
        /*
        height: 360px;
        width: 360px;
        padding: 20px;
        font-size: 1.8em;
        line-height: 2em;
        */
        height: 300px;
        width: 300px;
        padding: 10px;
        font-size: 1.7em;
        line-height: 1.7em;
        color: #000;
        border-radius: 10px;
        border: 5px groove gray;
    }

    #s1  {
        /*background: hsla(  0, 100%, 50%, 0.95);*/
        transform: rotateX(90deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s2 {
        transform: translateZ(160px) /*translateZ(200px)*/;
    }

    #s3 {
        transform: rotateY(90deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s4 {
        transform: rotateY(180deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s5 {
        transform: rotateY(-90deg) translateZ(160px) /*translateZ(200px)*/;
    }

    #s6 {
        transform: rotateX(-90deg) rotate(180deg) translateZ(160px) /*translateZ(200px)*/;
    }
</style>

<script>
import DimensionInfoButton from '../../../common/control/button/DimensionInfoButton.html'
import PercentPicker from '../../../common/control/PercentPicker.html'
import VoteButton from '../../../common/control/button/VoteButton.html'
import {getColor, getDimension, getDisplayValue, getSideText} from '../../../helpers/cube';
import {pollDao} from '../../../dao/poll';
import {loadCubeLogic, setCubeAdjustment, shutDownCubeListener} from '../../../libs/cubeLogic'
import {setResizeCllBck} from '../../../resizer'
import store from '../../../store';

export default {
    components: {
        DimensionInfoButton,
        PercentPicker,
        VoteButton
    },
    data() {
        return {
            currentZoom: 1,
            percentMode: false,
            toggleDelta: 0,
            verticalLayout: true,
            zoomFactor: 0.65
        }
    },
	helpers: {
		getColor,
		getDimension,
		getDisplayValue,
		getSideText
	},
    methods: {
        move(
            event
        ) {
            this.get().mutationApi.move(
                event.dimension,
                event.direction,
                event.percentChange
            )
        },
        moveToValue(
            event
        ) {
            this.get().mutationApi.moveToValue(event.dimension, event.value)
        },
        togglePercentPicker() {
            const percentMode = !this.get().percentMode
            setCubeAdjustment(this.get().cubeListener, !percentMode)
            this.set({percentMode})
        },
        toggleSurface(
            poll,
            dimensionIndex,
            dimensionKey
        ) {
            this.get().mutationApi.toggleSurface(dimensionKey)
            this.set({toggleDelta: this.get().toggleDelta + 1})
        },
    },
    oncreate() {
        setResizeCllBck((
            portalHeight,
            windowWidth
        ) => {
            const figureHeight = portalHeight * 0.55 + 95

            const cubeAreaLeastDimension = windowWidth < figureHeight
                ? windowWidth
                : figureHeight

            const zoomFactor = (Math.sqrt(cubeAreaLeastDimension) * 3) / 100

            this.set({zoomFactor})
        }, this.store)

        const pollId = this.store.get().routeParams.pollId
        Promise.all([
            loadCubeLogic(this),
            pollDao.findByIdWithDetails(pollId)
        ]).then(([
            setPositionDataAndMove,
            poll
        ]) => {
            this.set({poll})
            // TODO: add support for vote values
            setPositionDataAndMove(poll.displayValues)
        })

        this.store.set({noOverflow: true})
    },
    ondestroy() {
        shutDownCubeListener(this.get().cubeListener, this)
        setResizeCllBck(null)
        this.store.set({noOverflow: false})
    },
    store: () => store
}

</script>
