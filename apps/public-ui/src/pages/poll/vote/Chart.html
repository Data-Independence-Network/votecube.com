<figure
        id="chart"
        class:leftFigure="!$verticalLayout"
        class:topFigure="$verticalLayout"
>
    <!--
        style="
transform: scale({zoomFactor}, {zoomFactor});
"
-->
    <table
            class="chart-contents"
    >
        <tr id="plus">
            <td>
                <!--
                    class:selectedPlus="dimension === 'x'"
                    on:click="pick('x')"
                -->
                <div
                        style="
        background-color: #{$currentValue.x.color};
        height: {xPlusHeight}px;
            "
                >
                </div>
            </td>
            <td>
                <!--
                    class:selectedPlus="dimension === 'y'"
                    on:click="pick('y')"
                -->
                <div
                        style="
        background-color: #{$currentValue.y.color};
        height: {yPlusHeight}px;
            "
                >
                </div>
            </td>
            <td>
                <!--
                    class:selectedPlus="dimension === 'z'"
                    on:click="pick('z')"
                -->
                <div
                        style="
        background-color: #{$currentValue.z.color};
        height: {zPlusHeight}px;
            "
                >
                </div>
            </td>
        </tr>
        <tr id="minus">
            <td
            >
                <!--
                    class:selectedMinus="dimension === 'x'"
                    on:click="pick('x')"
                -->
                <div
                        style="
        background-color: #{$currentValue.x.color};
        height: {xMinusHeight}px;
            "
                >
                </div>
            </td>
            <td
            >
                <!--
                    class:selectedMinus="dimension === 'y'"
                    on:click="pick('y')"
                -->
                <div
                        style="
        background-color: #{$currentValue.y.color};
        height: {yMinusHeight}px;
            "
                >
                </div>
            </td>
            <td
            >
                <!--
                    class:selectedMinus="dimension === 'z'"
                    on:click="pick('z')"
                -->
                <div
                        style="
        background-color: #{$currentValue.z.color};
        height: {zMinusHeight}px;
            "
                >
                </div>
            </td>
        </tr>
    </table>
</figure>
<table
        class="info"
        class:bottomInfo="$verticalLayout"
        class:rightInfo="!$verticalLayout"
>
    <tr>
        <td>
            <DimensionInfoButton
                    dimension="{$currentValue.x}"
                    index=0
                    on:toggle="toggleSurface('x')"
            ></DimensionInfoButton>
        </td>
        <td
                style="
                    font-size: calc(1.8vw + 1.8vh);
                "
        >
            {xText}
        </td>
    <tr>
    </tr>
    <td>
        <DimensionInfoButton
                index=1
                dimension="{$currentValue.y}"
                on:toggle="toggleSurface('y')"
        ></DimensionInfoButton>
    </td>
    <td
            style="
                    font-size: calc(1.8vw + 1.8vh);
                "
    >
        {yText}
    </td>
    <tr>
        <td>
            <DimensionInfoButton
                    dimension="{$currentValue.z}"
                    on:toggle="toggleSurface('z')"
            ></DimensionInfoButton>
        </td>
        <td
                style="
                    font-size: calc(1.8vw + 1.8vh);
                "
        >
            {zText}
        </td>
    </tr>
</table>

<style>

    /*
    dim-info-col {
        width: 60px;
    }
    */

    figure {
        position: fixed;
        width: 100%;
    }

    .leftFigure {
        left: 5px;
        top: 45px;
        width: calc(40% - 10px)
    }

    .topFigure {
        top: 28px;
    }

    .chart-contents {
        width: 100%;
    }

    /*
    section {
        margin: 15px;
        font-size: 1.5em;
    }
    */

    .info {
        position: fixed;
    }

    .bottomInfo {
        bottom: 5px;
        width: 100%;

    }

    .rightInfo {
        right: 5px;
        top: 45px;
        width: calc(60% - 10px);
    }

    td {
        padding: 5px;
        vertical-align: middle;
    }

    #plus td {
        border-bottom: 1px solid black;
        vertical-align: bottom;
    }

    #minus td {
        vertical-align: top;
    }

    figure {
        margin: 0.8em;
    }

    figure div {
        margin: 10px;
    }

    #plus div {
        margin-bottom: 0px;
    }

    #minus div {
        margin-top: 0px;
    }

    /*
        .selectedPlus {
            border: 1px dashed;
            border-bottom: 1px solid;
        }

        .selectedMinus {
            border: 1px dashed;
            border-top: 0px;
        }
    */
</style>

<script>
import DimensionInfoButton from '../../../common/control/button/DimensionInfoButton.html'
import {loadCubeLogic, shutDownCubeListener} from '../../../libs/cubeLogic.js'
import {scheduleToResize, setResizeCllBck} from '../../../resizer.js'
import store from '../../../store.js'

export default {
    components: {
        DimensionInfoButton
    },
    computed: {
        pickedText: ({$currentValue, dimension, $text}) => {
            if (!dimension) {
                return ''
            }
            let plusIndex = 0, minusIndex = 5
            if (dimension === 'y') {
                plusIndex = 1
                minusIndex = 3
            } else if (dimension === 'z') {
                plusIndex = 2
                minusIndex = 4
            }
            return $currentValue[dimension].dir === 1
                ? $text[plusIndex]
                : $text[minusIndex]
        },
        xMinusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.x, -1, maxBarSize, maxValue),
        xPlusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.x, 1, maxBarSize, maxValue),
        xText: ({$currentValue, $text}) => $currentValue.x.dir === 1 ? $text[0] : $text[5],
        yMinusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.y, -1, maxBarSize, maxValue),
        yPlusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.y, 1, maxBarSize, maxValue),
        yText: ({$currentValue, $text}) => $currentValue.y.dir === 1 ? $text[1] : $text[3],
        zMinusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.z, -1, maxBarSize, maxValue),
        zPlusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.z, 1, maxBarSize, maxValue),
        zText: ({$currentValue, $text}) => $currentValue.z.dir === 1 ? $text[2] : $text[4],
        maxValue: ({$currentValue}) => {
            const positiveValues = []
            const negativeValues = []

            addToVals($currentValue.x, positiveValues, negativeValues)
            addToVals($currentValue.y, positiveValues, negativeValues)
            addToVals($currentValue.z, positiveValues, negativeValues)

            const maxPositiveValue = getMaxVal(positiveValues)
            const maxNegativeValue = getMaxVal(negativeValues)

            return maxPositiveValue + maxNegativeValue
        }
    },
    data() {
        return {
            dimension: null
        }
    },
    methods: {
        handleResize(
            event
        ) {
            scheduleToResize(this)
        },
        toggleSurface(
            dimension
        ) {
            this.get().mutationApi.toggleSurface(dimension)
        }
    },
    oncreate() {
        setResizeCllBck((
            portalHeight,
            windowWidth,
            verticalLayout
        ) => {
            let maxBarSize = portalHeight - 60;

            if (verticalLayout) {
                maxBarSize = portalHeight / 2 - 20;
            }

            this.set({maxBarSize});
        }, this.store)
        loadCubeLogic(this)
        this.store.set({noOverflow: true})
    },
    ondestroy() {
        shutDownCubeListener(this.get().cubeListener, this)
        setResizeCllBck(null)
        this.store.set({noOverflow: false})
    },
    store: () => store
}

function barHeight(
    dimensionPositionData,
    direction,
    maxBarSize,
    maxValue
) {
    return dimensionPositionData.dir === direction
        ? dimensionPositionData.value * maxBarSize / (maxValue * 1.2)
        : 0
}

function addToVals(
    dimensionPositionData,
    positiveValues,
    negativeValues
) {
    if (dimensionPositionData.dir === 1) {
        positiveValues.push(dimensionPositionData.value);
    } else {
        negativeValues.push(dimensionPositionData.value);
    }
}

function getMaxVal(
    values
) {
    let maximumValue = 0

    for (const value of values) {
        if (value > maximumValue) {
            maximumValue = value
        }
    }

    return maximumValue
}

</script>
