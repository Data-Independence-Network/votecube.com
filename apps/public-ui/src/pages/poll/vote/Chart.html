<figure
        id="chart"
        class:leftFigure="!$verticalLayout"
        class:topFigure="$verticalLayout"
>
    <table
            class="chart-contents"
    >
        <tr id="plus">
            <td>
                <div
                        style="
        background-color: #{getColor(poll, 0)};
        height: {xPlusHeight}px;
            "
                >
                </div>
            </td>
            <td>
                <div
                        style="
        background-color: #{getColor(poll, 1)};
        height: {yPlusHeight}px;
            "
                >
                </div>
            </td>
            <td>
                <div
                        style="
        background-color: #{getColor(poll, 2)};
        height: {zPlusHeight}px;
            "
                >
                </div>
            </td>
        </tr>
        <tr id="minus">
            <td
            >
                <div
                        style="
        background-color: #{getColor(poll, 0)};
        height: {xMinusHeight}px;
            "
                >
                </div>
            </td>
            <td
            >
                <div
                        style="
        background-color: #{getColor(poll, 1)};
        height: {yMinusHeight}px;
            "
                >
                </div>
            </td>
            <td
            >
                <div
                        style="
        background-color: #{getColor(poll, 2)};
        height: {zMinusHeight}px;
            "
                >
                </div>
            </td>
        </tr>
    </table>
</figure>
<table
        class="info"
        class:bottomInfo="$verticalLayout"
        class:rightInfo="!$verticalLayout"
>
    <tr>
        <td>
            <DimensionInfoButton
                delta="{toggleDelta}"
                dimension="{getDimension(poll, 0)}"
                displayValue="{getDisplayValue(poll, 0)}"
                index=0
                on:toggle="toggleSurface('x')"
            ></DimensionInfoButton>
        </td>
        <td
            class="directionText"
        >
            {xText}
        </td>
    <tr>
    </tr>
        <td>
            <DimensionInfoButton
                delta="{toggleDelta}"
                dimension="{getDimension(poll, 1)}"
                displayValue="{getDisplayValue(poll, 1)}"
                index=1
                on:toggle="toggleSurface('y')"
            ></DimensionInfoButton>
        </td>
        <td
            class="directionText"
        >
            {yText}
        </td>
    <tr>
        <td>
            <DimensionInfoButton
                delta="{toggleDelta}"
                dimension="{getDimension(poll, 2)}"
                displayValue="{getDisplayValue(poll, 2)}"
                index=2
                on:toggle="toggleSurface('z')"
            ></DimensionInfoButton>
        </td>
        <td
            class="directionText"
        >
            {zText}
        </td>
    </tr>
</table>

<style>

    figure {
        position: fixed;
        width: 100%;
    }

    .directionText {
        font-size: calc(1.8vw + 1.8vh);
    }

    .leftFigure {
        left: 5px;
        top: 45px;
        width: calc(40% - 10px)
    }

    .topFigure {
        top: 28px;
    }

    .chart-contents {
        width: 100%;
    }

    .info {
        position: fixed;
    }

    .bottomInfo {
        bottom: 5px;
        width: 100%;

    }

    .rightInfo {
        right: 5px;
        top: 45px;
        width: calc(60% - 10px);
    }

    td {
        padding: 5px;
        vertical-align: middle;
    }

    #plus td {
        border-bottom: 1px solid black;
        vertical-align: bottom;
    }

    #minus td {
        vertical-align: top;
    }

    figure {
        margin: 0.8em;
    }

    figure div {
        margin: 10px;
    }

    #plus div {
        margin-bottom: 0px;
    }

    #minus div {
        margin-top: 0px;
    }

</style>

<script>
import DimensionInfoButton from '../../../common/control/button/DimensionInfoButton.html'
import {getColor, getDimension, getDisplayValue, getSideText} from '../../../helpers/cube';
import {loadCubeLogic, shutDownCubeListener} from '../../../libs/cubeLogic'
import {pollDao} from '../../../dao/poll';
import {scheduleToResize, setResizeCllBck} from '../../../resizer'
import store from '../../../store'

export default {
    components: {
        DimensionInfoButton
    },
    computed: {
        xMinusHeight: ({maxBarSize, maxValue, poll, toggleDelta}) => barHeight(poll, 0, -1, maxBarSize, maxValue),
        xPlusHeight: ({maxBarSize, maxValue, poll, toggleDelta}) => barHeight(poll, 0, 1, maxBarSize, maxValue),
        xText: ({poll, toggleDelta}) => directionText(poll, 0),
        yMinusHeight: ({maxBarSize, maxValue, poll, toggleDelta}) => barHeight(poll, 1, -1, maxBarSize, maxValue),
        yPlusHeight: ({maxBarSize, maxValue, poll, toggleDelta}) => barHeight(poll, 1, 1, maxBarSize, maxValue),
        yText: ({poll, toggleDelta}) => directionText(poll, 1),
        zMinusHeight: ({maxBarSize, maxValue, poll, toggleDelta}) => barHeight(poll, 2, -1, maxBarSize, maxValue),
        zPlusHeight: ({maxBarSize, maxValue, poll, toggleDelta}) => barHeight(poll, 2, 1, maxBarSize, maxValue),
        zText: ({poll, toggleDelta}) => directionText(poll, 2),
        maxValue: ({poll, toggleDelta}) => {
            if(!poll) {
                return 0
            }

            const positiveValues = []
            const negativeValues = []

            addToVals(poll, 0, positiveValues, negativeValues)
            addToVals(poll, 1, positiveValues, negativeValues)
            addToVals(poll, 2, positiveValues, negativeValues)

            const maxPositiveValue = getMaxVal(positiveValues)
            const maxNegativeValue = getMaxVal(negativeValues)

            return maxPositiveValue + maxNegativeValue
        }
    },
    data() {
        return {
            dimension: null,
            toggleDelta: 0
        }
    },
	helpers: {
		getColor,
		getDimension,
		getDisplayValue
	},
    methods: {
        handleResize(
            event
        ) {
            scheduleToResize(this)
        },
        toggleSurface(
            dimension
        ) {
            this.get().mutationApi.toggleSurface(dimension)
            this.set({toggleDelta: this.get().toggleDelta + 1})
        }
    },
    oncreate() {
        setResizeCllBck((
            portalHeight,
            windowWidth,
            verticalLayout
        ) => {
            let maxBarSize = portalHeight - 60;

            if (verticalLayout) {
                maxBarSize = portalHeight / 2 - 20;
            }

            this.set({maxBarSize});
        }, this.store)
        loadCubeLogic(this)

        const pollId = this.store.get().routeParams.pollId
        Promise.all([
            loadCubeLogic(this),
            pollDao.findByIdWithDetails(pollId)
        ]).then(([
            setPositionDataAndMove,
            poll
        ]) => {
            this.set({poll})
            // TODO: add support for vote values
            setPositionDataAndMove(poll.displayValues)
        })
        this.store.set({noOverflow: true})
    },
    ondestroy() {
        shutDownCubeListener(this.get().cubeListener, this)
        setResizeCllBck(null)
        this.store.set({noOverflow: false})
    },
    store: () => store
}

function barHeight(
    poll,
    pollDimensionIndex,
    direction,
    maxBarSize,
    maxValue
) {
    const displayValue = getDisplayValue(poll, pollDimensionIndex)
    return displayValue
    && displayValue.dir === direction
        ? displayValue.value * maxBarSize / (maxValue * 1.2)
        : 0
}

function directionText(
    poll,
    pollDimensionIndex
) {
    const displayValue = getDisplayValue(poll, pollDimensionIndex)
    return displayValue
        ? getSideText(poll, pollDimensionIndex, displayValue.dir)
        : ''
}

function addToVals(
    poll,
    pollDimensionIndex,
    positiveValues,
    negativeValues
) {
    const displayValue = getDisplayValue(poll, pollDimensionIndex)
    if (displayValue.dir === 1) {
        positiveValues.push(displayValue.value);
    } else {
        negativeValues.push(displayValue.value);
    }
}

function getMaxVal(
    values
) {
    let maximumValue = 0

    for (const value of values) {
        if (value > maximumValue) {
            maximumValue = value
        }
    }

    return maximumValue
}

</script>
