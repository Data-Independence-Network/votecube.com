{#if vote}
<figure
        id="chart"
        class:leftFigure="!$verticalLayout"
        class:topFigure="$verticalLayout"
>
    <table
            class="chart-contents"
    >
        <tr id="plus">
            <td>
                <div
                        style="
        background-color: #{getColor(poll, 'x')};
        height: {xPlusHeight(maxBarSize, maxValue, delta, vote)}px;
            "
                >
                </div>
            </td>
            <td>
                <div
                        style="
        background-color: #{getColor(poll, 'y')};
        height: {yPlusHeight(maxBarSize, maxValue, delta, vote)}px;
            "
                >
                </div>
            </td>
            <td>
                <div
                        style="
        background-color: #{getColor(poll, 'z')};
        height: {zPlusHeight(maxBarSize, maxValue, delta, vote)}px;
            "
                >
                </div>
            </td>
        </tr>
        <tr id="minus">
            <td
            >
                <div
                        style="
        background-color: #{getColor(poll, 'x')};
        height: {xMinusHeight(maxBarSize, maxValue, delta, vote)}px;
            "
                >
                </div>
            </td>
            <td
            >
                <div
                        style="
        background-color: #{getColor(poll, 'y')};
        height: {yMinusHeight(maxBarSize, maxValue, delta, vote)}px;
            "
                >
                </div>
            </td>
            <td
            >
                <div
                        style="
        background-color: #{getColor(poll, 'z')};
        height: {zMinusHeight(maxBarSize, maxValue, delta, vote)}px;
            "
                >
                </div>
            </td>
        </tr>
    </table>
</figure>
<table
        class="info"
        class:bottomInfo="$verticalLayout"
        class:rightInfo="!$verticalLayout"
>
    <tr>
        <td>
            <DimensionInfoButton
                delta="{delta}"
                dimension="{getDimension(poll, 'x')}"
                axis='x'
                on:toggle="toggleSurface('x')"
                voteDim="{vote.x}"
            ></DimensionInfoButton>
        </td>
        <td
            class="directionText"
        >
            {xText(poll, delta, vote)}
        </td>
    <tr>
    </tr>
        <td>
            <DimensionInfoButton
                delta="{delta}"
                dimension="{getDimension(poll, 'y')}"
                axis='y'
                on:toggle="toggleSurface('y')"
                voteDim="{vote.y}"
            ></DimensionInfoButton>
        </td>
        <td
            class="directionText"
        >
            {yText(poll, delta, vote)}
        </td>
    <tr>
        <td>
            <DimensionInfoButton
                delta="{delta}"
                dimension="{getDimension(poll, 'z')}"
                axis='z'
                on:toggle="toggleSurface('z')"
                voteDim="{vote.z}"
            ></DimensionInfoButton>
        </td>
        <td
            class="directionText"
        >
            {zText(poll, delta, vote)}
        </td>
    </tr>
</table>
{/if}

<style>

    figure {
        position: fixed;
        width: 100%;
    }

    .directionText {
        font-size: calc(1.8vw + 1.8vh);
    }

    .leftFigure {
        left: 5px;
        top: 45px;
        width: calc(40% - 10px)
    }

    .topFigure {
        top: 28px;
    }

    .chart-contents {
        width: 100%;
    }

    .info {
        position: fixed;
    }

    .bottomInfo {
        bottom: 5px;
        width: 100%;

    }

    .rightInfo {
        right: 5px;
        top: 45px;
        width: calc(60% - 10px);
    }

    td {
        padding: 5px;
        vertical-align: middle;
    }

    #plus td {
        border-bottom: 1px solid black;
        vertical-align: bottom;
    }

    #minus td {
        vertical-align: top;
    }

    figure {
        margin: 0.8em;
    }

    figure div {
        margin: 10px;
    }

    #plus div {
        margin-bottom: 0px;
    }

    #minus div {
        margin-top: 0px;
    }

</style>

<script>
import DimensionInfoButton from '../../../common/control/button/DimensionInfoButton.html'
import {getColor, getDimension, getSideText} from '../../../helpers/cube';
import {loadCubeLogic, shutDownCubeListener} from '../../../libs/cubeLogic'
import {voteDao} from '../../../dao/vote';
import {scheduleToResize, setResizeCllBck} from '../../../resizer'
import store from '../../../store'

export default {
    components: {
        DimensionInfoButton
    },
    computed: {
        maxValue: ({poll, delta, vote}) => {
            if(!vote) {
                return 0
            }

            const positiveValues = []
            const negativeValues = []

            addToVals(poll, vote.x, positiveValues, negativeValues)
            addToVals(poll, vote.y, positiveValues, negativeValues)
            addToVals(poll, vote.z, positiveValues, negativeValues)

            const maxPositiveValue = getMaxVal(positiveValues)
            const maxNegativeValue = getMaxVal(negativeValues)

            return maxPositiveValue + maxNegativeValue
        }
    },
    data() {
        return {
            dimension: null,
            delta: 0
        }
    },
	helpers: {
		getColor,
		getDimension,
		xMinusHeight: (maxBarSize, maxValue, delta, vote) => barHeight(vote.x, -1, maxBarSize, maxValue),
        xPlusHeight: (maxBarSize, maxValue, delta, vote) => barHeight(vote.x, 1, maxBarSize, maxValue),
        xText: (poll, delta, vote) => directionText(poll, vote.x),
        yMinusHeight: (maxBarSize, maxValue, delta, vote) => barHeight(vote.y, -1, maxBarSize, maxValue),
        yPlusHeight: (maxBarSize, maxValue, delta, vote) => barHeight(vote.y, 1, maxBarSize, maxValue),
        yText: (poll, delta, vote) => directionText(poll, vote.y),
        zMinusHeight: (maxBarSize, maxValue, delta, vote) => barHeight(vote.z, -1, maxBarSize, maxValue),
        zPlusHeight: (maxBarSize, maxValue, delta, vote) => barHeight(vote.z, 1, maxBarSize, maxValue),
        zText: (poll, delta, vote) => directionText(poll, vote.z)
	},
    methods: {
        handleResize(
            event
        ) {
            scheduleToResize(this)
        },
        toggleSurface(
            dimension
        ) {
            this.get().mutationApi.toggleSurface(dimension)
            this.set({delta: this.get().delta + 1})
        }
    },
    oncreate() {
        setResizeCllBck((
            portalHeight,
            windowWidth,
            verticalLayout
        ) => {
            let maxBarSize = portalHeight - 60;

            if (verticalLayout) {
                maxBarSize = portalHeight / 2 - 20;
            }

            this.set({maxBarSize});
        }, this.store)

        const pollId = this.store.get().routeParams.pollId
        Promise.all([
            loadCubeLogic(this, (vote) => {
                this.set({delta: this.get().delta + 1})
            }),
            voteDao.findMyVoteForPoll(pollId)
        ]).then(([
            setPositionDataAndMove,
            vote
        ]) => {
            const poll = vote.poll
            this.set({poll, vote})
            setPositionDataAndMove(vote)
        })
        this.store.set({noOverflow: true})
    },
    ondestroy() {
        shutDownCubeListener(this.get().cubeListener, this)
        setResizeCllBck(null)
        this.store.set({noOverflow: false})
    },
    store: () => store
}

function barHeight(
    voteDimension,
    direction,
    maxBarSize,
    maxValue
) {
    return voteDimension
    && voteDimension.dir === direction
        ? voteDimension.value * maxBarSize / (maxValue * 1.2)
        : 0
}

function directionText(
    poll,
    voteDimension
) {
    return getSideText(poll, voteDimension.axis, voteDimension.dir)
}

function addToVals(
    poll,
    voteDimension,
    positiveValues,
    negativeValues
) {
    if (voteDimension.dir === 1) {
        positiveValues.push(voteDimension.value);
    } else {
        negativeValues.push(voteDimension.value);
    }
}

function getMaxVal(
    values
) {
    let maximumValue = 0

    for (const value of values) {
        if (value > maximumValue) {
            maximumValue = value
        }
    }

    return maximumValue
}

</script>
