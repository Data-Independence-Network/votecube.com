<svelte:window on:resize="handleResize(event)"/>
<figure
        id="chart"
        class:leftFigure="!verticalLayout"
        class:topFigure="verticalLayout"
>
    <!--
        style="
transform: scale({zoomFactor}, {zoomFactor});
"
-->
    <table
        class="chart-contents"
    >
        <tr id="plus">
            <td>
                <!--
                    class:selectedPlus="dimension === 'x'"
                    on:click="pick('x')"
                -->
                <div
                        style="
        background-color: #{$currentValue.x.color};
        height: {xPlusHeight}px;
            "
                >
                </div>
            </td>
            <td>
                <!--
                    class:selectedPlus="dimension === 'y'"
                    on:click="pick('y')"
                -->
                <div
                        style="
        background-color: #{$currentValue.y.color};
        height: {yPlusHeight}px;
            "
                >
                </div>
            </td>
            <td>
                <!--
                    class:selectedPlus="dimension === 'z'"
                    on:click="pick('z')"
                -->
                <div
                        style="
        background-color: #{$currentValue.z.color};
        height: {zPlusHeight}px;
            "
                >
                </div>
            </td>
        </tr>
        <tr id="minus">
            <td
            >
                <!--
                    class:selectedMinus="dimension === 'x'"
                    on:click="pick('x')"
                -->
                <div
                        style="
        background-color: #{$currentValue.x.color};
        height: {xMinusHeight}px;
            "
                >
                </div>
            </td>
            <td
            >
                <!--
                    class:selectedMinus="dimension === 'y'"
                    on:click="pick('y')"
                -->
                <div
                        style="
        background-color: #{$currentValue.y.color};
        height: {yMinusHeight}px;
            "
                >
                </div>
            </td>
            <td
            >
                <!--
                    class:selectedMinus="dimension === 'z'"
                    on:click="pick('z')"
                -->
                <div
                        style="
        background-color: #{$currentValue.z.color};
        height: {zMinusHeight}px;
            "
                >
                </div>
            </td>
        </tr>
    </table>
</figure>
<table
        class="info"
        class:bottomInfo="verticalLayout"
        class:rightInfo="!verticalLayout"
>
    <tr>
        <td>
            <DimensionInfoIcon
                    dimension="{$currentValue.x}"
                    index=0
                    on:toggle="toggleSurface('x')"
                    verticalLayout
            ></DimensionInfoIcon>
        </td>
        <td
                style="
                    font-size: calc(2vw + 2vh);
                "
        >
            {xText}
        </td>
    <tr>
    </tr>
    <td>
        <DimensionInfoIcon
                index=1
                dimension="{$currentValue.y}"
                on:toggle="toggleSurface('y')"
                verticalLayout
        ></DimensionInfoIcon>
    </td>
    <td
            style="
                    font-size: calc(2vw + 2vh);
                "
    >
        {yText}
    </td>
    <tr>
        <td>
            <DimensionInfoIcon
                    dimension="{$currentValue.z}"
                    on:toggle="toggleSurface('z')"
                    verticalLayout
            ></DimensionInfoIcon>
        </td>
        <td
                style="
                    font-size: calc(2vw + 2vh);
                "
        >
            {zText}
        </td>
    </tr>
</table>

<style>

    /*
    dim-info-col {
        width: 60px;
    }
    */

    figure {
        position: fixed;
        width: 100%;
    }

    .leftFigure {
        left: 5px;
        width: calc(40% - 10px)
    }

    .topFigure {
        top: 28px;
    }

    .chart-contents {
        width: 100%;
    }

    /*
    section {
        margin: 15px;
        font-size: 1.5em;
    }
    */

    .info {
        position: fixed;
    }

    .bottomInfo {
        bottom: 5px;
        width: 100%;

    }

    .rightInfo {
        right: 5px;
        width: calc(60% - 10px);
    }

    td {
        padding: 5px;
        vertical-align: middle;
    }

    #plus td {
        border-bottom: 1px solid black;
        vertical-align: bottom;
    }

    #minus td {
        vertical-align: top;
    }

    figure {
        margin: 0.8em;
    }

    figure div {
        margin: 10px;
    }

    #plus div {
        margin-bottom: 0px;
    }

    #minus div {
        margin-top: 0px;
    }
/*
    .selectedPlus {
        border: 1px dashed;
        border-bottom: 1px solid;
    }

    .selectedMinus {
        border: 1px dashed;
        border-top: 0px;
    }
*/
</style>

<script>
    import DimensionInfoIcon from '../../common/control/DimensionInfoIcon.html'
    import {setupCubeListener, shutDownCubeListener} from '../../cubeListener.js'
    import store from '../../store.js'
    import {scheduleToResize} from '../../resizer.js'

    export default {
        components: {
            DimensionInfoIcon
        },
        computed: {
            pickedText: ({$currentValue, dimension, $text}) => {
                if (!dimension) {
                    return ''
                }
                let plusIndex = 0, minusIndex = 5
                if (dimension === 'y') {
                    plusIndex = 1
                    minusIndex = 3
                } else if (dimension === 'z') {
                    plusIndex = 2
                    minusIndex = 4
                }
                return $currentValue[dimension].dir === 1
                    ? $text[plusIndex]
                    : $text[minusIndex]
            },
            xMinusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.x, -1, maxBarSize, maxValue),
            xPlusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.x, 1, maxBarSize, maxValue),
            xText: ({$currentValue, $text}) => $currentValue.x.dir === 1 ? $text[0] : $text[5],
            yMinusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.y, -1, maxBarSize, maxValue),
            yPlusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.y, 1, maxBarSize, maxValue),
            yText: ({$currentValue, $text}) => $currentValue.y.dir === 1 ? $text[1] : $text[3],
            zMinusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.z, -1, maxBarSize, maxValue),
            zPlusHeight: ({$currentValue, maxBarSize, maxValue}) => barHeight($currentValue.z, 1, maxBarSize, maxValue),
            zText: ({$currentValue, $text}) => $currentValue.z.dir === 1 ? $text[2] : $text[4],
            maxValue: ({$currentValue}) => {
                const posValues = []
                const x = $currentValue.x.value
                const y = $currentValue.y.value
                const z = $currentValue.z.value
                if (x > y) {
                    if (x > y) {
                        return x
                    }
                    return z
                } else {
                    if (y > z) {
                        return y
                    }
                    return z
                }
            },
            // fontSize: ({maxBarSize, maxValue, portalHeight, windowWidth}) => {
            //     return (maxBarSize / (maxValue * 1.2)) * portalHeight * 0.005 * windowWidth * 0.005;
            // }
        },
        data() {
            return {
                // currentZoom: 1,
                dimension: null,
                // zoomFactor: 0.9,
            }
        },
        methods: {
            handleResize(
                event
            ) {
                scheduleToResize(this)
            },
            // zoomChange(event) {
            //     let currentZoom = parseInt(event.target.value)
            //     let zoomFactor
            //     switch (currentZoom) {
            //         case 0:
            //             zoomFactor = 0.8
            //             break;
            //         case 1:
            //             zoomFactor = 0.9
            //             break;
            //         case 2:
            //             zoomFactor = 1
            //             break
            //     }
            //     this.set({currentZoom, zoomFactor})
            //     this.get().mutationApi.changeZoom(currentZoom)
            // },
            // move(
            //     dimension,
            //     direction
            // ) {
            //     this.pick(dimension)
            //     this.get().mutationApi.move(dimension, direction)
            // },
            // moveToValue(
            //     dimension,
            //     value
            // ) {
            //     this.pick(dimension)
            //     this.get().mutationApi.moveToValue(dimension, value)
            // },
            toggleSurface(
                dimension
            ) {
                this.get().mutationApi.toggleSurface(dimension)
            },
            // pick(
            //     dimension
            // ) {
            //     this.set({dimension})
            // }
        },
        oncreate() {
            setupCubeListener(this, (
                portalHeight,
                windowWidth
            ) => {
                const maxBarSize = portalHeight / 2 - 20;

                this.set({maxBarSize});
            })
        },
        ondestroy() {
            shutDownCubeListener(this.get().cubeListener, this)
        },
        store: () => store
    }

    function barHeight(
        dimensionPositionData,
        direction,
        maxBarSize,
        maxValue
    ) {
        return dimensionPositionData.dir === direction
            ? dimensionPositionData.value * maxBarSize / (maxValue * 1.2)
            : 0
    }

</script>
