<svelte:window on:resize="handleResize(event)"/>
<div>
    <section
            id="viewport"
            style="
  height: {vpHeight}px;
  margin-left: -{marginLeft}px;
  margin-top: -{marginTop}px;
  transform: scale({zoomFactor}, {zoomFactor});
"
    >
    <!--
        transform: scale(0.45, 0.45);
        height: 400px;
        margin-top: -125px;
        margin-left: -20px;
        -->
        <figure
                id="cube"
        >
            <div
                class="surface"
                id="s1"
            >
                {$text[0]}
            </div>
            <div
                class="surface"
                id="s2"
            >
                {$text[1]}
            </div>
            <div
                class="surface"
                id="s3"
            >
                {$text[2]}
            </div>
            <div
                class="surface"
                id="s4"
            >
                {$text[3]}
            </div>
            <div
                class="surface"
                id="s5"
            >
                {$text[4]}
            </div>
            <div
                class="surface"
                id="s6"
            >
                {$text[5]}
            </div>
        </figure>
    </section>
    <nav
            style="
      margin-top: -25px;
      "
    >
        <ZoomPicker
            currentZoom="{currentZoom}"
            on:zoomChange="zoomChange(event)"
        />
        <table
                style="
                width: 100%;
                font-size: 3em;
                text-align: center;
            ">
<!--
            <tr>
                <td>
                    -
                </td>
                <td>
                    %
                </td>
                <td>
                    +
                </td>
            </tr>
            -->
            <LinearPositionPicker
                dimension="{$currentValue.x}"
                on:move="move('x', event)"
                on:moveToValue="moveToValue('x', event)"
            />
            <LinearPositionPicker
                dimension="{$currentValue.y}"
                on:move="move('y', event)"
                on:moveToValue="moveToValue('y', event)"
            />
            <LinearPositionPicker
                dimension="{$currentValue.z}"
                on:move="move('z', event)"
                on:moveToValue="moveToValue('z', event)"
            />
        </table>
    </nav>
</div>

<script>
    import LinearPositionPicker from '../../common/control/LinearPositionPicker.html'
    import ZoomPicker from '../../common/control/ZoomPicker.html'
	import store from '../../store.js';
    import {scheduleToResize, startResizeInterval, stopResizeInterval} from '../../resizer.js'

    export default {
        components: {
            LinearPositionPicker,
            ZoomPicker
        },
        data() {
            return {
                currentZoom: 1,
                zoomFactor: 0.65
            }
        },
        methods: {
            handleResize(event) {
                scheduleToResize(this)
            },
            move(
                dimension,
                direction
            ) {
                this.get().mutationApi.move(dimension, direction)
            },
            moveToValue(
                dimension,
                value
            ) {
                this.get().mutationApi.moveToValue(dimension, value)
            },
            zoomChange(event) {
                let currentZoom = parseInt(event.target.value)
                let zoomBase = this.get().zoomBase
                let zoomFactor
                switch (currentZoom) {
                    case 0:
                        zoomFactor = zoomBase * 0.8
                        break;
                    case 1:
                        zoomFactor = zoomBase * 0.9
                        break;
                    case 2:
                        zoomFactor = zoomBase
                        break
                }
                this.set({currentZoom, zoomFactor})
                this.get().mutationApi.changeZoom(currentZoom)
            }
        },
        oncreate() {
            import('@votecube/cube-logic/lib/cube/eventListener').then((
                eventListener
            ) => {
            this.setCubeViewPort = (
                data,
                setMutationApi,
                callback
            ) => {
                setMutationApi(eventListener.setViewPort(
                    true, data, callback))
            }
            this.setCubeViewPort(
                this.store.get().currentValue,
                (
                    mutationApi
                ) => {
                    this.set({mutationApi})
                },
                (
                    currentValue
                ) => {
                    this.store.set({currentValue})
                },
            )
            })

            this.resize = (
                portalHeight,
                windowWidth,
                inPortrait
            ) => {
                console.log(`height: ${portalHeight}, width: ${windowWidth}, inPortrait: ${inPortrait}`);

                const cubeAreaHeight = portalHeight * 0.55 + 95



                // margin-left: 0px
                // zoomFactor: .55

                const cubeAreaLeastDimension = windowWidth < cubeAreaHeight
                    ? windowWidth
                    : cubeAreaHeight

                // transform: scale(W, W)
                const zoomBase = (Math.sqrt(cubeAreaLeastDimension) * 2.5) / 100
                const zoomFactor = zoomBase * 0.9

                // height: Xpx
                const vpHeight = cubeAreaHeight

                // margin-top: Ypx
                let marginTop = 0
                if(cubeAreaHeight < 500) {
                    marginTop = (500 - cubeAreaHeight) / 1.1
                }

                // margin-left: Zpx
                let marginLeft = 0
                if(windowWidth < 400) {
                    marginLeft = (400 - windowWidth) / 4
                }

                this.set({marginLeft, marginTop, vpHeight, zoomBase, zoomFactor})

            }

            startResizeInterval(this)
        },
        ondestroy() {
            console.log('in CubeVote ondestroy');
            stopResizeInterval(this)
            this.setCubeViewPort(
                null,
                (
                    mutationApi
                ) => {
                    this.set({mutationApi})
                }
            )
        },
        store: () => store
    }

</script>
