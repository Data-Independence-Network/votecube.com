<svelte:window on:resize="handleResize(event)"/>
<div>
    <section
            id="viewport"
            style="
  transform: scale({zoomFactor}, {zoomFactor});
"
    >
    <!--
        transform: scale(0.45, 0.45);
        height: 400px;
        margin-top: -125px;
        margin-left: -20px;
        -->
        <figure
                id="cube"
        >
            <div
                class="surface"
                id="s1"
                style="
            background-color: #{$currentValue.x.color};
                "
            >
                {$text[0]}
            </div>
            <div
                class="surface"
                id="s2"
                style="
            background-color: #{$currentValue.y.color};
                "
            >
                {$text[1]}
            </div>
            <div
                class="surface"
                id="s3"
                style="
            background-color: #{$currentValue.z.color};
                "
            >
                {$text[2]}
            </div>
            <div
                class="surface"
                id="s4"
                style="
            background-color: #{$currentValue.y.color};
                "
            >
                {$text[3]}
            </div>
            <div
                class="surface"
                id="s5"
                style="
            background-color: #{$currentValue.z.color};
                "
            >
                {$text[4]}
            </div>
            <div
                class="surface"
                id="s6"
                style="
            background-color: #{$currentValue.x.color};
                "
            >
                {$text[5]}
            </div>
        </figure>
    </section>
    {#if percentMode}
    <PercentPicker
        on:close="togglePercentPicker()"
        on:move="move(event)"
        on:moveToValue="moveToValue(event)"
    ></PercentPicker>
    {:else}
    <a
        class="app-button bottom-left"
        on:click="togglePercentPicker()"
    >
        %
    </a>
    <table>
    <tr>
        <td
        >
            <DimensionInfoIcon
                index=0
                dimension="{$currentValue.x}"
            ></DimensionInfoIcon>
        </td>
        <td
        >
            <DimensionInfoIcon
                index=1
                dimension="{$currentValue.y}"
            ></DimensionInfoIcon>
        </td>
        <td>
            <DimensionInfoIcon
                dimension="{$currentValue.z}"
            ></DimensionInfoIcon>
        </td>
    </tr>
    </table>
    <VoteButton
        classes="bottom-right"
    ></VoteButton>
    {/if}
</div>

<style>
    table {
        bottom: 10px;
        color: black;
        margin-left: 70px;
        margin-right: 70px;
        position: fixed;
        width: calc(100% - 140px);
    }

    #viewport {
        perspective: 1100px;
        perspective-origin: 50% 251px;
        transform: scale(0.75,0.75);
    }

    #cube {
        position: relative;
        margin: auto;
        height: 320px;
        width: 320px;
        transition: transform 128ms linear;
        transform-style: preserve-3d;
        /*transform: rotateX(0deg) rotateY(-90deg);*/
    }

    #cube h2 {
        color: #fff;
        padding-top: 0;

        margin-top: 0;
    }

    #cube a {
        color: #fff;
    }

    #cube > div {
        position: absolute;
        height: 300px;
        width: 300px;
        padding: 10px;
        font-size: 1.7em;
        line-height: 1.7em;
        color: #000;
        border-radius: 10px;
        border: 5px groove gray;
    }

    #s1  {
        /*background: hsla(  0, 100%, 50%, 0.95);*/
        transform: rotateX(90deg) translateZ(160px);
    }

    #s2 {
        transform: translateZ(160px);
    }

    #s3 {
        transform: rotateY(90deg) translateZ(160px);
    }

    #s4 {
        transform: rotateY(180deg) translateZ(160px);
    }

    #s5 {
        transform: rotateY(-90deg) translateZ(160px);
    }

    #s6 {
        transform: rotateX(-90deg) rotate(180deg) translateZ(160px);
    }
</style>

<script>
    import PercentPicker from '../../common/control/PercentPicker.html'
    import VoteButton from '../../common/control/VoteButton.html'
    import DimensionInfoIcon from '../../common/control/DimensionInfoIcon.html'
	import store from '../../store.js';
    import {scheduleToResize, startResizeInterval, stopResizeInterval} from '../../resizer.js'

    export default {
        components: {
            DimensionInfoIcon,
            PercentPicker,
            VoteButton
        },
        data() {
            return {
                percentMode: false,
                currentZoom: 1,
                zoomFactor: 0.65
            }
        },
        methods: {
            getDimBorderColor(
                dimensionPositionData,
                direction
            ) {
                if(dimensionPositionData.dir === direction) {
                    return '000000'
                }
                return dimensionPositionData.color
            },
            handleResize(event) {
                scheduleToResize(this)
            },
            move(
                event
            ) {
                this.get().mutationApi.move(event.dimension, event.direction)
            },
            moveToValue(
                event
            ) {
                this.get().mutationApi.moveToValue(event.dimension, event.value)
            },
            togglePercentPicker() {
                const percentMode = !this.get().percentMode
                this.setCubeAdjustment(!percentMode)
                this.set({percentMode})
            },
            zoomChange(event) {
                let currentZoom = parseInt(event.target.value)
                let zoomBase = this.get().zoomBase
                let zoomFactor
                switch (currentZoom) {
                    case 0:
                        zoomFactor = zoomBase * 0.8
                        break;
                    case 1:
                        zoomFactor = zoomBase * 0.9
                        break;
                    case 2:
                        zoomFactor = zoomBase
                        break
                }
                this.set({currentZoom, zoomFactor})
                this.get().mutationApi.changeZoom(currentZoom)
            }
        },
        oncreate() {
            import('@votecube/cube-logic/lib/cube/eventListener').then((
                eventListener
            ) => {
            this.setCubeViewPort = (
                data,
                setMutationApi,
                callback
            ) => {
                setMutationApi(eventListener.setViewPort(
                    true, data, callback))
            }

            this.setCubeAdjustment =(
                enableCubeAdjustment
            ) => {
                if(enableCubeAdjustment) {
                    eventListener.addCubeAdjustment()
                } else {
                    eventListener.clearCubeAdjustment()
                }
            }

            this.setCubeViewPort(
                this.store.get().currentValue,
                (
                    mutationApi
                ) => {
                    this.set({mutationApi})
                },
                (
                    currentValue
                ) => {
                    this.store.set({currentValue})
                },
            )
            })

            this.resize = (
                portalHeight,
                windowWidth,
                inPortrait
            ) => {
                console.log(`height: ${portalHeight}, width: ${windowWidth}, inPortrait: ${inPortrait}`);

                const cubeAreaHeight = portalHeight * 0.55 + 95



                // margin-left: 0px
                // zoomFactor: .55

                const cubeAreaLeastDimension = windowWidth < cubeAreaHeight
                    ? windowWidth
                    : cubeAreaHeight

                // transform: scale(W, W)
                const zoomBase = (Math.sqrt(cubeAreaLeastDimension) * 3) / 100
                const zoomFactor = zoomBase * 1

                // height: Xpx
                const vpHeight = cubeAreaHeight

                // margin-top: Ypx
                let marginTop = 0
                if(cubeAreaHeight < 500) {
                    marginTop = (500 - cubeAreaHeight) / 1.1
                }

                // margin-left: Zpx
                let marginLeft = 0
                if(windowWidth < 400) {
                    marginLeft = (400 - windowWidth) / 4
                }

                this.set({marginLeft, marginTop, vpHeight, zoomBase, zoomFactor})

            }

            startResizeInterval(this)
        },
        ondestroy() {
            console.log('in CubeVote ondestroy');
            stopResizeInterval(this)
            this.setCubeViewPort(
                null,
                (
                    mutationApi
                ) => {
                    this.set({mutationApi})
                }
            )
        },
        store: () => store
    }

</script>
